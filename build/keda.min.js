!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("THREE")):"function"==typeof define&&define.amd?define(["THREE"],e):"object"==typeof exports?exports.KEDA=e(require("THREE")):t.KEDA=e(t.THREE)}(self,(function(t){return(()=>{"use strict";var e={78:(t,e,n)=>{n.d(e,{default:()=>Ie});var r={};function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}n.r(r),n.d(r,{AdjustmentsPass:()=>Bt,BloomPass:()=>Wt,CSG:()=>P,Clock:()=>a,ColorShifter:()=>x,FullScreenGradient:()=>Ce,GPUComputer:()=>R,GPUTweener:()=>I,GaussianBlurPass:()=>ne,Gesture:()=>T,MethodList:()=>u,RadialBlurPass:()=>le,ReflectorPass:()=>me,Slicer:()=>ze,bayerMatrixDither:()=>f,capitalize:()=>Ee,detectMobile:()=>Le,ease:()=>d,exportPNG:()=>Ae,fitCameraToSelection:()=>xe,getElement:()=>l,linearGradient:()=>v,random:()=>Fe,setElementSize:()=>c,simplex3:()=>h,transforms:()=>m,vUv:()=>p});var a=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;o(this,t),this.fps=n,this.callback=e,this._time="undefined"==typeof performance?Date:performance,this._start=0,this._previous=0,this._elapsed=0,this._delta=0}var e,n;return e=t,(n=[{key:"start",value:function(){this._start=this.now,this._previous=this._start,this._elapsed=0,this._delta=0,this._raf=requestAnimationFrame(this.update.bind(this))}},{key:"stop",value:function(){cancelAnimationFrame(this._raf)}},{key:"update",value:function(){var t,e=this.now;t=e-this._previous,this._previous=e,this._elapsed+=t,this._delta+=t,this._delta>=this._frameDuration&&(this.callback.call(),this._delta=0),this._raf=requestAnimationFrame(this.update.bind(this))}},{key:"delta",get:function(){return this._delta>0&&this._delta<34?this._delta:16.67}},{key:"elapsed",get:function(){return this._elapsed}},{key:"fps",get:function(){return this._fps},set:function(t){this._fps=t,this._frameDuration=t>0?Math.floor(1e3/t):0}},{key:"now",get:function(){return this._time.now()}}])&&i(e.prototype,n),t}();function s(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}var u=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.methodName=e,this.items=[],this.enabled=!0,this[e]=this._apply}var e,n;return e=t,(n=[{key:"add",value:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];for(var r in e){var o=e[r];if(Array.isArray(o))for(var i in o)this._addItem(o[i]);else this._addItem(e[r])}return this}},{key:"remove",value:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];for(var r in e){var o=e[r];if(Array.isArray(o))for(var i in o)this._removeItem(o[i]);else this._removeItem(e[r])}return this}},{key:"_addItem",value:function(t){return"function"!=typeof t[this.methodName]?(console.warn("MethodList.add( item ) : parameter must be an object with the methodlist method."),this):this._contains(t)?(console.warn("MethodList.add( item ) : item was already added."),this):(this.items.push(t),this)}},{key:"_removeItem",value:function(t){for(var e=this.items,n=0,r=e.length;n<r;n++)if(e[n]===t)return e.splice(n,1),this;return console.warn("MethodList.remove( item ) : item not found."),this}},{key:"_contains",value:function(t){for(var e=this.items,n=0,r=e.length;n<r;n++)if(e[n]===t)return!0;return!1}},{key:"_apply",value:function(){if(!this.enabled)return this;for(var t=this.items,e=this.methodName,n=arguments.length,r=new Array(n),o=0;o<n;o++)r[o]=arguments[o];for(var i=0,a=t.length;i<a;i++){var s=t[i];s[e].apply(s,r)}return this}}])&&s(e.prototype,n),t}();function l(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:document.body,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"div",r=document.getElementById(t);return r||((r=document.createElement(n)).setAttribute("id",t),e.appendChild(r)),r}function c(t,e,n){t.setAttribute("width",e),t.setAttribute("height",n),t.style.width="".concat(e,"px"),t.style.height="".concat(n,"px")}var h="\n\n    // Simplex 3D Noise\n    // by Ian McEwan, Ashima Arts\n    // edited by Pierre Keda\n\n    vec4 permute(vec4 x){return mod(((x*34.0)+1.0)*x, 289.0);}\n    vec4 taylorInvSqrt(vec4 r){return 1.79284291400159 - 0.85373472095314 * r;}\n    \n    float simplex3( float px, float py, float pz ) {\n\n        vec3 v = vec3( px, py, pz );\n\n        const vec2  C = vec2(1.0/6.0, 1.0/3.0) ;\n        const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);\n\n        // First corner\n        vec3 i  = floor(v + dot(v, C.yyy) );\n        vec3 x0 = v - i + dot(i, C.xxx) ;\n\n        // Other corners\n        vec3 g = step(x0.yzx, x0.xyz);\n        vec3 l = 1.0 - g;\n        vec3 i1 = min( g.xyz, l.zxy );\n        vec3 i2 = max( g.xyz, l.zxy );\n\n        //  x0 = x0 - 0. + 0.0 * C \n        vec3 x1 = x0 - i1 + 1.0 * C.xxx;\n        vec3 x2 = x0 - i2 + 2.0 * C.xxx;\n        vec3 x3 = x0 - 1. + 3.0 * C.xxx;\n\n        // Permutations\n        i = mod(i, 289.0 ); \n        vec4 p = permute( permute( permute( \n                    i.z + vec4(0.0, i1.z, i2.z, 1.0 ))\n                + i.y + vec4(0.0, i1.y, i2.y, 1.0 )) \n                + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));\n\n        // Gradients\n        // ( N*N points uniformly over a square, mapped onto an octahedron.)\n        float n_ = 1.0/7.0; // N=7\n        vec3  ns = n_ * D.wyz - D.xzx;\n\n        vec4 j = p - 49.0 * floor(p * ns.z *ns.z);  //  mod(p,N*N)\n\n        vec4 x_ = floor(j * ns.z);\n        vec4 y_ = floor(j - 7.0 * x_ );    // mod(j,N)\n\n        vec4 x = x_ *ns.x + ns.yyyy;\n        vec4 y = y_ *ns.x + ns.yyyy;\n        vec4 h = 1.0 - abs(x) - abs(y);\n\n        vec4 b0 = vec4( x.xy, y.xy );\n        vec4 b1 = vec4( x.zw, y.zw );\n\n        vec4 s0 = floor(b0)*2.0 + 1.0;\n        vec4 s1 = floor(b1)*2.0 + 1.0;\n        vec4 sh = -step(h, vec4(0.0));\n\n        vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ;\n        vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ;\n\n        vec3 p0 = vec3(a0.xy,h.x);\n        vec3 p1 = vec3(a0.zw,h.y);\n        vec3 p2 = vec3(a1.xy,h.z);\n        vec3 p3 = vec3(a1.zw,h.w);\n\n        //Normalise gradients\n        vec4 norm = taylorInvSqrt(\n            vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3))\n        );\n        p0 *= norm.x;\n        p1 *= norm.y;\n        p2 *= norm.z;\n        p3 *= norm.w;\n\n        // Mix final noise value\n        vec4 m = max(0.6 - vec4(\n            dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)\n        ), 0.0);\n        m = m * m;\n        return 42.0 * dot( \n            m*m, vec4( dot(p0,x0), dot(p1,x1), dot(p2,x2), dot(p3,x3) )\n        );\n    \n    }\n\n",p="\n\n    varying vec2 vUv;\n\n    void main() {\n\n        vUv = uv;\n\n        gl_Position = vec4( position, 1.0 );\n\n    }\n\n",f="\n\n    vec3 bayerMatrixDither( vec3 color ) {\n\n        const float BAYER_MATRIX[ 64 ] = float[ 64 ](\n            0.0,  32.0,  8.0, 40.0,  2.0, 34.0, 10.0, 42.0,\n            48.0, 16.0, 56.0, 24.0, 50.0, 18.0, 58.0, 26.0,\n            12.0, 44.0,  4.0, 36.0, 14.0, 46.0,  6.0, 38.0,\n            60.0, 28.0, 52.0, 20.0, 62.0, 30.0, 54.0, 22.0,\n            3.0,  35.0, 11.0, 43.0,  1.0, 33.0,  9.0, 41.0,\n            51.0, 19.0, 59.0, 27.0, 49.0, 17.0, 57.0, 25.0,\n            15.0, 47.0,  7.0, 39.0, 13.0, 45.0,  5.0, 37.0,\n            63.0, 31.0, 55.0, 23.0, 61.0, 29.0, 53.0, 21.0\n        );\n\n        float dithering = ( BAYER_MATRIX[  \n            int( mod( gl_FragCoord.x - 0.5, 8.0 ) ) + \n            int( mod( gl_FragCoord.y - 0.5, 8.0 ) * 8.0 )\n        ] / 255.0 ) / 32.0 - ( 1.0 / 128.0 );\n\n        return color + dithering;\n\n    }\n\n",d={linear:"\n\n\tfloat linear( float t ) {\n\n\t\treturn t;\n\n\t}\n\n",quadInOut:"\n\n\tfloat quadInOut( float t ) {\n\n\t\treturn t < 0.5\n            ? pow( t * 2.0, 2.0 ) / 2.0\n            : 1.0 - pow( t * -2.0 + 2.0, 2.0 ) / 2.0;\n\n\t}\n\n",cubicInOut:"\n\n\tfloat cubicInOut( float t ) {\n\n\t\treturn t < 0.5\n            ? pow( t * 2.0, 3.0 ) / 2.0\n            : 1.0 - pow( t * -2.0 + 2.0, 3.0 ) / 2.0;\n\n\t}\n\n",quartInOut:"\n\n\tfloat quartInOut( float t ) {\n\n\t\treturn t < 0.5\n            ? pow( t * 2.0, 4.0 ) / 2.0\n            : 1.0 - pow( t * -2.0 + 2.0, 4.0 ) / 2.0;\n\n\t}\n\n",quintInOut:"\n\n\tfloat quintInOut( float t ) {\n\n\t\treturn t < 0.5\n            ? pow( t * 2.0, 5.0 ) / 2.0\n            : 1.0 - pow( t * -2.0 + 2.0, 5.0 ) / 2.0;\n\n\t}\n\n",circInOut:"\n\n\tfloat circInOut( float t ) {\n\n\t\treturn t < 0.5\n            ? ( 1.0 - sqrt( 1.0 - t * t * 4.0 ) ) / 2.0\n            : ( sqrt( ( 3.0 - 2.0 * t ) * ( 2.0 * t - 1.0 ) ) + 1.0 ) / 2.0;\n\n\t}\n\n",expoInOut:"\n\n\tfloat expoInOut( float t ) {\n\n\t\treturn t == 0.0 || t == 1.0\n            ? t\n            : t < 0.5\n            ? +0.5 * pow(2.0, (20.0 * t) - 10.0)\n            : -0.5 * pow(2.0, 10.0 - (t * 20.0)) + 1.0;\n\n\t}\n\n",sineInOut:"\n\n\t#ifndef PI\n\t#define PI 3.141592653589793\n\t#endif\n\n\tfloat sineInOut( float t ) {\n\n\t\treturn -0.5 * (cos(PI * t) - 1.0);\n\n\t}\n\n",backInOut:"\n\n\t#ifndef PI\n\t#define PI 3.141592653589793\n\t#endif\n\n\tfloat backInOut( float t ) {\n\n\t\tfloat f = t < 0.5\n            ? 2.0 * t\n            : 1.0 - ( 2.0 * t - 1.0 );\n\n        float g = pow( f, 3.0 ) - f * sin( f * PI );\n\n        return t < 0.5\n            ? 0.5 * g\n            : 0.5 * ( 1.0 - g ) + 0.5;\n\n\t}\n\n",circOut:"\n\n\tfloat circOut(float t) {\n\n\t\treturn sqrt( ( 2.0 - t ) * t );\n\n\t}\n\n",expoOut:"\n\n\tfloat expoOut(float t) {\n\n\t\treturn t == 1.0 ? t : 1.0 - pow( 2.0, -10.0 * t );\n\n  \t}\n  \n\n"},v="\n\n    vec3 linearGradient( vec2 origin, vec2 target, vec3 color1, vec3 color2, float angle ) {\n\n        angle = radians( angle ) + atan( target.y, target.x );\n        float length = length( target );\n        vec2 progress = vec2( cos( angle ) * length, sin( angle ) * length ) + origin;\n        return mix( color1, color2, smoothstep( 0.0, 1.0, progress.x ) );\n\n    }\n\n",m="\n\n\t#ifndef PI180\n\t#define PI180 0.01745329251994329577\n\t#endif\n\n\tmat3 rotateX( in float angle ) {\n\n\t\tangle *= PI180;\n\n\t\treturn mat3(\n\t\t\tvec3(   1.0,\t        0.0,             0.0\t    ),\n\t\t\tvec3(   0.0, \t        cos(angle), \t-sin(angle) ),\n\t\t\tvec3(   0.0, \t        sin(angle), \t cos(angle) )\n\t\t);\n\n\t}\n\n\tmat3 rotateY( in float angle ) {\n\n\t\tangle *= PI180;\n\n\t\treturn mat3(\n\t\t\tvec3(   cos(angle),    0.0,           sin(angle)  ),\n\t\t\tvec3(   0.0,           1.0,           0.0         ),\n\t\t\tvec3(   -sin(angle),   0.0,           cos(angle)  )\n\t\t);\n\n\t}\n\n\tmat3 rotateZ( in float angle ) {\n\n\t\tangle *= PI180;\n\n\t\treturn mat3(\n\t\t\tvec3(   cos(angle),   -sin(angle),     0.0   ),\n\t\t\tvec3(   sin(angle),    cos(angle),     0.0   ),\n\t\t\tvec3(   0.0,           0.0,            1.0   )\n\t\t);\n\n\t}\n\n\tmat3 scale( in float x, in float y, in float z ) {\n\n\t\treturn mat3(\n\t\t\tvec3(   x,      0.0,    0.0   ),\n\t\t\tvec3(   0.0,    y,      0.0   ),\n\t\t\tvec3(   0.0,    0.0,    z     )\n\t\t);\n\t\t\n\t}\n\n";function g(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function y(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}var x=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{h:0,s:0,l:100,a:1},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{h:.001},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.HEX;g(this,t);var o=t.hsl(e);this.hsl=o,this.progress={h:o.h/360,s:o.h/100,l:o.h/100,a:o.a},this.speed={},"number"==typeof n?(this.speed.h=n,this.speed.s=this.speed.l=this.speed.a=0):(this.speed.h=n.h||.001,this.speed.s=n.s||0,this.speed.l=n.l||0,this.speed.a=n.a||0),this.output=r}var e,n;return e=t,(n=[{key:"_updateProperty",value:function(t,e){var n=this.speed[t];if(n>0){var r=this.progress[t];(r+=n)>1&&r--,this.progress[t]=r,this.hsl[t]=Math.round(r*e)}}},{key:"update",value:function(){this._updateProperty("h",360),this._updateProperty("s",100),this._updateProperty("l",100),this._updateProperty("a",1)}},{key:"color",get:function(){switch(this.output){case t.HEX:return t.hex(this.hsl);case t.RGB:return t.hsl2rgb(this.hsl);default:return this.hsl}},set:function(e){(e=t.hsl(e))&&(this.hsl=e)}}])&&y(e.prototype,n),t}();function w(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function b(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}x.RGB="rgb",x.HSL="hsl",x.HEX="hex",x.rgb2hsl=function(t){var e,n,r,o,i,a,s;if(!x.check.rgb(t))return null;e=t.r/255,n=t.g/255,r=t.b/255,s=t.a||1;var u=Math.max(e,n,r),l=Math.min(e,n,r);if(a=(u+l)/2,u==l)o=i=0;else{var c=u-l;switch(i=a>.5?c/(2-u-l):c/(u+l),u){case e:o=(n-r)/c+(n<r?6:0);break;case n:o=(r-e)/c+2;break;case r:o=(e-n)/c+4}o/=6}return{h:o=Math.round(360*o),s:i=Math.round(100*i),l:a=Math.round(100*a),a:s}},x.rgb2hex=function(t){return x.check.rgb(t)?"#"+(16777216+(t.b|t.g<<8|t.r<<16)).toString(16).slice(1):null},x.hex2rgb=function(t){var e={};if("string"==typeof t){t=t.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(function(t,e,n,r){return e+e+n+n+r+r}));var n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);e.r=parseInt(n[1],16),e.g=parseInt(n[2],16),e.b=parseInt(n[3],16)}else{if("number"!=typeof t)return null;e.r=t>>16&255,e.g=t>>8&255,e.b=255&t}return e.a=1,e},x.hsl2rgb=function(t){var e,n,r,o,i,a,s;if(!x.check.hsl(t))return null;function u(t,e,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?t+6*(e-t)*n:n<.5?e:n<2/3?t+(e-t)*(2/3-n)*6:t}if(e=t.h/360,n=t.s/100,r=t.l/100,o=t.a||1,0==n)i=a=s=r;else{var l=r<.5?r*(1+n):r+n-r*n,c=2*r-l;i=u(c,l,e+1/3),a=u(c,l,e),s=u(c,l,e-1/3)}return{r:i=Math.round(255*i),g:a=Math.round(255*a),b:s=Math.round(255*s),a:o}},x.check={rgb:function(t){return void 0!==t.r&&void 0!==t.g&&void 0!==t.b},hsl:function(t){return void 0!==t.h&&void 0!==t.s&&void 0!==t.l},hex:function(t){return/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(t)}},x.rgb=function(t){return x.check.hsl(t)?x.hsl2rgb(t):x.check.hex(t)?x.hex2rgb(t):x.check.rgb(t)?t:null},x.hsl=function(t){return x.check.rgb(t)?x.rgb2hsl(t):x.check.hex(t)?(t=x.hex2rgb(t),x.rgb2hsl(t)):x.check.hsl(t)?t:null},x.hex=function(t){return x.check.rgb(t)?x.rgb2hex(t):x.check.hsl(t)?(t=x.hsl2rgb(t),x.rgb2hex(t)):x.check.hex(t)?t:null};var T=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=e.callback,r=void 0===n?null:n,o=e.cursor,i=void 0===o?null:o,a=e.debug,s=void 0!==a&&a,u=e.dispatcher,l=void 0===u?document.body:u,c=e.enabled,h=void 0===c||c,p=e.padding,f=void 0===p?20:p,d=e.paddingBottom,v=void 0===d?null:d,m=e.paddingLeft,g=void 0===m?null:m,y=e.paddingRight,x=void 0===y?null:y,b=e.paddingTop,T=void 0===b?null:b,S=e.precision,D=void 0===S?null:S;w(this,t),this.callback="function"==typeof r?r:s?this.log.bind(this):null,this.precision=D,this.enabled=h,this.x=0,this.y=0,this.setSize(window.innerWidth,window.innerHeight,!1),this.padding=f,v&&(this.padding.bottom=v),g&&(this.padding.left=g),x&&(this.padding.right=x),T&&(this.padding.top=T);var P={x:this.width/2,y:this.height/2};this.cursor=Object.assign({},P),this.target=Object.assign({},P),i&&l&&(l.style.cursor=i),this.dispatcher=l}var e,n;return e=t,(n=[{key:"activate",value:function(t){this.enabled&&(t.preventDefault(),this.active=!0,this.track(t))}},{key:"deactivate",value:function(t){this.enabled&&(t.preventDefault(),this.track(t),this.active=!1)}},{key:"track",value:function(t){if(this.enabled&&this.active){if(t.preventDefault(),t.type.match(/touch/gi)){var e=t.touches[0];this.target.x=e.clientX,this.target.y=e.clientY}else this.target.x=t.clientX,this.target.y=t.clientY;this.cursor.x===this.target.x&&this.cursor.y===this.target.y||this.setCursor(this.target.x,this.target.y)}}},{key:"updateHitbox",value:function(){var t=this._padding,e=this.width-t.left-t.right,n=this.height-t.top-t.bottom;e<1&&(e=1),n<1&&(n=1),this.hitbox={width:e,height:n}}},{key:"setCursor",value:function(t,e){this.cursor.x=t,this.cursor.y=e;var n=this._padding,r=this.hitbox;(t=(t-n.left)/r.width)<0?t=0:t>1&&(t=1),(e=(e-n.top)/r.height)<0?e=0:e>1&&(e=1),e=1-e,this.precision&&(t=t.toPrecision(this.precision),e=e.toPrecision(this.precision)),this.x=t,this.y=e,this.callback&&this.callback.call()}},{key:"setSize",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window.innerWidth,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:window.innerHeight,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.width=t,this.height=e,n&&this.updateHitbox()}},{key:"log",value:function(){console.log("Gesture: { x: ".concat(this.x,", y: ").concat(this.y," }"))}},{key:"dispose",value:function(){this._dispatcher.removeEventListener("pointerenter",this.activate.bind(this),!1),this._dispatcher.removeEventListener("pointerleave",this.deactivate.bind(this),!1),this._dispatcher.removeEventListener("pointermove",this.track.bind(this),!1),this._dispatcher.removeEventListener("touchstart",this.activate.bind(this),!1),this._dispatcher.removeEventListener("touchend",this.deactivate.bind(this),!1),this._dispatcher.removeEventListener("touchmove",this.track.bind(this),!1),this._dispatcher=null}},{key:"dispatcher",get:function(){return this._dispatcher},set:function(t){this._dispatcher&&this.dispose(),this._dispatcher=t,this._dispatcher.addEventListener("pointerenter",this.activate.bind(this),!1),this._dispatcher.addEventListener("pointerleave",this.deactivate.bind(this),!1),this._dispatcher.addEventListener("pointermove",this.track.bind(this),!1),this._dispatcher.addEventListener("touchstart",this.activate.bind(this),!1),this._dispatcher.addEventListener("touchend",this.deactivate.bind(this),!1),this._dispatcher.addEventListener("touchmove",this.track.bind(this),!1)}},{key:"padding",get:function(){return this._padding},set:function(t){this._padding={bottom:t,left:t,right:t,top:t},this.updateHitbox()}},{key:"xy",get:function(){return(this.x+this.y)/2}}])&&b(e.prototype,n),t}();function S(t){return(S="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function D(t,e){return t-e}T.compute=function(t,e,n){return e+(n-e)*t};var P=function t(){this.polygons=[],this.properties=new t.Properties,this.isCanonicalized=!0,this.isRetesselated=!0};function C(t,e,n){for(var r=0,o=t.length;o>r;){var i=Math.floor((r+o)/2);n(e,t[i])>0?r=i+1:o=i}t.splice(r,0,e)}P.defaultResolution2D=32,P.defaultResolution3D=12,P.fromPolygons=function(t){var e=new P;return e.polygons=t,e.isCanonicalized=!1,e.isRetesselated=!1,e},P.fromSlices=function(t){return new P.Polygon.createFromPoints([[0,0,0],[1,0,0],[1,1,0],[0,1,0]]).solidFromSlices(t)},P.fromObject=function(t){var e=t.polygons.map((function(t){return P.Polygon.fromObject(t)})),n=P.fromPolygons(e);return n.canonicalized()},P.fromCompactBinary=function(t){if("CSG"!==t.class)throw new Error("Not a CSG");for(var e,n,r,o,i,a,s=[],u=t.planeData,l=u.length/4,c=0,h=0;h<l;h++)e=u[c++],n=u[c++],r=u[c++],o=u[c++],i=P.Vector3D.Create(e,n,r),a=new P.Plane(i,o),s.push(a);var p,f,d=[],v=t.vertexData,m=v.length/3;c=0;for(var g=0;g<m;g++)e=v[c++],n=v[c++],r=v[c++],p=P.Vector3D.Create(e,n,r),f=new P.Vertex(p),d.push(f);var y,x,w,b,T=t.shared.map((function(t){return P.Polygon.Shared.fromObject(t)})),S=[],D=t.numPolygons,C=t.numVerticesPerPolygon,_=t.polygonVertices,O=t.polygonPlaneIndexes,V=t.polygonSharedIndexes;c=0;for(var M=0;M<D;M++){y=C[M],x=[];for(var N=0;N<y;N++)x.push(d[_[c++]]);a=s[O[M]],w=T[V[M]],b=new P.Polygon(x,w,a),S.push(b)}var R=P.fromPolygons(S);return R.isCanonicalized=!0,R.isRetesselated=!0,R},P.prototype={toPolygons:function(){return this.polygons},union:function(t){var e;t instanceof Array?(e=t.slice(0)).push(this):e=[this,t];for(var n=1;n<e.length;n+=2)e.push(e[n-1].unionSub(e[n]));return e[n-1].reTesselated().canonicalized()},unionSub:function(t,e,n){if(this.mayOverlap(t)){var r=new P.Tree(this.polygons),o=new P.Tree(t.polygons);r.clipTo(o,!1),o.clipTo(r),o.invert(),o.clipTo(r),o.invert();var i=r.allPolygons().concat(o.allPolygons()),a=P.fromPolygons(i);return a.properties=this.properties._merge(t.properties),e&&(a=a.reTesselated()),n&&(a=a.canonicalized()),a}return this.unionForNonIntersecting(t)},unionForNonIntersecting:function(t){var e=this.polygons.concat(t.polygons),n=P.fromPolygons(e);return n.properties=this.properties._merge(t.properties),n.isCanonicalized=this.isCanonicalized&&t.isCanonicalized,n.isRetesselated=this.isRetesselated&&t.isRetesselated,n},subtract:function(t){var e;e=t instanceof Array?t:[t];for(var n=this,r=0;r<e.length;r++){var o=r===e.length-1;n=n.subtractSub(e[r],o,o)}return n},subtractSub:function(t,e,n){var r=new P.Tree(this.polygons),o=new P.Tree(t.polygons);r.invert(),r.clipTo(o),o.clipTo(r,!0),r.addPolygons(o.allPolygons()),r.invert();var i=P.fromPolygons(r.allPolygons());return i.properties=this.properties._merge(t.properties),e&&(i=i.reTesselated()),n&&(i=i.canonicalized()),i},intersect:function(t){var e;e=t instanceof Array?t:[t];for(var n=this,r=0;r<e.length;r++){var o=r===e.length-1;n=n.intersectSub(e[r],o,o)}return n},intersectSub:function(t,e,n){var r=new P.Tree(this.polygons),o=new P.Tree(t.polygons);r.invert(),o.clipTo(r),o.invert(),r.clipTo(o),o.clipTo(r),r.addPolygons(o.allPolygons()),r.invert();var i=P.fromPolygons(r.allPolygons());return i.properties=this.properties._merge(t.properties),e&&(i=i.reTesselated()),n&&(i=i.canonicalized()),i},invert:function(){var t=this.polygons.map((function(t){return t.flipped()}));return P.fromPolygons(t)},transform1:function(t){var e=this.polygons.map((function(e){return e.transform(t)})),n=P.fromPolygons(e);return n.properties=this.properties._transform(t),n.isRetesselated=this.isRetesselated,n},transform:function(t){var e=t.isMirroring(),n={},r={},o=this.polygons.map((function(o){var i,a=o.plane,s=a.getTag();s in r?i=r[s]:(i=a.transform(t),r[s]=i);var u=o.vertices.map((function(e){var r,o=e.getTag();return o in n?r=n[o]:(r=e.transform(t),n[o]=r),r}));return e&&u.reverse(),new P.Polygon(u,o.shared,i)})),i=P.fromPolygons(o);return i.properties=this.properties._transform(t),i.isRetesselated=this.isRetesselated,i.isCanonicalized=this.isCanonicalized,i},toString:function(){var t="CSG solid:\n";return this.polygons.map((function(e){t+=e.toString()})),t},expand:function(t,e){var n=this.expandedShell(t,e,!0);return(n=n.reTesselated()).properties=this.properties,n},contract:function(t,e){var n=this.expandedShell(t,e,!1),r=this.subtract(n);return(r=r.reTesselated()).properties=this.properties,r},stretchAtPlane:function(t,e,n){var r=P.Plane.fromNormalAndPoint(t,e),o=new P.OrthoNormalBasis(r),i=this.sectionCut(o).extrudeInOrthonormalBasis(o,n),a=this.cutByPlane(r),s=this.cutByPlane(r.flipped());return a.union([i,s.translate(r.normal.times(n))])},expandedShell:function(t,e,n){var r,o=this.reTesselated();r=n?o:new P,o.polygons.map((function(e){var n=e.plane.normal.unit().times(2*t),o=e.translate(n.times(-.5)).extrude(n);r=r.unionSub(o,!1,!1)}));var i={};for(var a in o.polygons.map((function(t){for(var e=t.vertices.length,n=t.vertices[e-1],r=n.getTag(),o=0;o<e;o++){var a,s,u=t.vertices[o],l=u.getTag();(a=l<r?l+"-"+r:r+"-"+l)in i?s=i[a]:(s={v1:n,v2:u,planenormals:[]},i[a]=s),s.planenormals.push(t.plane.normal),r=l,n=u}})),i){for(var s=i[a],u=s.v1.pos,l=s.v2.pos,c=l.minus(u).unit(),h=s.planenormals[0].unit(),p=h.cross(c),f=[],d=0;d<e;d++)f.push(d*Math.PI*2/e);d=0;for(var v=s.planenormals.length;d<v;d++){var m=s.planenormals[d],g=p.dot(m),y=h.dot(m);(_=Math.atan2(g,y))<0&&(_+=2*Math.PI),f.push(_),(_=Math.atan2(-g,-y))<0&&(_+=2*Math.PI),f.push(_)}var x,w,b=(f=f.sort(D)).length,T=[],S=[],C=[];for(d=-1;d<b;d++){var _=f[d<0?d+b:d],O=(g=Math.sin(_),y=Math.cos(_),h.times(y*t).plus(p.times(g*t))),V=u.plus(O),M=l.plus(O),N=!1;if(d>=0&&V.distanceTo(x)<1e-5&&(N=!0),!N){if(d>=0){T.push(new P.Vertex(V)),S.push(new P.Vertex(M));var R=[new P.Vertex(w),new P.Vertex(M),new P.Vertex(V),new P.Vertex(x)],z=new P.Polygon(R);C.push(z)}x=V,w=M}}S.reverse(),C.push(new P.Polygon(T)),C.push(new P.Polygon(S));var E=P.fromPolygons(C);r=r.unionSub(E,!1,!1)}var L={};for(var A in o.polygons.map((function(t){t.vertices.map((function(e){var n,r=e.getTag();r in L?n=L[r]:(n={pos:e.pos,normals:[]},L[r]=n),n.normals.push(t.plane.normal)}))})),L){var F=L[A],I=F.normals[0].unit(),B=null,k=0;for(d=1;d<F.normals.length;d++){var j=F.normals[d].unit(),U=I.cross(j).length();U>.05&&U>k&&(k=U,B=j)}B||(B=I.randomNonParallelVector());var G=I.cross(B).unit(),J=G.cross(I),q=P.sphere({center:F.pos,radius:t,resolution:e,axes:[I,G,J]});r=r.unionSub(q,!1,!1)}return r},canonicalized:function(){if(this.isCanonicalized)return this;var t=(new P.fuzzyCSGFactory).getCSG(this);return t.isCanonicalized=!0,t.isRetesselated=this.isRetesselated,t.properties=this.properties,t},reTesselated:function(){if(this.isRetesselated)return this;var t={},e=this.isCanonicalized,n=new P.fuzzyCSGFactory;this.polygons.map((function(r){var o=r.plane,i=r.shared;e||(o=n.getPlane(o),i=n.getPolygonShared(i));var a=o.getTag()+"/"+i.getTag();a in t?t[a].push(r):t[a]=[r]}));var r=[];for(var o in t){var i=t[o];if(i.length<2)r=r.concat(i);else{var a=[];P.reTesselateCoplanarPolygons(i,a),r=r.concat(a)}}var s=P.fromPolygons(r);return s.isRetesselated=!0,s.properties=this.properties,s},getBounds:function(){if(!this.cachedBoundingBox){for(var t=new P.Vector3D(0,0,0),e=new P.Vector3D(0,0,0),n=this.polygons,r=n.length,o=0;o<r;o++){var i=n[o].boundingBox();0===o?(t=i[0],e=i[1]):(t=t.min(i[0]),e=e.max(i[1]))}this.cachedBoundingBox=[t,e]}return this.cachedBoundingBox},mayOverlap:function(t){if(0===this.polygons.length||0===t.polygons.length)return!1;var e=this.getBounds(),n=t.getBounds();return!(e[1].x<n[0].x||e[0].x>n[1].x||e[1].y<n[0].y||e[0].y>n[1].y||e[1].z<n[0].z||e[0].z>n[1].z)},cutByPlane:function(t){if(0===this.polygons.length)return new P;var e=t.normal.times(t.w),n=0;this.polygons.map((function(t){t.vertices.map((function(t){var r=t.pos.distanceToSquared(e);r>n&&(n=r)}))})),n=Math.sqrt(n),n*=1.01;var r=[],o=new P.OrthoNormalBasis(t);r.push(new P.Vertex(o.to3D(new P.Vector2D(n,-n)))),r.push(new P.Vertex(o.to3D(new P.Vector2D(-n,-n)))),r.push(new P.Vertex(o.to3D(new P.Vector2D(-n,n)))),r.push(new P.Vertex(o.to3D(new P.Vector2D(n,n))));var i=new P.Polygon(r,null,t.flipped()).extrude(t.normal.times(-n)),a=this.intersect(i);return a.properties=this.properties,a},connectTo:function(t,e,n,r){var o=t.getTransformationTo(e,n,r);return this.transform(o)},setShared:function(t){var e=this.polygons.map((function(e){return new P.Polygon(e.vertices,t,e.plane)})),n=P.fromPolygons(e);return n.properties=this.properties,n.isRetesselated=this.isRetesselated,n.isCanonicalized=this.isCanonicalized,n},setColor:function(t){var e=P.Polygon.Shared.fromColor.apply(this,arguments);return this.setShared(e)},toCompactBinary:function(){var t=this.canonicalized(),e=t.polygons.length,n=0,r=0,o={},i=[],a=0,s={},u=0,l=[],c=[],h={},p=0;t.polygons.map((function(t){t.vertices.map((function(t){++n;var e=t.getTag();e in o||(o[e]=r++,i.push(t))}));var e=t.plane.getTag();e in s||(s[e]=a++,l.push(t.plane));var u=t.shared.getTag();u in h||(h[u]=p++,c.push(t.shared))}));var f=new Uint32Array(e),d=new Uint32Array(e),v=new Uint32Array(n),m=new Uint32Array(e),g=new Float64Array(3*r),y=new Float64Array(4*a),x=0;for(u=0;u<e;++u){var w=t.polygons[u];f[u]=w.vertices.length,w.vertices.map((function(t){var e=t.getTag(),n=o[e];v[x++]=n}));var b=w.plane.getTag(),T=s[b];m[u]=T;var S=w.shared.getTag(),D=h[S];d[u]=D}var P=0;i.map((function(t){var e=t.pos;g[P++]=e._x,g[P++]=e._y,g[P++]=e._z}));var C=0;return l.map((function(t){var e=t.normal;y[C++]=e._x,y[C++]=e._y,y[C++]=e._z,y[C++]=t.w})),{class:"CSG",numPolygons:e,numVerticesPerPolygon:f,polygonPlaneIndexes:m,polygonSharedIndexes:d,polygonVertices:v,vertexData:g,planeData:y,shared:c}},toPointCloud:function(t){var e=this.reTesselated(),n=new P,r={};for(var o in e.polygons.map((function(t){t.vertices.map((function(t){r[t.getTag()]=t.pos}))})),r){var i=r[o],a=P.cube({center:i,radius:t});n=n.unionSub(a,!1,!1)}return n.reTesselated()},getTransformationAndInverseTransformationToFlatLying:function(){if(0===this.polygons.length)return new P.Matrix4x4;var t=this.canonicalized(),e={};t.polygons.map((function(t){e[t.plane.getTag()]=t.plane}));var n,r,o=new P.Vector3D(1,0,0),i=new P.Vector3D(0,1,0),a=new P.Vector3D(0,0,1),s=new P.Connector([0,0,0],[0,0,-1],o),u=new P.Connector([0,0,0],[0,0,-1],i),l=!0,c=0,h=0;for(var p in e){var f,d,v,m=e[p],g=m.normal.times(m.w);m.normal.cross(o).length()>m.normal.cross(i).length()?(f=(v=new P.Connector(g,m.normal,o)).getTransformationTo(s,!1,0),d=s.getTransformationTo(v,!1,0)):(f=(v=new P.Connector(g,m.normal,i)).getTransformationTo(u,!1,0),d=u.getTransformationTo(v,!1,0));var y=t.transform(f),x=-m.normal.dot(a),w=y.getBounds(),b=w[1].z-w[0].z,T=l;if(T||(b<c||b===c&&x>h)&&(T=!0),T){var S=new P.Vector3D([-.5*(w[1].x+w[0].x),-.5*(w[1].y+w[0].y),-w[0].z]);c=b,h=x,n=f=f.multiply(P.Matrix4x4.translation(S)),r=d=P.Matrix4x4.translation(S.negated()).multiply(d)}l=!1}return[n,r]},getTransformationToFlatLying:function(){return this.getTransformationAndInverseTransformationToFlatLying()[0]},lieFlat:function(){var t=this.getTransformationToFlatLying();return this.transform(t)},projectToOrthoNormalBasis:function(t){var e=1e-5,n=[];return this.polygons.filter((function(n){return n.plane.normal.minus(t.plane.normal).lengthSquared()<e*e})).map((function(e){var r=e.projectToOrthoNormalBasis(t);r.sides.length>0&&n.push(r)})),(new _).union(n)},sectionCut:function(t){var e=t.plane,n=t.plane.flipped();e=new P.Plane(e.normal,e.w),n=new P.Plane(n.normal,n.w+5e-5);var r=this.cutByPlane(e);return(r=r.cutByPlane(n)).projectToOrthoNormalBasis(t)},fixTJunctions:function(){for(var t=this.canonicalized(),e={},n=0;n<t.polygons.length;n++){var r=(U=t.polygons[n]).vertices.length;if(r>=3)for(var o=U.vertices[0],i=o.getTag(),a=0;a<r;a++){var s=a+1;s===r&&(s=0);var u=U.vertices[s],l=u.getTag(),c=i+"/"+l,h=l+"/"+i;if(h in e){var p=e[h];p.splice(-1,1),0===p.length&&delete e[h]}else{var f={vertex0:o,vertex1:u,polygonindex:n};c in e?e[c].push(f):e[c]=[f]}o=u,i=l}}var d={},v={},m={},g=!0;for(var c in e)g=!1,m[c]=!0,e[c].map((function(t){var e=t.vertex0.getTag(),n=t.vertex1.getTag();e in d?d[e].push(c):d[e]=[c],n in v?v[n].push(c):v[n]=[c]}));if(!g){for(var y=function(t,n,r){var o=t.getTag(),i=n.getTag();if(o===i)throw new Error("Assertion failed");var a=o+"/"+i;if(i+"/"+o in e)return x(n,t,null),null;var s={vertex0:t,vertex1:n,polygonindex:r};return a in e?e[a].push(s):e[a]=[s],o in d?d[o].push(a):d[o]=[a],i in v?v[i].push(a):v[i]=[a],a},x=function(t,n,r){var o=t.getTag(),i=n.getTag(),a=o+"/"+i;if(!(a in e))throw new Error("Assertion failed");for(var s=-1,u=e[a],l=0;l<u.length;l++){var c=u[l];if(c.vertex0===t&&c.vertex1===n&&(null===r||c.polygonindex===r)){s=l;break}}if(s<0)throw new Error("Assertion failed");if(u.splice(s,1),0===u.length&&delete e[a],(s=d[o].indexOf(a))<0)throw new Error("Assertion failed");if(d[o].splice(s,1),0===d[o].length&&delete d[o],(s=v[i].indexOf(a))<0)throw new Error("Assertion failed");v[i].splice(s,1),0===v[i].length&&delete v[i]},w=t.polygons.slice(0);;){for(var c in g=!0,e)g=!1,m[c]=!0;if(g)break;for(var b=!1;;){var T=null;for(var c in m){T=c;break}if(null===T)break;var S=!0;if(T in e){var D=e[T];if(0===D.length)throw new Error("Assertion failed");f=D[0];for(var C=0;C<2;C++){var _=0===C?f.vertex0:f.vertex1,O=0===C?f.vertex1:f.vertex0,V=_.getTag(),M=O.getTag(),N=[];0===C?V in v&&(N=v[V]):V in d&&(N=d[V]);for(var R=0;R<N.length;R++){var z=N[R],E=e[z][0],L=0===C?E.vertex0:E.vertex1,A=0===C?E.vertex1:E.vertex0,F=L.getTag();if(A.getTag()!==V)throw new Error("Assertion failed");if(F===M){x(_,O,null),x(O,_,null),S=!1,C=2,b=!0;break}var I=_.pos,B=O.pos,k=L.pos.minus(I),j=B.minus(I).dot(k)/k.dot(k);if(j>0&&j<1&&I.plus(k.times(j)).distanceToSquared(B)<1e-10){for(var U=w[n=E.polygonindex],G=E.vertex1.getTag(),J=-1,q=0;q<U.vertices.length;q++)if(U.vertices[q].getTag()===G){J=q;break}if(J<0)throw new Error("Assertion failed");var X=U.vertices.slice(0);X.splice(J,0,O);var Y=new P.Polygon(X,U.shared);w[n]=Y,x(E.vertex0,E.vertex1,n);var Z=y(E.vertex0,O,n),W=y(O,E.vertex1,n);null!==Z&&(m[Z]=!0),null!==W&&(m[W]=!0),S=!1,C=2,b=!0;break}}}}S&&delete m[c]}if(!b)break}var H=P.fromPolygons(w);H.properties=t.properties,H.isCanonicalized=!0,H.isRetesselated=!0,t=H}for(var c in g=!0,e){g=!1;break}return g||OpenJsCad.log("!sidemapisempty"),t},toTriangles:function(){var t=[];return this.polygons.forEach((function(e){for(var n=e.vertices[0],r=e.vertices.length-3;r>=0;r--)t.push(new P.Polygon([n,e.vertices[r+1],e.vertices[r+2]],e.shared,e.plane))})),t},getFeatures:function(t){t instanceof Array||(t=[t]);var e=this.toTriangles().map((function(e){return e.getTetraFeatures(t)})).reduce((function(t,e){return e.map((function(e,n){return e+(0===t?0:t[n])}))}),0);return 1===e.length?e[0]:e}},P.parseOption=function(t,e,n){var r=n;return t&&e in t&&(r=t[e]),r},P.parseOptionAs3DVector=function(t,e,n){var r=P.parseOption(t,e,n);return new P.Vector3D(r)},P.parseOptionAs3DVectorList=function(t,e,n){return P.parseOption(t,e,n).map((function(t){return new P.Vector3D(t)}))},P.parseOptionAs2DVector=function(t,e,n){var r=P.parseOption(t,e,n);return new P.Vector2D(r)},P.parseOptionAsFloat=function(t,e,n){var r=P.parseOption(t,e,n);if("string"==typeof r&&(r=Number(r)),isNaN(r)||"number"!=typeof r)throw new Error("Parameter "+e+" should be a number");return r},P.parseOptionAsInt=function(t,e,n){var r=P.parseOption(t,e,n);if(r=Number(Math.floor(r)),isNaN(r))throw new Error("Parameter "+e+" should be a number");return r},P.parseOptionAsBool=function(t,e,n){var r=P.parseOption(t,e,n);return"string"==typeof r&&("true"===r?r=!0:("false"===r||0===r)&&(r=!1)),!!r},P.cube=function(t){var e,n;if("corner1"in(t=t||{})||"corner2"in t){if("center"in t||"radius"in t)throw new Error("cube: should either give a radius and center parameter, or a corner1 and corner2 parameter");corner1=P.parseOptionAs3DVector(t,"corner1",[0,0,0]),corner2=P.parseOptionAs3DVector(t,"corner2",[1,1,1]),e=corner1.plus(corner2).times(.5),n=corner2.minus(corner1).times(.5)}else e=P.parseOptionAs3DVector(t,"center",[0,0,0]),n=P.parseOptionAs3DVector(t,"radius",[1,1,1]);n=n.abs();var r=P.fromPolygons([[[0,4,6,2],[-1,0,0]],[[1,3,7,5],[1,0,0]],[[0,1,5,4],[0,-1,0]],[[2,6,7,3],[0,1,0]],[[0,2,3,1],[0,0,-1]],[[4,5,7,6],[0,0,1]]].map((function(t){var r=t[0].map((function(t){var r=new P.Vector3D(e.x+n.x*(2*!!(1&t)-1),e.y+n.y*(2*!!(2&t)-1),e.z+n.z*(2*!!(4&t)-1));return new P.Vertex(r)}));return new P.Polygon(r,null)})));return r.properties.cube=new P.Properties,r.properties.cube.center=new P.Vector3D(e),r.properties.cube.facecenters=[new P.Connector(new P.Vector3D([n.x,0,0]).plus(e),[1,0,0],[0,0,1]),new P.Connector(new P.Vector3D([-n.x,0,0]).plus(e),[-1,0,0],[0,0,1]),new P.Connector(new P.Vector3D([0,n.y,0]).plus(e),[0,1,0],[0,0,1]),new P.Connector(new P.Vector3D([0,-n.y,0]).plus(e),[0,-1,0],[0,0,1]),new P.Connector(new P.Vector3D([0,0,n.z]).plus(e),[0,0,1],[1,0,0]),new P.Connector(new P.Vector3D([0,0,-n.z]).plus(e),[0,0,-1],[1,0,0])],r},P.sphere=function(t){t=t||{};var e,n,r,o=P.parseOptionAs3DVector(t,"center",[0,0,0]),i=P.parseOptionAsFloat(t,"radius",1),a=P.parseOptionAsInt(t,"resolution",P.defaultResolution3D);"axes"in t?(e=t.axes[0].unit().times(i),n=t.axes[1].unit().times(i),r=t.axes[2].unit().times(i)):(e=new P.Vector3D([1,0,0]).times(i),n=new P.Vector3D([0,-1,0]).times(i),r=new P.Vector3D([0,0,1]).times(i)),a<4&&(a=4);for(var s,u=Math.round(a/4),l=[],c=0;c<=a;c++){var h=2*Math.PI*c/a,p=e.times(Math.cos(h)).plus(n.times(Math.sin(h)));if(c>0)for(var f,d,v=[],m=0;m<=u;m++){var g=.5*Math.PI*m/u,y=Math.cos(g),x=Math.sin(g);m>0&&((v=[]).push(new P.Vertex(o.plus(s.times(f).minus(r.times(d))))),v.push(new P.Vertex(o.plus(p.times(f).minus(r.times(d))))),m<u&&v.push(new P.Vertex(o.plus(p.times(y).minus(r.times(x))))),v.push(new P.Vertex(o.plus(s.times(y).minus(r.times(x))))),l.push(new P.Polygon(v)),(v=[]).push(new P.Vertex(o.plus(s.times(f).plus(r.times(d))))),v.push(new P.Vertex(o.plus(p.times(f).plus(r.times(d))))),m<u&&v.push(new P.Vertex(o.plus(p.times(y).plus(r.times(x))))),v.push(new P.Vertex(o.plus(s.times(y).plus(r.times(x))))),v.reverse(),l.push(new P.Polygon(v))),f=y,d=x}s=p}var w=P.fromPolygons(l);return w.properties.sphere=new P.Properties,w.properties.sphere.center=new P.Vector3D(o),w.properties.sphere.facepoint=o.plus(e),w},P.cylinder=function(t){var e=P.parseOptionAs3DVector(t,"start",[0,-1,0]),n=P.parseOptionAs3DVector(t,"end",[0,1,0]),r=P.parseOptionAsFloat(t,"radius",1),o=P.parseOptionAsFloat(t,"radiusEnd",r),i=P.parseOptionAsFloat(t,"radiusStart",r),a=P.parseOptionAsFloat(t,"sectorAngle",360);if(a=a>360?a%360:a,o<0||i<0)throw new Error("Radius should be non-negative");if(0===o&&0===i)throw new Error("Either radiusStart or radiusEnd should be positive");var s=P.parseOptionAsInt(t,"resolution",P.defaultResolution2D),u=n.minus(e),l=u.unit(),c=l.randomNonParallelVector().unit(),h=c.cross(l).unit(),p=new P.Vertex(e),f=new P.Vertex(n),d=[];function v(t,n,r){var o=n*Math.PI*a/180,i=c.times(Math.cos(o)).plus(h.times(Math.sin(o))),s=e.plus(u.times(t)).plus(i.times(r));return new P.Vertex(s)}if(a>0){for(var m=0;m<s;m++){var g=m/s,y=(m+1)/s;o===i?(d.push(new P.Polygon([p,v(0,g,o),v(0,y,o)])),d.push(new P.Polygon([v(0,y,o),v(0,g,o),v(1,g,o),v(1,y,o)])),d.push(new P.Polygon([f,v(1,y,o),v(1,g,o)]))):(i>0&&(d.push(new P.Polygon([p,v(0,g,i),v(0,y,i)])),d.push(new P.Polygon([v(0,g,i),v(1,g,o),v(0,y,i)]))),o>0&&(d.push(new P.Polygon([f,v(1,y,o),v(1,g,o)])),d.push(new P.Polygon([v(1,g,o),v(1,y,o),v(0,y,i)]))))}a<360&&(d.push(new P.Polygon([p,f,v(0,0,i)])),d.push(new P.Polygon([v(0,0,i),f,v(1,0,o)])),d.push(new P.Polygon([p,v(0,1,i),f])),d.push(new P.Polygon([v(0,1,i),v(1,1,o),f])))}var x=P.fromPolygons(d);x.properties.cylinder=new P.Properties,x.properties.cylinder.start=new P.Connector(e,l.negated(),c),x.properties.cylinder.end=new P.Connector(n,l,c);var w=e.plus(u.times(.5)),b=c.rotate(e,l,-a/2).times((i+o)/2),T=b.cross(l);return x.properties.cylinder.facepointH=new P.Connector(w.plus(b),b,l),x.properties.cylinder.facepointH90=new P.Connector(w.plus(T),T,l),x},P.roundedCylinder=function(t){var e,n=P.parseOptionAs3DVector(t,"start",[0,-1,0]),r=P.parseOptionAs3DVector(t,"end",[0,1,0]),o=P.parseOptionAsFloat(t,"radius",1),i=r.minus(n);e=Math.abs(i.x)>Math.abs(i.y)?new P.Vector3D(0,1,0):new P.Vector3D(1,0,0);var a=P.parseOptionAs3DVector(t,"normal",e),s=P.parseOptionAsInt(t,"resolution",P.defaultResolution3D);s<4&&(s=4);var u=[],l=Math.floor(.25*s);if(i.length()<1e-10)return P.sphere({center:n,radius:o,resolution:s});for(var c,h=i.unit().times(o),p=h.cross(a).unit().times(o),f=p.cross(h).unit().times(o),d=0;d<=s;d++){var v=2*Math.PI*d/s,m=p.times(Math.cos(v)).plus(f.times(Math.sin(v)));if(d>0){var g,y,x=[];x.push(new P.Vertex(n.plus(m))),x.push(new P.Vertex(n.plus(c))),x.push(new P.Vertex(r.plus(c))),x.push(new P.Vertex(r.plus(m))),u.push(new P.Polygon(x));for(var w=0;w<=l;w++){var b=.5*Math.PI*w/l,T=Math.cos(b),S=Math.sin(b);w>0&&((x=[]).push(new P.Vertex(n.plus(c.times(g).minus(h.times(y))))),x.push(new P.Vertex(n.plus(m.times(g).minus(h.times(y))))),w<l&&x.push(new P.Vertex(n.plus(m.times(T).minus(h.times(S))))),x.push(new P.Vertex(n.plus(c.times(T).minus(h.times(S))))),u.push(new P.Polygon(x)),(x=[]).push(new P.Vertex(r.plus(c.times(g).plus(h.times(y))))),x.push(new P.Vertex(r.plus(m.times(g).plus(h.times(y))))),w<l&&x.push(new P.Vertex(r.plus(m.times(T).plus(h.times(S))))),x.push(new P.Vertex(r.plus(c.times(T).plus(h.times(S))))),x.reverse(),u.push(new P.Polygon(x))),g=T,y=S}}c=m}var D=P.fromPolygons(u),C=h.unit(),_=p.unit();return D.properties.roundedCylinder=new P.Properties,D.properties.roundedCylinder.start=new P.Connector(n,C.negated(),_),D.properties.roundedCylinder.end=new P.Connector(r,C,_),D.properties.roundedCylinder.facepoint=n.plus(p),D},P.roundedCube=function(t){var e,n,r=1e-5,o=.01;if("corner1"in(t=t||{})||"corner2"in t){if("center"in t||"radius"in t)throw new Error("roundedCube: should either give a radius and center parameter, or a corner1 and corner2 parameter");corner1=P.parseOptionAs3DVector(t,"corner1",[0,0,0]),corner2=P.parseOptionAs3DVector(t,"corner2",[1,1,1]),e=corner1.plus(corner2).times(.5),n=corner2.minus(corner1).times(.5)}else e=P.parseOptionAs3DVector(t,"center",[0,0,0]),n=P.parseOptionAs3DVector(t,"radius",[1,1,1]);n=n.abs();var i=P.parseOptionAsInt(t,"resolution",P.defaultResolution3D);i<4&&(i=4),i%2==1&&i<8&&(i=8);var a=P.parseOptionAs3DVector(t,"roundradius",[.2,.2,.2]);a=P.Vector3D.Create(Math.max(a.x,o),Math.max(a.y,o),Math.max(a.z,o));var s=n.minus(a);if(s.x<0||s.y<0||s.z<0)throw"roundradius <= radius!";var u=P.sphere({radius:1,resolution:i});return u=u.scale(a),s.x>r&&(u=u.stretchAtPlane([1,0,0],[0,0,0],2*s.x)),s.y>r&&(u=u.stretchAtPlane([0,1,0],[0,0,0],2*s.y)),s.z>r&&(u=u.stretchAtPlane([0,0,1],[0,0,0],2*s.z)),(u=(u=u.translate([-s.x+e.x,-s.y+e.y,-s.z+e.z])).reTesselated()).properties.roundedCube=new P.Properties,u.properties.roundedCube.center=new P.Vertex(e),u.properties.roundedCube.facecenters=[new P.Connector(new P.Vector3D([n.x,0,0]).plus(e),[1,0,0],[0,0,1]),new P.Connector(new P.Vector3D([-n.x,0,0]).plus(e),[-1,0,0],[0,0,1]),new P.Connector(new P.Vector3D([0,n.y,0]).plus(e),[0,1,0],[0,0,1]),new P.Connector(new P.Vector3D([0,-n.y,0]).plus(e),[0,-1,0],[0,0,1]),new P.Connector(new P.Vector3D([0,0,n.z]).plus(e),[0,0,1],[1,0,0]),new P.Connector(new P.Vector3D([0,0,-n.z]).plus(e),[0,0,-1],[1,0,0])],u},P.polyhedron=function(t){if("points"in(t=t||{})!="faces"in t)throw new Error("polyhedron needs 'points' and 'faces' arrays");var e=P.parseOptionAs3DVectorList(t,"points",[[1,1,0],[1,-1,0],[-1,-1,0],[-1,1,0],[0,0,1]]).map((function(t){return new P.Vertex(t)})),n=P.parseOption(t,"faces",[[0,1,4],[1,2,4],[2,3,4],[3,0,4],[1,0,3],[2,1,3]]);n.forEach((function(t){t.reverse()}));var r=n.map((function(t){return new P.Polygon(t.map((function(t){return e[t]})))}));return P.fromPolygons(r).reTesselated()},P.IsFloat=function(t){return!isNaN(t)||t===1/0||t===-1/0},P.solve2Linear=function(t,e,n,r,o,i){var a=1/(t*r-e*n),s=o*r-e*i,u=-o*n+t*i;return[s*=a,u*=a]},P.Vector3D=function(t,e,n){if(3===arguments.length)this._x=parseFloat(t),this._y=parseFloat(e),this._z=parseFloat(n);else if(2===arguments.length)this._x=parseFloat(t),this._y=parseFloat(e),this._z=0;else{var r=!0;if(1===arguments.length)if("object"===S(t))t instanceof P.Vector3D?(this._x=t._x,this._y=t._y,this._z=t._z):t instanceof P.Vector2D?(this._x=t._x,this._y=t._y,this._z=0):t instanceof Array?t.length<2||t.length>3?r=!1:(this._x=parseFloat(t[0]),this._y=parseFloat(t[1]),3===t.length?this._z=parseFloat(t[2]):this._z=0):"x"in t&&"y"in t?(this._x=parseFloat(t.x),this._y=parseFloat(t.y),this._z="z"in t?parseFloat(t.z):0):r=!1;else{var o=parseFloat(t);this._x=o,this._y=o,this._z=o}else r=!1;if(r&&(P.IsFloat(this._x)&&P.IsFloat(this._y)&&P.IsFloat(this._z)||(r=!1)),!r)throw new Error("wrong arguments")}},P.Vector3D.Create=function(t,e,n){var r=Object.create(P.Vector3D.prototype);return r._x=t,r._y=e,r._z=n,r},P.Vector3D.prototype={get x(){return this._x},get y(){return this._y},get z(){return this._z},set x(t){throw new Error("Vector3D is immutable")},set y(t){throw new Error("Vector3D is immutable")},set z(t){throw new Error("Vector3D is immutable")},clone:function(){return P.Vector3D.Create(this._x,this._y,this._z)},negated:function(){return P.Vector3D.Create(-this._x,-this._y,-this._z)},abs:function(){return P.Vector3D.Create(Math.abs(this._x),Math.abs(this._y),Math.abs(this._z))},plus:function(t){return P.Vector3D.Create(this._x+t._x,this._y+t._y,this._z+t._z)},minus:function(t){return P.Vector3D.Create(this._x-t._x,this._y-t._y,this._z-t._z)},times:function(t){return P.Vector3D.Create(this._x*t,this._y*t,this._z*t)},dividedBy:function(t){return P.Vector3D.Create(this._x/t,this._y/t,this._z/t)},dot:function(t){return this._x*t._x+this._y*t._y+this._z*t._z},lerp:function(t,e){return this.plus(t.minus(this).times(e))},lengthSquared:function(){return this.dot(this)},length:function(){return Math.sqrt(this.lengthSquared())},unit:function(){return this.dividedBy(this.length())},cross:function(t){return P.Vector3D.Create(this._y*t._z-this._z*t._y,this._z*t._x-this._x*t._z,this._x*t._y-this._y*t._x)},distanceTo:function(t){return this.minus(t).length()},distanceToSquared:function(t){return this.minus(t).lengthSquared()},equals:function(t){return this._x===t._x&&this._y===t._y&&this._z===t._z},multiply4x4:function(t){return t.leftMultiply1x3Vector(this)},transform:function(t){return t.leftMultiply1x3Vector(this)},toString:function(){return"("+this._x.toFixed(2)+", "+this._y.toFixed(2)+", "+this._z.toFixed(2)+")"},randomNonParallelVector:function(){var t=this.abs();return t._x<=t._y&&t._x<=t._z?P.Vector3D.Create(1,0,0):t._y<=t._x&&t._y<=t._z?P.Vector3D.Create(0,1,0):P.Vector3D.Create(0,0,1)},min:function(t){return P.Vector3D.Create(Math.min(this._x,t._x),Math.min(this._y,t._y),Math.min(this._z,t._z))},max:function(t){return P.Vector3D.Create(Math.max(this._x,t._x),Math.max(this._y,t._y),Math.max(this._z,t._z))}},P.Vertex=function(t){this.pos=t},P.Vertex.fromObject=function(t){var e=new P.Vector3D(t.pos);return new P.Vertex(e)},P.Vertex.prototype={flipped:function(){return this},getTag:function(){var t=this.tag;return t||(t=P.getTag(),this.tag=t),t},interpolate:function(t,e){var n=this.pos.lerp(t.pos,e);return new P.Vertex(n)},transform:function(t){var e=this.pos.multiply4x4(t);return new P.Vertex(e)},toString:function(){return this.pos.toString()}},P.Plane=function(t,e){this.normal=t,this.w=e},P.Plane.fromObject=function(t){var e=new P.Vector3D(t.normal),n=parseFloat(t.w);return new P.Plane(e,n)},P.Plane.EPSILON=1e-5,P.Plane.fromVector3Ds=function(t,e,n){var r=e.minus(t).cross(n.minus(t)).unit();return new P.Plane(r,r.dot(t))},P.Plane.anyPlaneFromVector3Ds=function(t,e,n){var r=e.minus(t),o=n.minus(t);r.length()<1e-5&&(r=o.randomNonParallelVector()),o.length()<1e-5&&(o=r.randomNonParallelVector());var i=r.cross(o);return i.length()<1e-5&&(o=r.randomNonParallelVector(),i=r.cross(o)),i=i.unit(),new P.Plane(i,i.dot(t))},P.Plane.fromPoints=function(t,e,n){return t=new P.Vector3D(t),e=new P.Vector3D(e),n=new P.Vector3D(n),P.Plane.fromVector3Ds(t,e,n)},P.Plane.fromNormalAndPoint=function(t,e){t=new P.Vector3D(t),e=new P.Vector3D(e),t=t.unit();var n=e.dot(t);return new P.Plane(t,n)},P.Plane.prototype={flipped:function(){return new P.Plane(this.normal.negated(),-this.w)},getTag:function(){var t=this.tag;return t||(t=P.getTag(),this.tag=t),t},equals:function(t){return this.normal.equals(t.normal)&&this.w===t.w},transform:function(t){var e=t.isMirroring(),n=this.normal.randomNonParallelVector(),r=this.normal.cross(n),o=this.normal.cross(r),i=this.normal.times(this.w),a=i.plus(r),s=i.plus(o);i=i.multiply4x4(t),a=a.multiply4x4(t),s=s.multiply4x4(t);var u=P.Plane.fromVector3Ds(i,a,s);return e&&(u=u.flipped()),u},splitPolygon:function(t){var e={type:null,front:null,back:null},n=this.normal,r=t.vertices,o=r.length;if(t.plane.equals(this))e.type=0;else{for(var i=P.Plane.EPSILON,a=this.w,s=!1,u=!1,l=[],c=-i,h=0;h<o;h++){var p=(C=n.dot(r[h].pos)-a)<0;l.push(p),C>i&&(s=!0),C<c&&(u=!0)}if(s||u)if(u)if(s){e.type=4;for(var f=[],d=[],v=(p=l[0],0);v<o;v++){var m=r[v],g=v+1;g>=o&&(g=0);var y=l[g];if(p===y)p?d.push(m):f.push(m);else{var x=m.pos,w=r[g].pos,b=this.splitLineBetweenPoints(x,w),T=new P.Vertex(b);p?(d.push(m),d.push(T),f.push(T)):(f.push(m),f.push(T),d.push(T))}p=y}var S=P.Plane.EPSILON*P.Plane.EPSILON;if(d.length>=3){var D=d[d.length-1];for(v=0;v<d.length;v++)(m=d[v]).pos.distanceToSquared(D.pos)<S&&(d.splice(v,1),v--),D=m}if(f.length>=3)for(D=f[f.length-1],v=0;v<f.length;v++)(m=f[v]).pos.distanceToSquared(D.pos)<S&&(f.splice(v,1),v--),D=m;f.length>=3&&(e.front=new P.Polygon(f,t.shared,t.plane)),d.length>=3&&(e.back=new P.Polygon(d,t.shared,t.plane))}else e.type=3;else e.type=2;else{var C=n.dot(t.plane.normal);e.type=C>=0?0:1}}return e},splitLineBetweenPoints:function(t,e){var n=e.minus(t),r=(this.w-this.normal.dot(t))/this.normal.dot(n);return isNaN(r)&&(r=0),r>1&&(r=1),r<0&&(r=0),t.plus(n.times(r))},intersectWithLine:function(t){return t.intersectWithPlane(this)},intersectWithPlane:function(t){return P.Line3D.fromPlanes(this,t)},signedDistanceToPoint:function(t){return this.normal.dot(t)-this.w},toString:function(){return"[normal: "+this.normal.toString()+", w: "+this.w+"]"},mirrorPoint:function(t){var e=this.signedDistanceToPoint(t);return t.minus(this.normal.times(2*e))}},P.Polygon=function(t,e,n){this.vertices=t,e||(e=P.Polygon.defaultShared),this.shared=e,this.plane=arguments.length>=3?n:P.Plane.fromVector3Ds(t[0].pos,t[1].pos,t[2].pos)},P.Polygon.fromObject=function(t){var e=t.vertices.map((function(t){return P.Vertex.fromObject(t)})),n=P.Polygon.Shared.fromObject(t.shared),r=P.Plane.fromObject(t.plane);return new P.Polygon(e,n,r)},P.Polygon.prototype={checkIfConvex:function(){if(!P.Polygon.verticesConvex(this.vertices,this.plane.normal))throw P.Polygon.verticesConvex(this.vertices,this.plane.normal),new Error("Not convex!")},setColor:function(t){var e=P.Polygon.Shared.fromColor.apply(this,arguments);return this.shared=e,this},getSignedVolume:function(){for(var t=0,e=0;e<this.vertices.length-2;e++)t+=this.vertices[0].pos.dot(this.vertices[e+1].pos.cross(this.vertices[e+2].pos));return t/6},getArea:function(){for(var t=0,e=0;e<this.vertices.length-2;e++)t+=this.vertices[e+1].pos.minus(this.vertices[0].pos).cross(this.vertices[e+2].pos.minus(this.vertices[e+1].pos)).length();return t/2},getTetraFeatures:function(t){var e=[];return t.forEach((function(t){"volume"===t?e.push(this.getSignedVolume()):"area"===t&&e.push(this.getArea())}),this),e},extrude:function(t){var e=[],n=this;n.plane.normal.dot(t)>0&&(n=n.flipped()),e.push(n);for(var r=n.translate(t),o=this.vertices.length,i=0;i<o;i++){var a=[],s=i<o-1?i+1:0;a.push(n.vertices[i].pos),a.push(r.vertices[i].pos),a.push(r.vertices[s].pos),a.push(n.vertices[s].pos);var u=P.Polygon.createFromPoints(a,this.shared);e.push(u)}return r=r.flipped(),e.push(r),P.fromPolygons(e)},translate:function(t){return this.transform(P.Matrix4x4.translation(t))},boundingSphere:function(){if(!this.cachedBoundingSphere){var t=this.boundingBox(),e=t[0].plus(t[1]).times(.5),n=t[1].minus(e).length();this.cachedBoundingSphere=[e,n]}return this.cachedBoundingSphere},boundingBox:function(){if(!this.cachedBoundingBox){var t,e,n=this.vertices,r=n.length;e=t=0===r?new P.Vector3D(0,0,0):n[0].pos;for(var o=1;o<r;o++){var i=n[o].pos;t=t.min(i),e=e.max(i)}this.cachedBoundingBox=[t,e]}return this.cachedBoundingBox},flipped:function(){var t=this.vertices.map((function(t){return t.flipped()}));t.reverse();var e=this.plane.flipped();return new P.Polygon(t,this.shared,e)},transform:function(t){var e=this.vertices.map((function(e){return e.transform(t)})),n=this.plane.transform(t);return t.isMirroring()&&e.reverse(),new P.Polygon(e,this.shared,n)},toString:function(){var t="Polygon plane: "+this.plane.toString()+"\n";return this.vertices.map((function(e){t+="  "+e.toString()+"\n"})),t},projectToOrthoNormalBasis:function(t){var e=this.vertices.map((function(e){return t.to2D(e.pos)})),n=_.fromPointsNoCheck(e),r=n.area();return Math.abs(r)<1e-5?n=new _:r<0&&(n=n.flipped()),n},solidFromSlices:function(t){var e,n=[],r=null,o=null,i=null,a=null,s=2,u=!1,l=null;if(t&&(u=Boolean(t.loop),t.numslices&&(s=t.numslices),t.callback&&(e=t.callback)),!e){var c=new P.Polygon.createFromPoints([[0,0,0],[1,0,0],[1,1,0],[0,1,0]]);e=function(t,e){return 0===t||1===t?c.translate([0,0,t]):null}}for(var h=0,p=s-1;h<=p;h++)if(r=e.call(this,h/p,h)){if(!(r instanceof P.Polygon))throw new Error("CSG.Polygon.solidFromSlices callback error: CSG.Polygon expected");r.checkIfConvex(),o?(null===l&&(l=o.plane.signedDistanceToPoint(r.vertices[0].pos)<0),this._addWalls(n,o,r,l)):i=r,o=r}return a=r,u?i.vertices.length===a.vertices.length&&i.vertices.every((function(t,e){return t.pos.equals(a.vertices[e].pos)}))||this._addWalls(n,a,i,l):(n.unshift(l?i:i.flipped()),n.push(l?a.flipped():a)),P.fromPolygons(n)},_addWalls:function(t,e,n,r){var o=e.vertices.slice(0),i=n.vertices.slice(0),a=n.shared||null;o[0].pos.equals(o[o.length-1].pos)||o.push(o[0]),i[0].pos.equals(i[i.length-1].pos)||i.push(i[0]),r&&(o=o.reverse(),i=i.reverse());for(var s,u=i.length-1,l=o.length-1,c=u-l,h=c>0,p=c<0,f=[],d=Math.abs(c);d>0;d--)f.push({len:1/0,index:-1});if(p)for(d=0;d<l;d++){s=o[d].pos.distanceToSquared(o[d+1].pos);for(var v=f.length-1;v>=0;v--)if(f[v].len>s){f[v].len=s,f.index=v;break}}else if(h)for(d=0;d<u;d++)for(s=i[d].pos.distanceToSquared(i[d+1].pos),v=f.length-1;v>=0;v--)if(f[v].len>s){f[v].len=s,f.index=v;break}f.sort(O);for(var m,g=function(t,e,n,r){return new P.Polygon([t,e,n],r)},y=o[0],x=i[0],w=0,b=0,T=u+l;w+b<T;){if(f.length){if(h&&b===f[0].index){m=i[++b],t.push(g(m,x,y,a)),x=m,f.shift();continue}if(p&&w===f[0].index){m=o[++w],t.push(g(x,y,m,a)),y=m,f.shift();continue}}(w<l?x.pos.distanceToSquared(o[w+1].pos):1/0)<=(b<u?y.pos.distanceToSquared(i[b+1].pos):1/0)?(m=o[++w],t.push(g(x,y,m,a)),y=m):b<u&&(m=i[++b],t.push(g(m,x,y,a)),x=m)}return t}},P.Polygon.verticesConvex=function(t,e){var n=t.length;if(n>2)for(var r=t[n-2].pos,o=t[n-1].pos,i=0;i<n;i++){var a=t[i].pos;if(!P.Polygon.isConvexPoint(r,o,a,e))return!1;r=o,o=a}return!0},P.Polygon.createFromPoints=function(t,e,n){arguments.length<3?new P.Vector3D(0,0,0):n.normal;var r=[];return t.map((function(t){var e=new P.Vector3D(t),n=new P.Vertex(e);r.push(n)})),arguments.length<3?new P.Polygon(r,e):new P.Polygon(r,e,n)},P.Polygon.isConvexPoint=function(t,e,n,r){return e.minus(t).cross(n.minus(e)).dot(r)>=0},P.Polygon.isStrictlyConvexPoint=function(t,e,n,r){return e.minus(t).cross(n.minus(e)).dot(r)>=1e-5},P.Polygon.Shared=function(t){if(null!==t&&4!==t.length)throw new Error("Expecting 4 element array");this.color=t},P.Polygon.Shared.fromObject=function(t){return new P.Polygon.Shared(t.color)},P.Polygon.Shared.fromColor=function(t){var e;if(1===arguments.length)e=arguments[0].slice();else{e=[];for(var n=0;n<arguments.length;n++)e.push(arguments[n])}if(3===e.length)e.push(1);else if(4!==e.length)throw new Error("setColor expects either an array with 3 or 4 elements, or 3 or 4 parameters.");return new P.Polygon.Shared(e)},P.Polygon.Shared.prototype={getTag:function(){var t=this.tag;return t||(t=P.getTag(),this.tag=t),t},getHash:function(){return this.color?this.color.join("/"):"null"}},P.Polygon.defaultShared=new P.Polygon.Shared(null),P.PolygonTreeNode=function(){this.parent=null,this.children=[],this.polygon=null,this.removed=!1},P.PolygonTreeNode.prototype={addPolygons:function(t){if(!this.isRootNode())throw new Error("Assertion failed");var e=this;t.map((function(t){e.addChild(t)}))},remove:function(){if(!this.removed){this.removed=!0;var t=this.parent.children,e=t.indexOf(this);if(e<0)throw new Error("Assertion failed");t.splice(e,1),this.parent.recursivelyInvalidatePolygon()}},isRemoved:function(){return this.removed},isRootNode:function(){return!this.parent},invert:function(){if(!this.isRootNode())throw new Error("Assertion failed");this.invertSub()},getPolygon:function(){if(!this.polygon)throw new Error("Assertion failed");return this.polygon},getPolygons:function(t){var e,n,r,o,i=[this],a=[i];for(e=0;e<a.length;++e)for(n=0,r=(i=a[e]).length;n<r;n++)(o=i[n]).polygon?t.push(o.polygon):a.push(o.children)},splitByPlane:function(t,e,n,r,o){if(this.children.length){var i,a,s,u,l,c=[this.children];for(i=0;i<c.length;i++)for(a=0,s=(l=c[i]).length;a<s;a++)(u=l[a]).children.length?c.push(u.children):u._splitByPlane(t,e,n,r,o)}else this._splitByPlane(t,e,n,r,o)},_splitByPlane:function(t,e,n,r,o){var i=this.polygon;if(i){var a=i.boundingSphere(),s=a[1]+1e-4,u=t.normal,l=a[0],c=u.dot(l)-t.w;if(c>s)r.push(this);else if(c<-s)o.push(this);else{var h=t.splitPolygon(i);switch(h.type){case 0:e.push(this);break;case 1:n.push(this);break;case 2:r.push(this);break;case 3:o.push(this);break;case 4:if(h.front){var p=this.addChild(h.front);r.push(p)}if(h.back){var f=this.addChild(h.back);o.push(f)}}}}},addChild:function(t){var e=new P.PolygonTreeNode;return e.parent=this,e.polygon=t,this.children.push(e),e},invertSub:function(){var t,e,n,r,o=[this],i=[o];for(t=0;t<i.length;t++)for(e=0,n=(o=i[t]).length;e<n;e++)(r=o[e]).polygon&&(r.polygon=r.polygon.flipped()),i.push(r.children)},recursivelyInvalidatePolygon:function(){for(var t=this;t.polygon;)t.polygon=null,t.parent&&(t=t.parent)}},P.Tree=function(t){this.polygonTree=new P.PolygonTreeNode,this.rootnode=new P.Node(null),t&&this.addPolygons(t)},P.Tree.prototype={invert:function(){this.polygonTree.invert(),this.rootnode.invert()},clipTo:function(t,e){e=!!e,this.rootnode.clipTo(t,e)},allPolygons:function(){var t=[];return this.polygonTree.getPolygons(t),t},addPolygons:function(t){var e=this,n=t.map((function(t){return e.polygonTree.addChild(t)}));this.rootnode.addPolygonTreeNodes(n)}},P.Node=function(t){this.plane=null,this.front=null,this.back=null,this.polygontreenodes=[],this.parent=t},P.Node.prototype={invert:function(){for(var t,e=[this],n=0;n<e.length;n++){(t=e[n]).plane&&(t.plane=t.plane.flipped()),t.front&&e.push(t.front),t.back&&e.push(t.back);var r=t.front;t.front=t.back,t.back=r}},clipPolygons:function(t,e){var n,r={node:this,polygontreenodes:t},o=[];do{if(n=r.node,t=r.polygontreenodes,n.plane){var i=[],a=[],s=e?i:a,u=n.plane,l=t.length;for(p=0;p<l;p++){var c=t[p];c.isRemoved()||c.splitByPlane(u,s,i,a,i)}n.front&&a.length>0&&o.push({node:n.front,polygontreenodes:a});var h=i.length;if(n.back&&h>0)o.push({node:n.back,polygontreenodes:i});else for(var p=0;p<h;p++)i[p].remove()}r=o.pop()}while(void 0!==r)},clipTo:function(t,e){var n=this,r=[];do{n.polygontreenodes.length>0&&t.rootnode.clipPolygons(n.polygontreenodes,e),n.front&&r.push(n.front),n.back&&r.push(n.back),n=r.pop()}while(void 0!==n)},addPolygonTreeNodes:function(t){var e,n={node:this,polygontreenodes:t},r=[];do{if(e=n.node,0!==(t=n.polygontreenodes).length){var o=e;if(!e.plane){var i=t[0].getPolygon().plane;e.plane=i}for(var a=[],s=[],u=0,l=t.length;u<l;++u)t[u].splitByPlane(o.plane,o.polygontreenodes,s,a,s);a.length>0&&(e.front||(e.front=new P.Node(e)),r.push({node:e.front,polygontreenodes:a})),s.length>0&&(e.back||(e.back=new P.Node(e)),r.push({node:e.back,polygontreenodes:s})),n=r.pop()}else n=r.pop()}while(void 0!==n)},getParentPlaneNormals:function(t,e){e>0&&this.parent&&(t.push(this.parent.plane.normal),this.parent.getParentPlaneNormals(t,e-1))}},P.Matrix4x4=function(t){this.elements=arguments.length>=1?t:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},P.Matrix4x4.prototype={plus:function(t){for(var e=[],n=0;n<16;n++)e[n]=this.elements[n]+t.elements[n];return new P.Matrix4x4(e)},minus:function(t){for(var e=[],n=0;n<16;n++)e[n]=this.elements[n]-t.elements[n];return new P.Matrix4x4(e)},multiply:function(t){var e=this.elements[0],n=this.elements[1],r=this.elements[2],o=this.elements[3],i=this.elements[4],a=this.elements[5],s=this.elements[6],u=this.elements[7],l=this.elements[8],c=this.elements[9],h=this.elements[10],p=this.elements[11],f=this.elements[12],d=this.elements[13],v=this.elements[14],m=this.elements[15],g=t.elements[0],y=t.elements[1],x=t.elements[2],w=t.elements[3],b=t.elements[4],T=t.elements[5],S=t.elements[6],D=t.elements[7],C=t.elements[8],_=t.elements[9],O=t.elements[10],V=t.elements[11],M=t.elements[12],N=t.elements[13],R=t.elements[14],z=t.elements[15],E=[];return E[0]=e*g+n*b+r*C+o*M,E[1]=e*y+n*T+r*_+o*N,E[2]=e*x+n*S+r*O+o*R,E[3]=e*w+n*D+r*V+o*z,E[4]=i*g+a*b+s*C+u*M,E[5]=i*y+a*T+s*_+u*N,E[6]=i*x+a*S+s*O+u*R,E[7]=i*w+a*D+s*V+u*z,E[8]=l*g+c*b+h*C+p*M,E[9]=l*y+c*T+h*_+p*N,E[10]=l*x+c*S+h*O+p*R,E[11]=l*w+c*D+h*V+p*z,E[12]=f*g+d*b+v*C+m*M,E[13]=f*y+d*T+v*_+m*N,E[14]=f*x+d*S+v*O+m*R,E[15]=f*w+d*D+v*V+m*z,new P.Matrix4x4(E)},clone:function(){var t=this.elements.map((function(t){return t}));return new P.Matrix4x4(t)},rightMultiply1x3Vector:function(t){var e=t._x,n=t._y,r=t._z,o=e*this.elements[0]+n*this.elements[1]+r*this.elements[2]+1*this.elements[3],i=e*this.elements[4]+n*this.elements[5]+r*this.elements[6]+1*this.elements[7],a=e*this.elements[8]+n*this.elements[9]+r*this.elements[10]+1*this.elements[11],s=e*this.elements[12]+n*this.elements[13]+r*this.elements[14]+1*this.elements[15];if(1!==s){var u=1/s;o*=u,i*=u,a*=u}return new P.Vector3D(o,i,a)},leftMultiply1x3Vector:function(t){var e=t._x,n=t._y,r=t._z,o=e*this.elements[0]+n*this.elements[4]+r*this.elements[8]+1*this.elements[12],i=e*this.elements[1]+n*this.elements[5]+r*this.elements[9]+1*this.elements[13],a=e*this.elements[2]+n*this.elements[6]+r*this.elements[10]+1*this.elements[14],s=e*this.elements[3]+n*this.elements[7]+r*this.elements[11]+1*this.elements[15];if(1!==s){var u=1/s;o*=u,i*=u,a*=u}return new P.Vector3D(o,i,a)},rightMultiply1x2Vector:function(t){var e=t.x,n=t.y,r=e*this.elements[0]+n*this.elements[1]+0*this.elements[2]+1*this.elements[3],o=e*this.elements[4]+n*this.elements[5]+0*this.elements[6]+1*this.elements[7],i=(this.elements[8],this.elements[9],this.elements[10],this.elements[11],e*this.elements[12]+n*this.elements[13]+0*this.elements[14]+1*this.elements[15]);if(1!==i){var a=1/i;r*=a,o*=a}return new P.Vector2D(r,o)},leftMultiply1x2Vector:function(t){var e=t.x,n=t.y,r=e*this.elements[0]+n*this.elements[4]+0*this.elements[8]+1*this.elements[12],o=e*this.elements[1]+n*this.elements[5]+0*this.elements[9]+1*this.elements[13],i=(this.elements[2],this.elements[6],this.elements[10],this.elements[14],e*this.elements[3]+n*this.elements[7]+0*this.elements[11]+1*this.elements[15]);if(1!==i){var a=1/i;r*=a,o*=a}return new P.Vector2D(r,o)},isMirroring:function(){var t=new P.Vector3D(this.elements[0],this.elements[4],this.elements[8]),e=new P.Vector3D(this.elements[1],this.elements[5],this.elements[9]),n=new P.Vector3D(this.elements[2],this.elements[6],this.elements[10]);return t.cross(e).dot(n)<0}},P.Matrix4x4.unity=function(){return new P.Matrix4x4},P.Matrix4x4.rotationX=function(t){var e=t*Math.PI*(1/180),n=Math.cos(e),r=Math.sin(e),o=[1,0,0,0,0,n,r,0,0,-r,n,0,0,0,0,1];return new P.Matrix4x4(o)},P.Matrix4x4.rotationY=function(t){var e=t*Math.PI*(1/180),n=Math.cos(e),r=Math.sin(e),o=[n,0,-r,0,0,1,0,0,r,0,n,0,0,0,0,1];return new P.Matrix4x4(o)},P.Matrix4x4.rotationZ=function(t){var e=t*Math.PI*(1/180),n=Math.cos(e),r=Math.sin(e),o=[n,r,0,0,-r,n,0,0,0,0,1,0,0,0,0,1];return new P.Matrix4x4(o)},P.Matrix4x4.rotation=function(t,e,n){t=new P.Vector3D(t),e=new P.Vector3D(e);var r=P.Plane.fromNormalAndPoint(e,t),o=new P.OrthoNormalBasis(r),i=P.Matrix4x4.translation(t.negated());return(i=(i=(i=i.multiply(o.getProjectionMatrix())).multiply(P.Matrix4x4.rotationZ(n))).multiply(o.getInverseProjectionMatrix())).multiply(P.Matrix4x4.translation(t))},P.Matrix4x4.translation=function(t){var e=new P.Vector3D(t),n=[1,0,0,0,0,1,0,0,0,0,1,0,e.x,e.y,e.z,1];return new P.Matrix4x4(n)},P.Matrix4x4.mirroring=function(t){var e=t.normal.x,n=t.normal.y,r=t.normal.z,o=t.w,i=[1-2*e*e,-2*n*e,-2*r*e,0,-2*e*n,1-2*n*n,-2*r*n,0,-2*e*r,-2*n*r,1-2*r*r,0,2*e*o,2*n*o,2*r*o,1];return new P.Matrix4x4(i)},P.Matrix4x4.scaling=function(t){var e=new P.Vector3D(t),n=[e.x,0,0,0,0,e.y,0,0,0,0,e.z,0,0,0,0,1];return new P.Matrix4x4(n)},P.Vector2D=function(t,e){if(2===arguments.length)this._x=parseFloat(t),this._y=parseFloat(e);else{var n=!0;if(1===arguments.length)if("object"===S(t))t instanceof P.Vector2D?(this._x=t._x,this._y=t._y):t instanceof Array?(this._x=parseFloat(t[0]),this._y=parseFloat(t[1])):"x"in t&&"y"in t?(this._x=parseFloat(t.x),this._y=parseFloat(t.y)):n=!1;else{var r=parseFloat(t);this._x=r,this._y=r}else n=!1;if(n&&(P.IsFloat(this._x)&&P.IsFloat(this._y)||(n=!1)),!n)throw new Error("wrong arguments")}},P.Vector2D.fromAngle=function(t){return P.Vector2D.fromAngleRadians(t)},P.Vector2D.fromAngleDegrees=function(t){var e=Math.PI*t/180;return P.Vector2D.fromAngleRadians(e)},P.Vector2D.fromAngleRadians=function(t){return P.Vector2D.Create(Math.cos(t),Math.sin(t))},P.Vector2D.Create=function(t,e){var n=Object.create(P.Vector2D.prototype);return n._x=t,n._y=e,n},P.Vector2D.prototype={get x(){return this._x},get y(){return this._y},set x(t){throw new Error("Vector2D is immutable")},set y(t){throw new Error("Vector2D is immutable")},toVector3D:function(t){return new P.Vector3D(this._x,this._y,t)},equals:function(t){return this._x===t._x&&this._y===t._y},clone:function(){return P.Vector2D.Create(this._x,this._y)},negated:function(){return P.Vector2D.Create(-this._x,-this._y)},plus:function(t){return P.Vector2D.Create(this._x+t._x,this._y+t._y)},minus:function(t){return P.Vector2D.Create(this._x-t._x,this._y-t._y)},times:function(t){return P.Vector2D.Create(this._x*t,this._y*t)},dividedBy:function(t){return P.Vector2D.Create(this._x/t,this._y/t)},dot:function(t){return this._x*t._x+this._y*t._y},lerp:function(t,e){return this.plus(t.minus(this).times(e))},length:function(){return Math.sqrt(this.dot(this))},distanceTo:function(t){return this.minus(t).length()},distanceToSquared:function(t){return this.minus(t).lengthSquared()},lengthSquared:function(){return this.dot(this)},unit:function(){return this.dividedBy(this.length())},cross:function(t){return this._x*t._y-this._y*t._x},normal:function(){return P.Vector2D.Create(this._y,-this._x)},multiply4x4:function(t){return t.leftMultiply1x2Vector(this)},transform:function(t){return t.leftMultiply1x2Vector(this)},angle:function(){return this.angleRadians()},angleDegrees:function(){return 180*this.angleRadians()/Math.PI},angleRadians:function(){return Math.atan2(this._y,this._x)},min:function(t){return P.Vector2D.Create(Math.min(this._x,t._x),Math.min(this._y,t._y))},max:function(t){return P.Vector2D.Create(Math.max(this._x,t._x),Math.max(this._y,t._y))},toString:function(){return"("+this._x.toFixed(2)+", "+this._y.toFixed(2)+")"},abs:function(){return P.Vector2D.Create(Math.abs(this._x),Math.abs(this._y))}},P.Line2D=function(t,e){t=new P.Vector2D(t),e=parseFloat(e);var n=t.length();e*=n,t=t.times(1/n),this.normal=t,this.w=e},P.Line2D.fromPoints=function(t,e){t=new P.Vector2D(t);var n=(e=new P.Vector2D(e)).minus(t).normal().negated().unit(),r=t.dot(n);return new P.Line2D(n,r)},P.Line2D.prototype={reverse:function(){return new P.Line2D(this.normal.negated(),-this.w)},equals:function(t){return t.normal.equals(this.normal)&&t.w===this.w},origin:function(){return this.normal.times(this.w)},direction:function(){return this.normal.normal()},xAtY:function(t){return(this.w-this.normal._y*t)/this.normal.x},absDistanceToPoint:function(t){var e=(t=new P.Vector2D(t)).dot(this.normal);return Math.abs(e-this.w)},intersectWithLine:function(t){var e=P.solve2Linear(this.normal.x,this.normal.y,t.normal.x,t.normal.y,this.w,t.w);return new P.Vector2D(e)},transform:function(t){var e=new P.Vector2D(0,0),n=this.normal.times(this.w),r=e.multiply4x4(t),o=this.normal.multiply4x4(t).minus(r),i=n.multiply4x4(t),a=o.dot(i);return new P.Line2D(o,a)}},P.Line3D=function(t,e){t=new P.Vector3D(t),e=new P.Vector3D(e),this.point=t,this.direction=e.unit()},P.Line3D.fromPoints=function(t,e){t=new P.Vector3D(t);var n=(e=new P.Vector3D(e)).minus(t);return new P.Line3D(t,n)},P.Line3D.fromPlanes=function(t,e){var n=t.normal.cross(e.normal),r=n.length();if(r<1e-10)throw new Error("Parallel planes");n=n.times(1/r);var o,i=Math.abs(n.x),a=Math.abs(n.y),s=Math.abs(n.z);if(i>=a&&i>=s){var u=P.solve2Linear(t.normal.y,t.normal.z,e.normal.y,e.normal.z,t.w,e.w);o=new P.Vector3D(0,u[0],u[1])}else a>=i&&a>=s?(u=P.solve2Linear(t.normal.x,t.normal.z,e.normal.x,e.normal.z,t.w,e.w),o=new P.Vector3D(u[0],0,u[1])):(u=P.solve2Linear(t.normal.x,t.normal.y,e.normal.x,e.normal.y,t.w,e.w),o=new P.Vector3D(u[0],u[1],0));return new P.Line3D(o,n)},P.Line3D.prototype={intersectWithPlane:function(t){var e=(t.w-t.normal.dot(this.point))/t.normal.dot(this.direction);return this.point.plus(this.direction.times(e))},clone:function(t){return new P.Line3D(this.point.clone(),this.direction.clone())},reverse:function(){return new P.Line3D(this.point.clone(),this.direction.negated())},transform:function(t){var e=this.point.multiply4x4(t),n=this.point.plus(this.direction).multiply4x4(t).minus(e);return new P.Line3D(e,n)},closestPointOnLine:function(t){var e=(t=new P.Vector3D(t)).minus(this.point).dot(this.direction)/this.direction.dot(this.direction);return this.point.plus(this.direction.times(e))},distanceToPoint:function(t){t=new P.Vector3D(t);var e=this.closestPointOnLine(t);return t.minus(e).length()},equals:function(t){return!(!this.direction.equals(t.direction)||this.distanceToPoint(t.point)>1e-8)}},P.OrthoNormalBasis=function(t,e){e=arguments.length<2?t.normal.randomNonParallelVector():new P.Vector3D(e),this.v=t.normal.cross(e).unit(),this.u=this.v.cross(t.normal),this.plane=t,this.planeorigin=t.normal.times(t.w)},P.OrthoNormalBasis.GetCartesian=function(t,e){var n,r,o=t+"/"+e;if("X/Y"===o)n=[0,0,1],r=[1,0,0];else if("Y/-X"===o)n=[0,0,1],r=[0,1,0];else if("-X/-Y"===o)n=[0,0,1],r=[-1,0,0];else if("-Y/X"===o)n=[0,0,1],r=[0,-1,0];else if("-X/Y"===o)n=[0,0,-1],r=[-1,0,0];else if("-Y/-X"===o)n=[0,0,-1],r=[0,-1,0];else if("X/-Y"===o)n=[0,0,-1],r=[1,0,0];else if("Y/X"===o)n=[0,0,-1],r=[0,1,0];else if("X/Z"===o)n=[0,-1,0],r=[1,0,0];else if("Z/-X"===o)n=[0,-1,0],r=[0,0,1];else if("-X/-Z"===o)n=[0,-1,0],r=[-1,0,0];else if("-Z/X"===o)n=[0,-1,0],r=[0,0,-1];else if("-X/Z"===o)n=[0,1,0],r=[-1,0,0];else if("-Z/-X"===o)n=[0,1,0],r=[0,0,-1];else if("X/-Z"===o)n=[0,1,0],r=[1,0,0];else if("Z/X"===o)n=[0,1,0],r=[0,0,1];else if("Y/Z"===o)n=[1,0,0],r=[0,1,0];else if("Z/-Y"===o)n=[1,0,0],r=[0,0,1];else if("-Y/-Z"===o)n=[1,0,0],r=[0,-1,0];else if("-Z/Y"===o)n=[1,0,0],r=[0,0,-1];else if("-Y/Z"===o)n=[-1,0,0],r=[0,-1,0];else if("-Z/-Y"===o)n=[-1,0,0],r=[0,0,-1];else if("Y/-Z"===o)n=[-1,0,0],r=[0,1,0];else{if("Z/Y"!==o)throw new Error("CSG.OrthoNormalBasis.GetCartesian: invalid combination of axis identifiers. Should pass two string arguments from [X,Y,Z,-X,-Y,-Z], being two different axes.");n=[-1,0,0],r=[0,0,1]}return new P.OrthoNormalBasis(new P.Plane(new P.Vector3D(n),0),new P.Vector3D(r))},P.OrthoNormalBasis.Z0Plane=function(){var t=new P.Plane(new P.Vector3D([0,0,1]),0);return new P.OrthoNormalBasis(t,new P.Vector3D([1,0,0]))},P.OrthoNormalBasis.prototype={getProjectionMatrix:function(){return new P.Matrix4x4([this.u.x,this.v.x,this.plane.normal.x,0,this.u.y,this.v.y,this.plane.normal.y,0,this.u.z,this.v.z,this.plane.normal.z,0,0,0,-this.plane.w,1])},getInverseProjectionMatrix:function(){var t=this.plane.normal.times(this.plane.w);return new P.Matrix4x4([this.u.x,this.u.y,this.u.z,0,this.v.x,this.v.y,this.v.z,0,this.plane.normal.x,this.plane.normal.y,this.plane.normal.z,0,t.x,t.y,t.z,1])},to2D:function(t){return new P.Vector2D(t.dot(this.u),t.dot(this.v))},to3D:function(t){return this.planeorigin.plus(this.u.times(t.x)).plus(this.v.times(t.y))},line3Dto2D:function(t){var e=t.point,n=t.direction.plus(e),r=this.to2D(e),o=this.to2D(n);return P.Line2D.fromPoints(r,o)},line2Dto3D:function(t){var e=t.origin(),n=t.direction().plus(e),r=this.to3D(e),o=this.to3D(n);return P.Line3D.fromPoints(r,o)},transform:function(t){var e=this.plane.transform(t),n=this.u.transform(t),r=new P.Vector3D(0,0,0).transform(t),o=n.minus(r);return new P.OrthoNormalBasis(e,o)}},P.interpolateBetween2DPointsForY=function(t,e,n){var r,o=n-t.y,i=e.y-t.y;return i<0&&(o=-o,i=-i),r=o<=0?0:o>=i?1:i<1e-10?.5:o/i,t.x+r*(e.x-t.x)},P.reTesselateCoplanarPolygons=function(t,e){var n=1e-5,r=t.length;if(r>0){for(var o=t[0].plane,i=t[0].shared,a=new P.OrthoNormalBasis(o),s=[],u=[],l={},c={},h={},p=0;p<r;p++){var f=t[p],d=[],v=-1;if((A=f.vertices.length)>0){for(var m,g,y=0;y<A;y++){var x,w=a.to2D(f.vertices[y].pos),b=Math.floor(999999.9999999999*w.y);b in h?x=h[b]:b+1 in h?x=h[b+1]:b-1 in h?x=h[b-1]:(x=w.y,h[b]=w.y),w=P.Vector2D.Create(w.x,x),d.push(w);var T=w.y;(0===y||T<m)&&(m=T,v=y),(0===y||T>g)&&(g=T),T in c||(c[T]={}),c[T][p]=!0}m>=g?(d=[],A=0,v=-1):(m in l||(l[m]=[]),l[m].push(p))}d.reverse(),v=A-v-1,s.push(d),u.push(v)}var S=[];for(var _ in c)S.push(_);S.sort(D);for(var O=[],V=[],M=0;M<S.length;M++){for(var N,R=[],z=S[M],E=(_=Number(z),c[z]),L=0;L<O.length;++L)if(E[p=(Z=O[L]).polygonindex]){for(var A=(d=s[p]).length,F=Z.leftvertexindex,I=Z.rightvertexindex;(q=F+1)>=A&&(q=0),d[q].y===_;)F=q;(X=I-1)<0&&(X=A-1),d[X].y===_&&(I=X),F!==Z.leftvertexindex&&F===I?(O.splice(L,1),--L):(Z.leftvertexindex=F,Z.rightvertexindex=I,Z.topleft=d[F],Z.topright=d[I],(q=F+1)>=A&&(q=0),Z.bottomleft=d[q],(X=I-1)<0&&(X=A-1),Z.bottomright=d[X])}if(M>=S.length-1)O=[],N=null;else{var B=.5*(_+(N=Number(S[M+1]))),k=l[z];for(var j in k){A=(d=s[p=k[j]]).length;for(var U=u[p],G=U;((y=G+1)>=A&&(y=0),d[y].y===_)&&y!==U;)G=y;for(var J=U;((y=J-1)<0&&(y=A-1),d[y].y===_)&&y!==G;)J=y;var q,X;(q=G+1)>=A&&(q=0),(X=J-1)<0&&(X=A-1),C(O,{polygonindex:p,leftvertexindex:G,rightvertexindex:J,topleft:d[G],topright:d[J],bottomleft:d[q],bottomright:d[X]},(function(t,e){var n=P.interpolateBetween2DPointsForY(t.topleft,t.bottomleft,B),r=P.interpolateBetween2DPointsForY(e.topleft,e.bottomleft,B);return n>r?1:n<r?-1:0}))}}for(var Y in O){A=(d=s[p=(Z=O[Y]).polygonindex]).length;var Z,W=P.interpolateBetween2DPointsForY(Z.topleft,Z.bottomleft,_),H=P.Vector2D.Create(W,_);W=P.interpolateBetween2DPointsForY(Z.topright,Z.bottomright,_);var K=P.Vector2D.Create(W,_);W=P.interpolateBetween2DPointsForY(Z.topleft,Z.bottomleft,N);var Q=P.Vector2D.Create(W,N);W=P.interpolateBetween2DPointsForY(Z.topright,Z.bottomright,N);var $=P.Vector2D.Create(W,N),tt={topleft:H,topright:K,bottomleft:Q,bottomright:$,leftline:P.Line2D.fromPoints(H,Q),rightline:P.Line2D.fromPoints($,K)};if(R.length>0){var et=R[R.length-1],nt=tt.topleft.distanceTo(et.topright),rt=tt.bottomleft.distanceTo(et.bottomright);nt<n&&rt<n&&(tt.topleft=et.topleft,tt.leftline=et.leftline,tt.bottomleft=et.bottomleft,R.splice(R.length-1,1))}R.push(tt)}if(M>0){var ot={},it={};for(y=0;y<R.length;y++)for(var at=R[y],st=0;st<V.length;st++)if(!it[st]&&(ct=V[st]).bottomleft.distanceTo(at.topleft)<n&&ct.bottomright.distanceTo(at.topright)<n){it[st]=!0,nt=at.leftline.direction().x-ct.leftline.direction().x,rt=at.rightline.direction().x-ct.rightline.direction().x;var ut=Math.abs(nt)<n,lt=Math.abs(rt)<n;(ut||nt>=0)&&(lt||rt>=0)&&(at.outpolygon=ct.outpolygon,at.leftlinecontinues=ut,at.rightlinecontinues=lt,ot[st]=!0);break}for(st=0;st<V.length;st++)if(!ot[st]){var ct;(ct=V[st]).outpolygon.rightpoints.push(ct.bottomright),ct.bottomright.distanceTo(ct.bottomleft)>n&&ct.outpolygon.leftpoints.push(ct.bottomleft),ct.outpolygon.leftpoints.reverse();var ht=ct.outpolygon.rightpoints.concat(ct.outpolygon.leftpoints),pt=[];ht.map((function(t){var e=a.to3D(t),n=new P.Vertex(e);pt.push(n)}));var ft=new P.Polygon(pt,i,o);e.push(ft)}}for(y=0;y<R.length;y++)(at=R[y]).outpolygon?(at.leftlinecontinues||at.outpolygon.leftpoints.push(at.topleft),at.rightlinecontinues||at.outpolygon.rightpoints.push(at.topright)):(at.outpolygon={leftpoints:[],rightpoints:[]},at.outpolygon.leftpoints.push(at.topleft),at.topleft.distanceTo(at.topright)>n&&at.outpolygon.rightpoints.push(at.topright));V=R}}},P.fuzzyFactory=function(t,e){this.lookuptable={},this.multiplier=1/e},P.fuzzyFactory.prototype={lookupOrCreate:function(t,e){var n="",r=this.multiplier;if(t.forEach((function(t){var e=Math.round(t*r);n+=e+"/"})),n in this.lookuptable)return this.lookuptable[n];for(var o=e(t),i=t.map((function(t){var e=Math.floor(t*r);return[e+"/",e+1+"/"]})),a=1<<t.length,s=0;s<a;++s){var u=s;n="",i.forEach((function(t){n+=t[1&u],u>>=1})),this.lookuptable[n]=o}return o}},P.fuzzyCSGFactory=function(){this.vertexfactory=new P.fuzzyFactory(3,1e-5),this.planefactory=new P.fuzzyFactory(4,1e-5),this.polygonsharedfactory={}},P.fuzzyCSGFactory.prototype={getPolygonShared:function(t){var e=t.getHash();return e in this.polygonsharedfactory?this.polygonsharedfactory[e]:(this.polygonsharedfactory[e]=t,t)},getVertex:function(t){var e=[t.pos._x,t.pos._y,t.pos._z];return this.vertexfactory.lookupOrCreate(e,(function(e){return t}))},getPlane:function(t){var e=[t.normal._x,t.normal._y,t.normal._z,t.w];return this.planefactory.lookupOrCreate(e,(function(e){return t}))},getPolygon:function(t){var e=this.getPlane(t.plane),n=this.getPolygonShared(t.shared),r=this,o=t.vertices.map((function(t){return r.getVertex(t)})),i=[];if(o.length>0){var a=o[o.length-1].getTag();o.forEach((function(t){var e=t.getTag();e!==a&&i.push(t),a=e}))}return i.length<3&&(i=[]),new P.Polygon(i,n,e)},getCSG:function(t){var e=this,n=[];return t.polygons.forEach((function(t){var r=e.getPolygon(t);r.vertices.length>=3&&n.push(r)})),P.fromPolygons(n)}},P.staticTag=1,P.getTag=function(){return P.staticTag++},P.Properties=function(){},P.Properties.prototype={_transform:function(t){var e=new P.Properties;return P.Properties.transformObj(this,e,t),e},_merge:function(t){var e=new P.Properties;return P.Properties.cloneObj(this,e),P.Properties.addFrom(e,t),e}},P.Properties.transformObj=function(t,e,n){for(var r in t)if("_transform"!==r&&"_merge"!==r){var o=t[r],i=o;"object"===S(o)&&("transform"in o&&"function"==typeof o.transform?i=o.transform(n):o instanceof Array?(i=[],P.Properties.transformObj(o,i,n)):o instanceof P.Properties&&(i=new P.Properties,P.Properties.transformObj(o,i,n))),e[r]=i}},P.Properties.cloneObj=function(t,e){for(var n in t)if("_transform"!==n&&"_merge"!==n){var r=t[n],o=r;if("object"===S(r))if(r instanceof Array){o=[];for(var i=0;i<r.length;i++)o.push(r[i])}else r instanceof P.Properties&&(o=new P.Properties,P.Properties.cloneObj(r,o));e[n]=o}},P.Properties.addFrom=function(t,e){for(var n in e)"_transform"!==n&&"_merge"!==n&&(n in t&&"object"===S(t[n])&&t[n]instanceof P.Properties&&"object"===S(e[n])&&e[n]instanceof P.Properties?P.Properties.addFrom(t[n],e[n]):n in t||(t[n]=e[n]))},P.Connector=function(t,e,n){this.point=new P.Vector3D(t),this.axisvector=new P.Vector3D(e).unit(),this.normalvector=new P.Vector3D(n).unit()},P.Connector.prototype={normalized:function(){var t=this.axisvector.unit(),e=this.normalvector.cross(t).unit(),n=t.cross(e);return new P.Connector(this.point,t,n)},transform:function(t){var e=this.point.multiply4x4(t),n=this.point.plus(this.axisvector).multiply4x4(t).minus(e),r=this.point.plus(this.normalvector).multiply4x4(t).minus(e);return new P.Connector(e,n,r)},getTransformationTo:function(t,e,n){e=!!e,n=n?Number(n):0;var r=this.normalized();t=t.normalized();var o=P.Matrix4x4.translation(this.point.negated()),i=P.Plane.anyPlaneFromVector3Ds(new P.Vector3D(0,0,0),r.axisvector,t.axisvector),a=new P.OrthoNormalBasis(i),s=a.to2D(r.axisvector).angle(),u=a.to2D(t.axisvector).angle(),l=180*(u-s)/Math.PI;e&&(l+=180),o=(o=(o=o.multiply(a.getProjectionMatrix())).multiply(P.Matrix4x4.rotationZ(l))).multiply(a.getInverseProjectionMatrix());var c=r.transform(o),h=P.Plane.fromNormalAndPoint(t.axisvector,new P.Vector3D(0,0,0)),p=new P.OrthoNormalBasis(h);return s=p.to2D(c.normalvector).angle(),l=180*((u=p.to2D(t.normalvector).angle())-s)/Math.PI,l+=n,(o=(o=(o=o.multiply(p.getProjectionMatrix())).multiply(P.Matrix4x4.rotationZ(l))).multiply(p.getInverseProjectionMatrix())).multiply(P.Matrix4x4.translation(t.point))},axisLine:function(){return new P.Line3D(this.point,this.axisvector)},extend:function(t){var e=this.point.plus(this.axisvector.unit().times(t));return new P.Connector(e,this.axisvector,this.normalvector)}},P.ConnectorList=function(t){this.connectors_=t?t.slice():[]},P.ConnectorList.defaultNormal=[0,0,1],P.ConnectorList.fromPath2D=function(t,e,n){if(3===arguments.length)return P.ConnectorList._fromPath2DTangents(t,e,n);if(2===arguments.length)return P.ConnectorList._fromPath2DExplicit(t,e);throw"call with path2D and either 2 direction vectors, or a function returning direction vectors"},P.ConnectorList._fromPath2DTangents=function(t,e,n){var r,o=t.points.length,i=new P.ConnectorList([new P.Connector(t.points[0],e,P.ConnectorList.defaultNormal)]);return t.points.slice(1,o-1).forEach((function(e,n){r=t.points[n+2].minus(t.points[n]).toVector3D(0),i.appendConnector(new P.Connector(e.toVector3D(0),r,P.ConnectorList.defaultNormal))}),this),i.appendConnector(new P.Connector(t.points[o-1],n,P.ConnectorList.defaultNormal)),i.closed=t.closed,i},P.ConnectorList._fromPath2DExplicit=function(t,e){var n=new P.ConnectorList(t.points.map((function(t,n){return new P.Connector(t.toVector3D(0),P.Vector3D.Create(1,0,0).rotateZ(function(t,e,n){return"function"==typeof t&&(t=t(e,n)),t}(e,t,n)),P.ConnectorList.defaultNormal)}),this));return n.closed=t.closed,n},P.ConnectorList.prototype={setClosed:function(t){this.closed=!!closed},appendConnector:function(t){this.connectors_.push(t)},followWith:function(t){function e(t,e){return"function"==typeof t&&(t=t(e.point,e.axisvector,e.normalvector)),t}this.verify();var n,r=[],o=this.connectors_[this.connectors_.length-1],i=e(t,o);return this.connectors_.forEach((function(a,s){n=e(t,a),s||this.closed?r.push.apply(r,i._toWallPolygons({toConnector1:o,toConnector2:a,cag:n})):r.push.apply(r,n._toPlanePolygons({toConnector:a,flipped:!0})),s!==this.connectors_.length-1||this.closed||r.push.apply(r,n._toPlanePolygons({toConnector:a})),i=n,o=a}),this),P.fromPolygons(r).reTesselated().canonicalized()},verify:function(){for(var t,e,n=0;n<this.connectors_.length-1;n++){if(t=this.connectors_[n],(e=this.connectors_[n+1]).point.minus(t.point).dot(t.axisvector)<=0)throw"Invalid ConnectorList. Each connectors position needs to be within a <90deg range of previous connectors axisvector";if(t.axisvector.dot(e.axisvector)<=0)throw"invalid ConnectorList. No neighboring connectors axisvectors may span a >=90deg angle"}}},P.Path2D=function(t,e){t=t||[];var n=null;(e=!!e)&&t.length>0&&(n=new P.Vector2D(t[t.length-1]));var r=[];t.map((function(t){t=new P.Vector2D(t);var e=!1;null!==n&&(e=t.distanceTo(n)<1e-5),e||r.push(t),n=t})),this.points=r,this.closed=e},P.Path2D.arc=function(t){for(var e=P.parseOptionAs2DVector(t,"center",0),n=P.parseOptionAsFloat(t,"radius",1),r=P.parseOptionAsFloat(t,"startangle",0),o=P.parseOptionAsFloat(t,"endangle",360),i=P.parseOptionAsInt(t,"resolution",P.defaultResolution2D),a=P.parseOptionAsBool(t,"maketangent",!1);o-r>=720;)o-=360;for(;o-r<=-720;)o+=360;var s,u=[],l=Math.abs(o-r);if(l<1e-5)s=P.Vector2D.fromAngle(r/180*Math.PI).times(n),u.push(s.plus(e));else{var c=Math.floor(i*l/360)+1,h=.5*c/l;h>.25&&(h=.25);for(var p=a?c+2:c,f=0;f<=p;f++){var d=f;a&&((d=(f-1)*(c-2*h)/c+h)<0&&(d=0),d>c&&(d=c));var v=r+d*(o-r)/c;s=P.Vector2D.fromAngle(v/180*Math.PI).times(n),u.push(s.plus(e))}}return new P.Path2D(u,!1)},P.Path2D.prototype={concat:function(t){if(this.closed||t.closed)throw new Error("Paths must not be closed");var e=this.points.concat(t.points);return new P.Path2D(e)},appendPoint:function(t){if(this.closed)throw new Error("Path must not be closed");t=new P.Vector2D(t);var e=this.points.concat([t]);return new P.Path2D(e)},appendPoints:function(t){if(this.closed)throw new Error("Path must not be closed");var e=this.points;return t.forEach((function(t){e.push(new P.Vector2D(t))})),new P.Path2D(e)},close:function(){return new P.Path2D(this.points,!0)},rectangularExtrude:function(t,e,n){return this.expandToCAG(t/2,n).extrude({offset:[0,0,e]})},expandToCAG:function(t,e){var n,r=[],o=this.points.length,i=0;this.closed&&o>2&&(i=-1);for(var a=i;a<o;a++){var s=a;s<0&&(s=o-1);var u=this.points[s],l=new _.Vertex(u);if(a>i){var c=new _.Side(n,l);r.push(c)}n=l}return _.fromSides(r).expandedShell(t,e)},innerToCAG:function(){if(!this.closed)throw new Error("The path should be closed!");return _.fromPoints(this.points)},transform:function(t){var e=this.points.map((function(e){return e.multiply4x4(t)}));return new P.Path2D(e,this.closed)},appendBezier:function(t,e){if(arguments.length<2&&(e={}),this.closed)throw new Error("Path must not be closed");if(!(t instanceof Array))throw new Error("appendBezier: should pass an array of control points");if(t.length<1)throw new Error("appendBezier: need at least 1 control point");if(this.points.length<1)throw new Error("appendBezier: path must already contain a point (the endpoint of the path is used as the starting point for the bezier curve)");var n=P.parseOptionAsInt(e,"resolution",P.defaultResolution2D);n<4&&(n=4);var r=[],o=[];o.push(this.points[this.points.length-1]);for(var i=0;i<t.length;++i){var a=t[i];if(null===a){if(0!==i)throw new Error("appendBezier: null can only be passed as the first control point");if(t.length<2)throw new Error("appendBezier: null can only be passed if there is at least one more control point");var s;if("lastBezierControlPoint"in this)s=this.lastBezierControlPoint;else{if(this.points.length<2)throw new Error("appendBezier: null is passed as a control point but this requires a previous bezier curve or at least two points in the existing path");s=this.points[this.points.length-2]}a=this.points[this.points.length-1].times(2).minus(s)}else a=new P.Vector2D(a);o.push(a)}var u=o.length-1,l=1;for(i=0;i<=u;++i)i>0&&(l*=i),r.push(l);var c=[];for(i=0;i<=u;++i){var h=r[u]/(r[i]*r[u-i]);c.push(h)}var p=function(t){for(var e=1,n=Math.pow(1-t,u),r=1!==t?1/(1-t):1,i=new P.Vector2D(0,0),a=0;a<=u;++a){a===u&&(n=1);var s=c[a]*e*n;i=i.plus(o[a].times(s)),e*=t,n*=r}return i},f=[],d=[],v=u+1;for(i=0;i<v;++i){var m=i/(v-1),g=p(m);f.push(g),d.push(m)}for(var y=1,x=2*Math.PI/n,w=Math.sin(x);y<f.length-1;){var b=f[y].minus(f[y-1]).unit(),T=f[y+1].minus(f[y]).unit(),S=b.cross(T);if(Math.abs(S)>w){var D=d[y-1],C=d[y+1],_=D+1*(C-D)/3,O=D+2*(C-D)/3,V=p(_),M=p(O);f.splice(y,1,V,M),d.splice(y,1,_,O),--y<1&&(y=1)}else++y}f=this.points.concat(f.slice(1));var N=new P.Path2D(f);return N.lastBezierControlPoint=o[o.length-2],N},appendArc:function(t,e){var n=1e5;if(arguments.length<2&&(e={}),this.closed)throw new Error("Path must not be closed");if(this.points.length<1)throw new Error("appendArc: path must already contain a point (the endpoint of the path is used as the starting point for the arc)");var r,o,i=P.parseOptionAsInt(e,"resolution",P.defaultResolution2D);if(i<4&&(i=4),"xradius"in e||"yradius"in e){if("radius"in e)throw new Error("Should either give an xradius and yradius parameter, or a radius parameter");r=P.parseOptionAsFloat(e,"xradius",0),o=P.parseOptionAsFloat(e,"yradius",0)}else o=r=P.parseOptionAsFloat(e,"radius",0);var a=P.parseOptionAsFloat(e,"xaxisrotation",0),s=P.parseOptionAsBool(e,"clockwise",!1),u=P.parseOptionAsBool(e,"large",!1),l=this.points[this.points.length-1];t=new P.Vector2D(t),r=Math.round(r*n)/n,o=Math.round(o*n)/n,t=new P.Vector2D(Math.round(t.x*n)/n,Math.round(t.y*n)/n);var c=!s,h=[];if(0===r||0===o)h.push(t);else{r=Math.abs(r),o=Math.abs(o);var p=a*Math.PI/180,f=Math.cos(p),d=Math.sin(p),v=l.minus(t).times(.5),m=Math.round((f*v.x+d*v.y)*n)/n,g=Math.round((-d*v.x+f*v.y)*n)/n,y=new P.Vector2D(m,g),x=y.x*y.x/(r*r)+y.y*y.y/(o*o);if(x>1){var w=Math.sqrt(x);r*=w,o*=w,r=Math.round(r*n)/n,o=Math.round(o*n)/n}var b=Math.sqrt((r*r*o*o-r*r*y.y*y.y-o*o*y.x*y.x)/(r*r*y.y*y.y+o*o*y.x*y.x));c===u&&(b=-b);var T=new P.Vector2D(r*y.y/o,-o*y.x/r).times(b),S=new P.Vector2D(f*T.x-d*T.y,d*T.x+f*T.y).plus(l.plus(t).times(.5)),D=new P.Vector2D((y.x-T.x)/r,(y.y-T.y)/o),C=new P.Vector2D((-y.x-T.x)/r,(-y.y-T.y)/o),_=D.angleRadians(),O=C.angleRadians(),V=O-_;V%=2*Math.PI,!c&&V>0?V-=2*Math.PI:c&&V<0&&(V+=2*Math.PI);var M=Math.ceil(Math.abs(V)/(2*Math.PI)*i)+1;M<1&&(M=1);for(var N=1;N<=M;N++){var R=_+N/M*V,z=Math.cos(R),E=Math.sin(R),L=new P.Vector2D(f*r*z-d*o*E,d*r*z+f*o*E).plus(S);h.push(L)}}h=this.points.concat(h);var A=new P.Path2D(h);return A}},P.addTransformationMethodsToPrototype=function(t){t.mirrored=function(t){return this.transform(P.Matrix4x4.mirroring(t))},t.mirroredX=function(){var t=new P.Plane(P.Vector3D.Create(1,0,0),0);return this.mirrored(t)},t.mirroredY=function(){var t=new P.Plane(P.Vector3D.Create(0,1,0),0);return this.mirrored(t)},t.mirroredZ=function(){var t=new P.Plane(P.Vector3D.Create(0,0,1),0);return this.mirrored(t)},t.translate=function(t){return this.transform(P.Matrix4x4.translation(t))},t.scale=function(t){return this.transform(P.Matrix4x4.scaling(t))},t.rotateX=function(t){return this.transform(P.Matrix4x4.rotationX(t))},t.rotateY=function(t){return this.transform(P.Matrix4x4.rotationY(t))},t.rotateZ=function(t){return this.transform(P.Matrix4x4.rotationZ(t))},t.rotate=function(t,e,n){return this.transform(P.Matrix4x4.rotation(t,e,n))},t.rotateEulerAngles=function(t,e,n,r){r=r||[0,0,0];var o=P.Matrix4x4.rotationZ(t),i=P.Matrix4x4.rotationX(e),a=P.Matrix4x4.rotationZ(n),s=P.Matrix4x4.translation(new P.Vector3D(r));return this.transform(a.multiply(i).multiply(o).multiply(s))}},P.addCenteringToPrototype=function(t,e){t.center=function(t){(t=Array.prototype.map.call(arguments,(function(t){return t.toLowerCase()}))).length||(t=e.slice());var n=this.getBounds();return this.translate(e.map((function(e){return t.indexOf(e)>-1?-(n[0][e]+n[1][e])/2:0})))}};var _=function(){this.sides=[]};function O(t,e){return t.index-e.index}_.fromSides=function(t){var e=new _;return e.sides=t,e},_.fromPoints=function(t){var e=t.length;if(e<3)throw new Error("CAG shape needs at least 3 points");var n=[],r=new P.Vector2D(t[e-1]),o=new _.Vertex(r);t.map((function(t){var e=new P.Vector2D(t),r=new _.Vertex(e),i=new _.Side(o,r);n.push(i),o=r}));var i=_.fromSides(n);if(i.isSelfIntersecting())throw new Error("Polygon is self intersecting!");var a=i.area();if(Math.abs(a)<1e-5)throw new Error("Degenerate polygon!");return a<0&&(i=i.flipped()),i.canonicalized()},_.fromPointsNoCheck=function(t){var e=[],n=new P.Vector2D(t[t.length-1]),r=new _.Vertex(n);return t.map((function(t){var n=new P.Vector2D(t),o=new _.Vertex(n),i=new _.Side(r,o);e.push(i),r=o})),_.fromSides(e)},_.fromFakeCSG=function(t){var e=t.polygons.map((function(t){return _.Side._fromFakePolygon(t)})).filter((function(t){return null!==t}));return _.fromSides(e)},_.linesIntersect=function(t,e,n,r){if(e.equals(n)||r.equals(t)){if(r.minus(n).unit().plus(e.minus(t).unit()).length()<1e-5)return!0}else{var o=e.minus(t),i=r.minus(n);if(Math.abs(o.cross(i))<1e-9)return!1;var a=P.solve2Linear(-o.x,i.x,-o.y,i.y,t.x-n.x,t.y-n.y);if(a[0]>1e-6&&a[0]<.999999&&a[1]>1e-5&&a[1]<.999999)return!0}return!1},_.circle=function(t){t=t||{};for(var e,n=P.parseOptionAs2DVector(t,"center",[0,0]),r=P.parseOptionAsFloat(t,"radius",1),o=P.parseOptionAsInt(t,"resolution",P.defaultResolution2D),i=[],a=0;a<=o;a++){var s=2*Math.PI*a/o,u=P.Vector2D.fromAngleRadians(s).times(r).plus(n),l=new _.Vertex(u);a>0&&i.push(new _.Side(e,l)),e=l}return _.fromSides(i)},_.rectangle=function(t){var e,n;if("corner1"in(t=t||{})||"corner2"in t){if("center"in t||"radius"in t)throw new Error("rectangle: should either give a radius and center parameter, or a corner1 and corner2 parameter");corner1=P.parseOptionAs2DVector(t,"corner1",[0,0]),corner2=P.parseOptionAs2DVector(t,"corner2",[1,1]),e=corner1.plus(corner2).times(.5),n=corner2.minus(corner1).times(.5)}else e=P.parseOptionAs2DVector(t,"center",[0,0]),n=P.parseOptionAs2DVector(t,"radius",[1,1]);n=n.abs();var r=new P.Vector2D(n.x,-n.y),o=[e.plus(n),e.plus(r),e.minus(n),e.minus(r)];return _.fromPoints(o)},_.roundedRectangle=function(t){var e,n;if("corner1"in(t=t||{})||"corner2"in t){if("center"in t||"radius"in t)throw new Error("roundedRectangle: should either give a radius and center parameter, or a corner1 and corner2 parameter");corner1=P.parseOptionAs2DVector(t,"corner1",[0,0]),corner2=P.parseOptionAs2DVector(t,"corner2",[1,1]),e=corner1.plus(corner2).times(.5),n=corner2.minus(corner1).times(.5)}else e=P.parseOptionAs2DVector(t,"center",[0,0]),n=P.parseOptionAs2DVector(t,"radius",[1,1]);n=n.abs();var r=P.parseOptionAsFloat(t,"roundradius",.2),o=P.parseOptionAsInt(t,"resolution",P.defaultResolution2D),i=Math.min(n.x,n.y);i-=.1,r=Math.min(r,i),r=Math.max(0,r),n=new P.Vector2D(n.x-r,n.y-r);var a=_.rectangle({center:e,radius:n});return r>0&&(a=a.expand(r,o)),a},_.fromCompactBinary=function(t){if("CAG"!==t.class)throw new Error("Not a CAG");for(var e=[],n=t.vertexData,r=n.length/2,o=0,i=0;i<r;i++){var a=n[o++],s=n[o++],u=new P.Vector2D(a,s),l=new _.Vertex(u);e.push(l)}var c=[],h=t.sideVertexIndices.length/2;o=0;for(var p=0;p<h;p++){var f=t.sideVertexIndices[o++],d=t.sideVertexIndices[o++],v=new _.Side(e[f],e[d]);c.push(v)}var m=_.fromSides(c);return m.isCanonicalized=!0,m},_.prototype={toString:function(){var t="CAG ("+this.sides.length+" sides):\n";return this.sides.map((function(e){t+="  "+e.toString()+"\n"})),t},_toCSGWall:function(t,e){var n=this.sides.map((function(n){return n.toPolygon3D(t,e)}));return P.fromPolygons(n)},_toVector3DPairs:function(t){var e=this.sides.map((function(t){var e=t.vertex0.pos,n=t.vertex1.pos;return[P.Vector3D.Create(e.x,e.y,0),P.Vector3D.Create(n.x,n.y,0)]}));return void 0!==t&&(e=e.map((function(e){return e.map((function(e){return e.transform(t)}))}))),e},_toPlanePolygons:function(t){var e=t.flipped||!1,n=[0,0,0],r=[0,0,1],o=[0,1,0],i=new P.Connector(n,r,o),a=t.translation||n,s=t.axisVector||r,u=t.normalVector||o,l=t.toConnector||new P.Connector(a,s,u),c=i.getTransformationTo(l,!1,0),h=this.getBounds();h[0]=h[0].minus(new P.Vector2D(1,1)),h[1]=h[1].plus(new P.Vector2D(1,1));var p=this._toCSGWall(-1,1),f=P.fromPolygons([new P.Polygon([new P.Vertex(new P.Vector3D(h[0].x,h[0].y,0)),new P.Vertex(new P.Vector3D(h[1].x,h[0].y,0)),new P.Vertex(new P.Vector3D(h[1].x,h[1].y,0)),new P.Vertex(new P.Vector3D(h[0].x,h[1].y,0))])]);return e&&(f=f.invert()),(f=f.intersectSub(p)).polygons.filter((function(t){return Math.abs(t.plane.normal.z)>.99})).map((function(t){return t.transform(c)}))},_toWallPolygons:function(t){var e=new P.Connector([0,0,0],[0,0,1],[0,1,0]),n=t.toConnector1,r=t.toConnector2;if(!(n instanceof P.Connector&&r instanceof P.Connector))throw"could not parse CSG.Connector arguments toConnector1 or toConnector2";if(t.cag&&t.cag.sides.length!==this.sides.length)throw"target cag needs same sides count as start cag";var o=t.cag||this,i=e.getTransformationTo(n,!1,0),a=e.getTransformationTo(r,!1,0),s=this._toVector3DPairs(i),u=o._toVector3DPairs(a),l=[];return s.forEach((function(t,e){l.push(new P.Polygon([new P.Vertex(u[e][1]),new P.Vertex(u[e][0]),new P.Vertex(t[0])])),l.push(new P.Polygon([new P.Vertex(u[e][1]),new P.Vertex(t[0]),new P.Vertex(t[1])]))})),l},union:function(t){var e;e=t instanceof Array?t:[t];var n=(n=this._toCSGWall(-1,1)).union(e.map((function(t){return t._toCSGWall(-1,1).reTesselated()})),!1,!1);return _.fromFakeCSG(n).canonicalized()},subtract:function(t){var e;e=t instanceof Array?t:[t];var n=this._toCSGWall(-1,1);return e.map((function(t){n=n.subtractSub(t._toCSGWall(-1,1),!1,!1)})),n=(n=n.reTesselated()).canonicalized(),n=(n=_.fromFakeCSG(n)).canonicalized()},intersect:function(t){var e;e=t instanceof Array?t:[t];var n=this._toCSGWall(-1,1);return e.map((function(t){n=n.intersectSub(t._toCSGWall(-1,1),!1,!1)})),n=(n=n.reTesselated()).canonicalized(),n=(n=_.fromFakeCSG(n)).canonicalized()},transform:function(t){var e=t.isMirroring(),n=this.sides.map((function(e){return e.transform(t)})),r=_.fromSides(n);return e&&(r=r.flipped()),r},area:function(){var t=0;return this.sides.map((function(e){t+=e.vertex0.pos.cross(e.vertex1.pos)})),t*=.5},flipped:function(){var t=this.sides.map((function(t){return t.flipped()}));return t.reverse(),_.fromSides(t)},getBounds:function(){var t,e=t=0===this.sides.length?new P.Vector2D(0,0):this.sides[0].vertex0.pos;return this.sides.map((function(n){t=(t=t.min(n.vertex0.pos)).min(n.vertex1.pos),e=(e=e.max(n.vertex0.pos)).max(n.vertex1.pos)})),[t,e]},isSelfIntersecting:function(t){for(var e=this.sides.length,n=0;n<e;n++)for(var r=this.sides[n],o=n+1;o<e;o++){var i=this.sides[o];if(_.linesIntersect(r.vertex0.pos,r.vertex1.pos,i.vertex0.pos,i.vertex1.pos))return t&&(OpenJsCad.log(r),OpenJsCad.log(i)),!0}return!1},expandedShell:function(t,e){(e=e||8)<4&&(e=4);var n=[],r={},o=this.canonicalized();for(var i in o.sides.map((function(e){var o=e.vertex1.pos.minus(e.vertex0.pos),i=o.length();if(i>1e-5){var a=(o=o.times(1/i)).normal().times(t),s=[e.vertex1.pos.plus(a),e.vertex1.pos.minus(a),e.vertex0.pos.minus(a),e.vertex0.pos.plus(a)],u=_.fromPoints(s);n.push(u);for(var l=0;l<2;l++){var c=0===l?e.vertex0.pos:e.vertex1.pos,h=0===l?e.vertex1.pos:e.vertex0.pos,p=c.x+" "+c.y;p in r||(r[p]=[]),r[p].push({p1:c,p2:h})}}})),r){var a,s,u=r[i],l=u[0].p1;if(2===u.length){var c=u[0].p2,h=u[1].p2;if(a=c.minus(l).angleDegrees(),(s=h.minus(l).angleDegrees())<a&&(s+=360),s>=a+360&&(s-=360),s<a+180){var p=s;s=a+360,a=p}a+=90,s-=90}else a=0,s=360;var f=s>a+359.999;if(f&&(a=0,s=360),s>a+1e-5){var d=[];f||d.push(l);var v=Math.round(e*(s-a)/360);v<1&&(v=1);for(var m=0;m<=v;m++){var g=a+m/v*(s-a);m===v&&(g=s);var y=l.plus(P.Vector2D.fromAngleDegrees(g).times(t));(!f||m>0)&&d.push(y)}var x=_.fromPointsNoCheck(d);n.push(x)}}var w=new _;return w.union(n)},expand:function(t,e){return this.union(this.expandedShell(t,e))},contract:function(t,e){return this.subtract(this.expandedShell(t,e))},extrudeInOrthonormalBasis:function(t,e,n){if(!(t instanceof P.OrthoNormalBasis))throw new Error("extrudeInPlane: the first parameter should be a CSG.OrthoNormalBasis");var r=this.extrude({offset:[0,0,e]});P.parseOptionAsBool(n,"symmetrical",!1)&&(r=r.translate([0,0,-e/2]));var o=t.getInverseProjectionMatrix();return r.transform(o)},extrudeInPlane:function(t,e,n,r){return this.extrudeInOrthonormalBasis(P.OrthoNormalBasis.GetCartesian(t,e),n,r)},extrude:function(t){if(0===this.sides.length)return new P;var e=P.parseOptionAs3DVector(t,"offset",[0,0,1]),n=P.parseOptionAsFloat(t,"twistangle",0),r=P.parseOptionAsInt(t,"twiststeps",P.defaultResolution3D);if(0===e.z)throw"offset cannot be orthogonal to Z axis";(0===n||r<1)&&(r=1);var o=P.Vector3D.Create(0,1,0),i=[];i=(i=i.concat(this._toPlanePolygons({translation:[0,0,0],normalVector:o,flipped:!(e.z<0)}))).concat(this._toPlanePolygons({translation:e,normalVector:o.rotateZ(n),flipped:e.z<0}));for(var a=0;a<r;a++){var s=new P.Connector(e.times(a/r),[0,0,e.z],o.rotateZ(a*n/r)),u=new P.Connector(e.times((a+1)/r),[0,0,e.z],o.rotateZ((a+1)*n/r));i=i.concat(this._toWallPolygons({toConnector1:s,toConnector2:u}))}return P.fromPolygons(i)},rotateExtrude:function(t){var e=P.parseOptionAsFloat(t,"angle",360),n=P.parseOptionAsInt(t,"resolution",P.defaultResolution3D);e=e>360?e%360:e;var r=[0,0,0],o=P.Vector3D.Create(0,1,0),i=[0,0,1],a=[],s=new P.Connector(r,o,i);if(e>0&&e<360){var u=new P.Connector(r,o.rotateZ(-e),i);a=(a=a.concat(this._toPlanePolygons({toConnector:s,flipped:!0}))).concat(this._toPlanePolygons({toConnector:u}))}for(var l,c=s,h=e/n,p=h;p<=e+1e-5;p+=h)l=new P.Connector(r,o.rotateZ(-p),i),a=a.concat(this._toWallPolygons({toConnector1:c,toConnector2:l})),c=l;return P.fromPolygons(a).reTesselated()},check:function(){var t=1e-5,e=[];this.isSelfIntersecting(!0)&&e.push("Self intersects");var n={};for(var r in this.sides.map((function(t){function e(t){var e=t.x+" "+t.y;e in n||(n[e]=0),n[e]++}e(t.vertex0.pos),e(t.vertex1.pos)})),n){var o=n[r];1&o&&e.push("Uneven number of sides ("+o+") for point "+r)}var i=this.area();if(i<t*t&&e.push("Area is "+i),e.length>0){var a="";throw e.map((function(t){a+=t+"\n"})),new Error(a)}},canonicalized:function(){if(this.isCanonicalized)return this;var t=(new _.fuzzyCAGFactory).getCAG(this);return t.isCanonicalized=!0,t},toCompactBinary:function(){var t=this.canonicalized(),e=t.sides.length,n={},r=[],o=0,i=new Uint32Array(2*e),a=0;t.sides.map((function(t){[t.vertex0,t.vertex1].map((function(t){var e,s=t.getTag();s in n?e=n[s]:(e=o++,n[s]=e,r.push(t)),i[a++]=e}))}));var s=new Float64Array(2*o),u=0;return r.map((function(t){var e=t.pos;s[u++]=e._x,s[u++]=e._y})),{class:"CAG",sideVertexIndices:i,vertexData:s}},getOutlinePaths:function(){var t=this.canonicalized(),e={},n={};t.sides.map((function(t){var r=t.getTag();e[r]=t;var o=t.vertex0.getTag();o in n||(n[o]=[]),n[o].push(r)}));for(var r=[];;){var o=null;for(var i in n){var a=n[i];o=a[0],a.splice(0,1),0===a.length&&delete n[i];break}if(null===o)break;for(var s=[],u=e[o],l=u.vertex0.getTag();;){s.push(u.vertex0.pos);var c=u.vertex1.getTag();if(c===l)break;if(!(c in n))throw new Error("Area is not closed!");var h=n[c],p=-1;if(1===h.length)p=0;else for(var f=null,d=u.direction().angleDegrees(),v=0;v<h.length;v++){var m=h[v],g=e[m].direction().angleDegrees()-d;g<-180&&(g+=360),g>=180&&(g-=360),(p<0||g>f)&&(p=v,f=g)}var y=h[p];h.splice(p,1),0===h.length&&delete n[c],u=e[y]}var x=new P.Path2D(s,!0);r.push(x)}return r},overCutInsideCorners:function(t){var e=this.canonicalized(),n={};e.sides.map((function(t){t.vertex0.getTag()in n||(n[t.vertex0.getTag()]={pos:t.vertex0.pos,from:[],to:[]}),n[t.vertex0.getTag()].to.push(t.vertex1.pos),t.vertex1.getTag()in n||(n[t.vertex1.getTag()]={pos:t.vertex1.pos,from:[],to:[]}),n[t.vertex1.getTag()].from.push(t.vertex0.pos)}));var r=[];for(var o in n){var i=n[o];if(1===i.from.length&&1===i.to.length){var a=i.from[0],s=i.pos,u=i.to[0],l=s.minus(a).unit(),c=u.minus(s).unit();if(l.cross(c)<.001){var h=c.angleRadians()-l.angleRadians()+Math.PI;h<0?h+=2*Math.PI:h>=2*Math.PI&&(h-=2*Math.PI);for(var p=c.minus(l).unit(),f=30/180*Math.PI,d=t/Math.cos(f/2),v=s.plus(p.times(d)),m=h+p.angleRadians(),g=2*(Math.PI-h),y=2*Math.ceil(g/f/2),x=[v],w=0;w<=y;w++){var b=m+w/y*g,T=P.Vector2D.fromAngleRadians(b).times(d).plus(v);x.push(T)}r.push(_.fromPoints(x))}}}return e.subtract(r)}},_.Vertex=function(t){this.pos=t},_.Vertex.prototype={toString:function(){return"("+this.pos.x.toFixed(2)+","+this.pos.y.toFixed(2)+")"},getTag:function(){var t=this.tag;return t||(t=P.getTag(),this.tag=t),t}},_.Side=function(t,e){if(!(t instanceof _.Vertex))throw new Error("Assertion failed");if(!(e instanceof _.Vertex))throw new Error("Assertion failed");this.vertex0=t,this.vertex1=e},_.Side._fromFakePolygon=function(t){if(t.vertices.forEach((function(t){if(!(t.pos.z>=-1.001&&t.pos.z<-.999||t.pos.z>=.999&&t.pos.z<1.001))throw"Assertion failed: _fromFakePolygon expects abs z values of 1"})),t.vertices.length<4)return null;var e=[],n=t.vertices.filter((function(t,n){if(t.pos.z>0)return e.push(n),!0})).map((function(t){return new P.Vector2D(t.pos.x,t.pos.y)}));if(2!==n.length)throw"Assertion failed: _fromFakePolygon: not enough points found";var r=e[1]-e[0];if(1!==r&&3!==r)throw"Assertion failed: _fromFakePolygon: unknown index ordering";return 1===r&&n.reverse(),new _.Side(new _.Vertex(n[0]),new _.Vertex(n[1]))},_.Side.prototype={toString:function(){return this.vertex0+" -> "+this.vertex1},toPolygon3D:function(t,e){var n=[new P.Vertex(this.vertex0.pos.toVector3D(t)),new P.Vertex(this.vertex1.pos.toVector3D(t)),new P.Vertex(this.vertex1.pos.toVector3D(e)),new P.Vertex(this.vertex0.pos.toVector3D(e))];return new P.Polygon(n)},transform:function(t){var e=this.vertex0.pos.transform(t),n=this.vertex1.pos.transform(t);return new _.Side(new _.Vertex(e),new _.Vertex(n))},flipped:function(){return new _.Side(this.vertex1,this.vertex0)},direction:function(){return this.vertex1.pos.minus(this.vertex0.pos)},getTag:function(){var t=this.tag;return t||(t=P.getTag(),this.tag=t),t},lengthSquared:function(){var t=this.vertex1.pos.x-this.vertex0.pos.x,e=this.vertex1.pos.y-this.vertex0.pos.y;return t*t+e*e},length:function(){return Math.sqrt(this.lengthSquared())}},_.fuzzyCAGFactory=function(){this.vertexfactory=new P.fuzzyFactory(2,1e-5)},_.fuzzyCAGFactory.prototype={getVertex:function(t){var e=[t.pos._x,t.pos._y];return this.vertexfactory.lookupOrCreate(e,(function(e){return t}))},getSide:function(t){var e=this.getVertex(t.vertex0),n=this.getVertex(t.vertex1);return new _.Side(e,n)},getCAG:function(t){var e=this,n=t.sides.map((function(t){return e.getSide(t)})).filter((function(t){return t.length()>1e-5}));return _.fromSides(n)}},P.addTransformationMethodsToPrototype(P.prototype),P.addTransformationMethodsToPrototype(P.Vector2D.prototype),P.addTransformationMethodsToPrototype(P.Vector3D.prototype),P.addTransformationMethodsToPrototype(P.Vertex.prototype),P.addTransformationMethodsToPrototype(P.Plane.prototype),P.addTransformationMethodsToPrototype(P.Polygon.prototype),P.addTransformationMethodsToPrototype(P.Line3D.prototype),P.addTransformationMethodsToPrototype(P.Connector.prototype),P.addTransformationMethodsToPrototype(P.Path2D.prototype),P.addTransformationMethodsToPrototype(P.Line2D.prototype),P.addTransformationMethodsToPrototype(_.prototype),P.addTransformationMethodsToPrototype(_.Side.prototype),P.addTransformationMethodsToPrototype(P.OrthoNormalBasis.prototype),P.addCenteringToPrototype(P.prototype,["x","y","z"]),P.addCenteringToPrototype(_.prototype,["x","y"]),P.Polygon2D=function(t){var e=_.fromPoints(t);this.sides=e.sides},P.Polygon2D.prototype=_.prototype;var V=n(428);function M(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function N(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}var R=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t.DEFAULT_FRAGMENT,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];if(M(this,t),!t.renderer)throw new Error("GPUComputer : use GPUComputer.init( renderer ) before instancing.");var i=void 0!==e.length,a=i?o?e.length:e.length/4:e,s=i?t.getRequiredSize(a):e;this._size=s,this.tData=t.createTexture(s),r.tData={value:this.tData},this._buffer=this.tData.image.data,this._data=i?e:new Float32Array(s*s),this._dataIsPacked=!0,i&&(o?t.pack(e,this.tData.image.data):(this.tData.image.data=e,this._dataIsPacked=!1)),this.material=new V.ShaderMaterial({uniforms:r,vertexShader:t.DEFAULT_VERTEX,fragmentShader:n});var u=s.toFixed(1);function l(){return new V.WebGLRenderTarget(s,s,{wrapS:V.ClampToEdgeWrapping,wrapT:V.ClampToEdgeWrapping,minFilter:V.NearestFilter,magFilter:V.NearestFilter,stencilBuffer:!1,depthBuffer:!1,format:V.RGBAFormat,type:V.UnsignedByteType})}this.material.defines.resolution="vec2( ".concat(u,", ").concat(u," )"),this._rt1=l(),this._rt2=l(),this.renderTarget=this._rt1}var e,n;return e=t,(n=[{key:"compute",value:function(){t.render(this.material,this.renderTarget),this.material.uniforms.tData.value=this.renderTarget.texture,this.renderTarget=this.renderTarget===this._rt1?this._rt2:this._rt1}},{key:"update",value:function(t,e){this.material.uniforms[t].value=e}},{key:"size",get:function(){return this._size}},{key:"texture",get:function(){return this.material.uniforms.tData.value}},{key:"data",get:function(){return t.renderer.readRenderTargetPixels(this.renderTarget,0,0,this._size,this._size,this._buffer),this._dataIsPacked?(t.unpack(this._buffer,this._data),this._data):this._buffer}}])&&N(e.prototype,n),t}();function z(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function E(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}R.init=function(t){if(R.isCompatible=!1,!R.renderer){if(R.renderer=t,R.scene=new V.Scene,R.camera=new V.Camera,R.mesh=new V.Mesh(new V.PlaneBufferGeometry(2,2)),R.scene.add(R.mesh),0===t.capabilities.maxVertexTextures)return console.warn("GPUComputer.init(): No support for vertex shader textures."),R.isCompatible;R.isCompatible=!0}return R.isCompatible||window.alert("Your hardware is not compatible with this app."),R.isCompatible},R.render=function(t,e){R.mesh.material=t,R.renderer.setRenderTarget(e),R.renderer.render(R.scene,R.camera),R.renderer.setRenderTarget(null)},R.pack=function(t,e){var n,r,o,i,a,s,u;e||(e=new Uint8Array(4*t.length));for(var l=0,c=0,h=t.length;l<h;l++)0!==(n=t[l])&&(r=Math.abs(n),o=Math.floor(Math.log2(r)),o+=(i=Math.pow(2,o))<=r/2,a=(o-=i>r)>100?r/1024/Math.pow(2,o-10)-1:r/i-1,e[c]=o+127,a*=256,s=Math.floor(a),e[c+1]=s,a=256*(a-s),u=Math.floor(a),e[c+2]=u,a=128*(a-u),e[c+3]=2*Math.floor(a)+(n<0)),c+=4;return e},R.unpack=function(t,e){var n,r,o,i,a,s;e||(e=new Float32Array(t.length/4));for(var u=0,l=0,c=t.length;u<c;u+=4)n=t[u],r=t[u+1],o=t[u+2],a=n-127,s=(1-(i=t[u+3])%2*2)*((n>0)+r/256+o/65536+Math.floor(i/2)/8388608)*Math.pow(2,a),e[l]=s,l++},R.FLOAT_PACKING="\n\n    vec4 pack( float value ) {\n\n        if ( value == 0.0 ) return vec4( 0.0, 0.0, 0.0, 0.0 );\n\n        float mag = abs( value );\n        \n        float exponent = floor( log2( mag ) );\n        exponent += float( exp2( exponent ) <= mag / 2.0 );\n        exponent -= float( exp2( exponent ) > mag );\n\n        float mantissa = ( exponent > 100.0 )\n            ? mag / 1024.0 / exp2( exponent - 10.0 ) - 1.0\n            : mag / float( exp2( exponent ) ) - 1.0;\n\n        float r = exponent + 127.0;\n        mantissa *= 256.0;\n\n        float g = floor( mantissa );\n        mantissa -= g;\n        mantissa *= 256.0;\n\n        float b = floor( mantissa );\n        mantissa -= b;\n        mantissa *= 128.0;\n\n        float a = floor( mantissa ) * 2.0 + float( value < 0.0 );\n\n        return vec4( r, g, b, a ) / 255.0;\n\n    }\n\n    float unpack( vec4 value ) {\n\n        float r = floor( value.r * 255.0 + 0.5 );\n        float g = floor( value.g * 255.0 + 0.5 );\n        float b = floor( value.b * 255.0 + 0.5 );\n        float a = floor( value.a * 255.0 + 0.5 );\n\n        float exponent = r - 127.0;\n        float sign = 1.0 - mod( a, 2.0 ) * 2.0;\n        float mantissa = float( r > 0.0 ) + g / 256.0 + b / 65536.0\n            + floor( a / 2.0 ) / 8388608.0;\n        return sign * mantissa * exp2( exponent );\n\n    }\n\n",R.DEFAULT_VERTEX="\n\n    void main() {\n\n        gl_Position = vec4( position, 1.0 );\n\n    }\n\n",R.DEFAULT_FRAGMENT="\n\n    uniform sampler2D tData;\n\n    ".concat(R.FLOAT_PACKING,"\n\n    void main() {\n        \n        vec2 uv = gl_FragCoord.xy / resolution.xy;\n        float data = unpack( texture2D( tData, uv ) );\n\n        // edit data...\n\n        gl_FragColor = pack( data );\n\n    }\n\n"),R.createTexture=function(t){return new V.DataTexture(new Uint8Array(t*t*4),t,t,V.RGBAFormat,V.UnsignedByteType)},R.getRequiredSize=function(t){if(t<=0||t===1/0)throw new RangeError("GPUComputer.getRequiredSize(): length must be a positive integer.");for(var e=1,n=2;n*n<t;)n=Math.pow(2,e),e++;return n},R.cleanFloat=function(t){return Math.round(1e6*t)/1e6};var L,A,F,I=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=e.length,r=void 0===n?16384:n,o=e.output,i=void 0===o?new V.MeshBasicMaterial:o,a=e.delay,s=void 0===a?0:a,u=e.duration,l=void 0===u?500:u,c=e.stagger,h=void 0===c?50:c,p=e.repeat,f=void 0===p?0:p,d=e.loop,v=void 0!==d&&d,m=e.rewind,g=void 0!==m&&m,y=e.reversed,x=void 0!==y&&y,w=e.reverseSpeed,b=void 0===w?1:w,T=e.scale,S=void 0===T?{start:{x:1,y:1,z:1},end:{x:1,y:1,z:1}}:T,D=e.rotate,P=void 0===D?{start:{x:0,y:0,z:0},end:{x:0,y:0,z:0}}:D,C=e.translate,_=void 0===C?{start:{x:0,y:0,z:0},end:{x:0,y:0,z:0}}:C,O=e.x,M=void 0===O?null:O,N=e.y,E=void 0===N?null:N,L=e.z,A=void 0===L?null:L;z(this,t);var F=R.getRequiredSize(r);this.length=r,this.size=F,this.delay=s,this.duration=l<0?0:l,this.stagger=h,0===l&&(f=g=0),this.repeat=v?255:f<255?f:255,this.rewind=g,this.reversed=x,this.reverseSpeed=b,this.gpu={},this._readTransformParameters(S,P,_,M,E,A),this._createProgressComputers(),this._createTransformComputers(),this._setupOutput(i)}var e,n;return e=t,(n=[{key:"_readTransformParameters",value:function(t,e,n,r,o,i){"number"==typeof t&&(t={start:{x:1,y:1,z:1},end:{x:t,y:t,z:t}}),"number"==typeof e&&(e={start:{x:0,y:0,z:0},end:{x:e,y:e,z:e}}),"number"==typeof n&&(n={start:{x:0,y:0,z:0},end:{x:n,y:n,z:n}}),"number"==typeof t.start&&(t.start={x:t.start,y:t.start,z:t.start}),"number"==typeof e.start&&(e.start={x:e.start,y:e.start,z:e.start}),"number"==typeof n.start&&(n.start={x:n.start,y:n.start,z:n.start}),"number"==typeof t.end&&(t.end={x:t.end,y:t.end,z:t.end}),"number"==typeof e.end&&(e.end={x:e.end,y:e.end,z:e.end}),"number"==typeof n.end&&(n.end={x:n.end,y:n.end,z:n.end}),void 0===t.start&&(t.start={x:1,y:1,z:1}),void 0===t.end&&(t.end={x:1,y:1,z:1}),void 0===t.start.x&&(t.start.x=1),void 0===t.start.y&&(t.start.y=1),void 0===t.start.z&&(t.start.z=1),void 0===t.end.x&&(t.end.x=1),void 0===t.end.y&&(t.end.y=1),void 0===t.end.z&&(t.end.z=1),void 0===e.start&&(e.start={x:0,y:0,z:0}),void 0===e.end&&(e.end={x:0,y:0,z:0}),void 0===e.start.x&&(e.start.x=0),void 0===e.start.y&&(e.start.y=0),void 0===e.start.z&&(e.start.z=0),void 0===e.end.x&&(e.end.x=0),void 0===e.end.y&&(e.end.y=0),void 0===e.end.z&&(e.end.z=0),void 0===n.start&&(n.start={x:0,y:0,z:0}),void 0===n.end&&(n.end={x:0,y:0,z:0}),void 0===n.start.x&&(n.start.x=0),void 0===n.start.y&&(n.start.y=0),void 0===n.start.z&&(n.start.z=0),void 0===n.end.x&&(n.end.x=0),void 0===n.end.y&&(n.end.y=0),void 0===n.end.z&&(n.end.z=0),r&&(n.end.x=r),o&&(n.end.y=o),i&&(n.end.z=i),this.scale=t,this.rotate=e,this.translate=n}},{key:"_createProgressComputers",value:function(){var e=this.size,n=this.duration;this.gpu.stagger=new R(this._createStaggerData(this.stagger),t.GLSL.STAGGER,{uDelta:{value:0}}),this.gpu.elapsed=new R(e,t.GLSL.ELAPSED,{uDelta:{value:0},uDuration:{value:n},uReverseSpeed:{value:-this.reverseSpeed},tStagger:{value:null},tLoop:{value:null}}),this.reversed&&this.setElapsedTime(n),this.gpu.progress=new R(e,t.GLSL.PROGRESS,{uDuration:{value:n},tElapsed:{value:null}});var r=this.rewind?1:0,o=this.reversed?255:0;this.gpu.loop=new R(this._createLoopData(this.repeat,o),t.GLSL.LOOP,{uRewind:{value:r},tProgress:{value:null}},!1)}},{key:"_createTransformComputer",value:function(e,n){var r=this[e].start[n],o=this[e].end[n];return new R(this.size,t.GLSL.TRANSFORM,{uStart:{value:r},uChange:{value:o-r},tProgress:{value:null}})}},{key:"_createTransformComputers",value:function(){var t={};t.scaleX=this._createTransformComputer("scale","x"),t.scaleY=this._createTransformComputer("scale","y"),t.scaleZ=this._createTransformComputer("scale","z"),t.rotateX=this._createTransformComputer("rotate","x"),t.rotateY=this._createTransformComputer("rotate","y"),t.rotateZ=this._createTransformComputer("rotate","z"),t.translateX=this._createTransformComputer("translate","x"),t.translateY=this._createTransformComputer("translate","y"),t.translateZ=this._createTransformComputer("translate","z"),this.gpu.transforms=t}},{key:"_setupOutput",value:function(t){t.onBeforeCompile=this._onBeforeCompile.bind(this),t.uniforms={},t.uniforms.tScaleX={value:null},t.uniforms.tScaleY={value:null},t.uniforms.tScaleZ={value:null},t.uniforms.tRotateX={value:null},t.uniforms.tRotateY={value:null},t.uniforms.tRotateZ={value:null},t.uniforms.tTranslateX={value:null},t.uniforms.tTranslateY={value:null},t.uniforms.tTranslateZ={value:null},this.output=t}},{key:"_onBeforeCompile",value:function(e){var n,r;e.uniforms.tScaleX={value:null},e.uniforms.tScaleY={value:null},e.uniforms.tScaleZ={value:null},e.uniforms.tRotateX={value:null},e.uniforms.tRotateY={value:null},e.uniforms.tRotateZ={value:null},e.uniforms.tTranslateX={value:null},e.uniforms.tTranslateY={value:null},e.uniforms.tTranslateZ={value:null},n="#include <common>",r=t.GLSL.OUTPUT_DECLARATIONS,e.vertexShader=e.vertexShader.replace(n,n+r),n="#include <begin_vertex>",r=t.GLSL.OUTPUT_TRANSFORM,e.vertexShader=e.vertexShader.replace(n,r),this.output=e}},{key:"_createStaggerData",value:function(t){for(var e=new Float32Array(this.size*this.size),n=0,r=e.length;n<r;n++)e[n]=t*n;return e}},{key:"_createLoopData",value:function(t,e){for(var n=new Uint8Array(this.size*this.size*4),r=0,o=n.length;r<o;r+=4)n[r]=t,n[r+1]=e;return n}},{key:"_compute",value:function(){var t=this.output,e=this.gpu.transforms,n=this.gpu.progress.texture;for(var r in e){var o=e[r];o.update("tProgress",n),o.compute()}t.uniforms.tScaleX.value=e.scaleX.texture,t.uniforms.tScaleY.value=e.scaleY.texture,t.uniforms.tScaleZ.value=e.scaleZ.texture,t.uniforms.tRotateX.value=e.rotateX.texture,t.uniforms.tRotateY.value=e.rotateY.texture,t.uniforms.tRotateZ.value=e.rotateZ.texture,t.uniforms.tTranslateX.value=e.translateX.texture,t.uniforms.tTranslateY.value=e.translateY.texture,t.uniforms.tTranslateZ.value=e.translateZ.texture}},{key:"update",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:16.67;if(!(this.delay>0&&(this.delay-=t,this.delay>0))){this.delay<0&&(t+=this.delay,this.delay=0);var e=this.gpu.stagger,n=this.gpu.elapsed,r=this.gpu.loop,o=this.gpu.progress;e.update("uDelta",t),n.update("uDelta",t),e.compute(),n.update("tStagger",e.texture),r.compute(),n.update("tLoop",r.texture),n.compute(),o.update("tElapsed",n.texture),o.compute(),r.update("tProgress",o.texture),this._compute()}}},{key:"setElapsedTime",value:function(t){var e=[t],n=new Uint8Array(4);R.pack(e,n);for(var r=this.elapsed.tData.image.data,o=0,i=r.length;o<i;o+=4)r[o]=e[0],r[o+1]=e[1],r[o+2]=e[2],r[o+3]=e[3]}}])&&E(e.prototype,n),t}();function B(){this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1}I.GLSL={},I.GLSL.OUTPUT_DECLARATIONS="\n\n\tattribute vec2 reference;\n\n\tuniform sampler2D tScaleX;\n\tuniform sampler2D tScaleY;\n\tuniform sampler2D tScaleZ;\n\n\tuniform sampler2D tRotateX;\n\tuniform sampler2D tRotateY;\n\tuniform sampler2D tRotateZ;\n\n\tuniform sampler2D tTranslateX;\n\tuniform sampler2D tTranslateY;\n\tuniform sampler2D tTranslateZ;\n\n\t".concat(R.FLOAT_PACKING,"\n\n\t").concat(m,"\n\n"),I.GLSL.OUTPUT_TRANSFORM="\n\n\tfloat gpgpuScaleX = unpack( texture2D( tScaleX, reference.xy ) );\n\tfloat gpgpuScaleY = unpack( texture2D( tScaleY, reference.xy ) );\n\tfloat gpgpuScaleZ = unpack( texture2D( tScaleZ, reference.xy ) );\n\n\tfloat gpgpuRotateX = unpack( texture2D( tRotateX, reference.xy ) );\n\tfloat gpgpuRotateY = unpack( texture2D( tRotateY, reference.xy ) );\n\tfloat gpgpuRotateZ = unpack( texture2D( tRotateZ, reference.xy ) );\n\n\tfloat gpgpuTranslateX = unpack( texture2D( tTranslateX, reference.xy ) );\n\tfloat gpgpuTranslateY = unpack( texture2D( tTranslateY, reference.xy ) );\n\tfloat gpgpuTranslateZ = unpack( texture2D( tTranslateZ, reference.xy ) );\n\n\tvec3 gpgpuPosition = position;\n\n\tgpgpuPosition *= scale( gpgpuScaleX, gpgpuScaleY, gpgpuScaleZ );\n\n\tgpgpuPosition *= rotateX( gpgpuRotateX );\n\tgpgpuPosition *= rotateY( gpgpuRotateY );\n\tgpgpuPosition *= rotateZ( gpgpuRotateZ );\n\n\tgpgpuPosition += vec3( gpgpuTranslateX, gpgpuTranslateY, gpgpuTranslateZ );\n\n\tvec3 transformed = gpgpuPosition;\n\n",I.GLSL.TRANSFORM="\n\n\tuniform float uStart;\n\tuniform float uChange;\n\tuniform sampler2D tProgress;\n\n\t".concat(R.FLOAT_PACKING,"\n\n\tvoid main() {\n\n\t\tvec2 uv = gl_FragCoord.xy / resolution.xy;\n\t\tfloat progress = unpack( texture2D( tProgress, uv ) );\n\n\t\tfloat data = uStart + uChange * progress;\n\n\t\tgl_FragColor = pack( data );\n\n\t}\n\n"),I.GLSL.STAGGER="\n\n\tuniform float uDelta;\n\tuniform sampler2D tData;\n\n\t".concat(R.FLOAT_PACKING,"\n\n\tvoid main() {\n\n\t\tvec2 uv = gl_FragCoord.xy / resolution.xy;\n\t\tfloat data = unpack( texture2D( tData, uv ) );\n\n\t\tif ( data > 0.0 ) data -= uDelta;\n\t\telse if ( data < 0.0 ) data = 0.0;\n\n\t\tgl_FragColor = pack( data );\n\n\t}\n\n"),I.GLSL.ELAPSED="\n\n\tuniform float uDelta;\n\tuniform float uDuration;\n\tuniform float uReverseSpeed;\n\tuniform sampler2D tData;\n\tuniform sampler2D tStagger;\n\tuniform sampler2D tLoop;\n\n\t".concat(R.FLOAT_PACKING,"\n\n\tvoid main() {\n\n\t\tvec2 uv = gl_FragCoord.xy / resolution.xy;\n\t\tfloat data = unpack( texture2D( tData, uv ) );\n\t\tfloat stagger = unpack( texture2D( tStagger, uv ) );\n\n\t\tvec4 loop = texture2D( tLoop, uv );\n\t\tfloat reversed = loop.y;\n\t\tfloat reset = loop.z;\n\n\t\tif ( stagger < 0.0 ) {\n\n\t\t\tdata -= stagger;\n\n\t\t} else if ( stagger == 0.0 ) {\n\n\t\t\tif ( reset == 1.0 ) {\n\n\t\t\t\tdata = 0.0;\n\n\t\t\t} else if ( reversed == 0.0 ) {\n\n\t\t\t\tdata += uDelta;\n\n\t\t\t} else {\n\n\t\t\t\tdata += uDelta * uReverseSpeed;\n\t\t\t\tif ( data < 0.0 ) data = 0.0;\n\n\t\t\t}\n\n\t\t}\n\n\t\tif ( data > uDuration ) data = uDuration;\n\n\t\tgl_FragColor = pack( data );\n\n\t}\n\n"),I.GLSL.PROGRESS="\n\n\tuniform float uDuration;\n\tuniform sampler2D tData;\n\tuniform sampler2D tElapsed;\n\n\t".concat(R.FLOAT_PACKING,"\n\t").concat(d.circOut,"\n\n\tvoid main() {\n\n\t\tvec2 uv = gl_FragCoord.xy / resolution.xy;\n\t\tfloat data = unpack( texture2D( tData, uv ) );\n\n\t\tif ( uDuration == 0.0 ) data = 1.0;\n\t\telse {\n\t\t\tfloat elapsed = unpack( texture2D( tElapsed, uv ) );\n\t\t\tdata = circOut( elapsed / uDuration );\n\t\t}\n\n\t\tgl_FragColor = pack( data );\n\n\t}\n\n"),I.GLSL.LOOP="\n    \n\tuniform float uRewind;\n\tuniform sampler2D tData;\n\tuniform sampler2D tProgress;\n\n\t".concat(R.FLOAT_PACKING,"\n\n    void main () {\n\n        vec2 uv = gl_FragCoord.xy / resolution.xy;\n        float progress = unpack( texture2D( tProgress, uv ) );\n\n        vec4 loop = texture2D( tData, uv );\n        float repeat = loop.x * 255.0;\n        float reversed = loop.y;\n        float reset = loop.z;\n\t\t\n\t\tif ( uRewind == 1.0 ) {\n\n\t\t\tif ( progress == 1.0 ) {\n\n\t\t\t\treversed = 1.0;\n\n\t\t\t} else if ( progress == 0.0 && reversed == 1.0 ) {\n\n\t\t\t\tif ( repeat > 0.0 && repeat < 255.0 ) repeat -= 1.0;\n\t\t\t\treversed = ( repeat > 0.0 ) ? 0.0 : 1.0;\n\n\t\t\t}\n\n\t\t} else {\n\n\t\t\tif ( progress == 1.0 && reset == 0.0 ) {\n\n\t\t\t\tif ( repeat > 0.0 && repeat < 255.0 ) repeat -= 1.0;\n\t\t\t\treset = ( repeat > 0.0 ) ? 1.0 : 0.0;\n\n\t\t\t} else if ( reset == 1.0 ) {\n\n\t\t\t\treset = 0.0;\n\n\t\t\t}\n\n\t\t}\n\n\t\trepeat /= 255.0;\n\n        gl_FragColor = vec4( repeat, reversed, reset, 1.0 );\n\n    }\n\n"),I.EASE={LINEAR:"linear"},Object.assign(B.prototype,{setSize:function(){},render:function(){console.error("THREE.Pass: .render() must be implemented in derived pass.")}}),B.FullScreenQuad=(L=new V.OrthographicCamera(-1,1,1,-1,0,1),A=new V.PlaneBufferGeometry(2,2),F=function(t){this._mesh=new V.Mesh(A,t)},Object.defineProperty(F.prototype,"material",{get:function(){return this._mesh.material},set:function(t){this._mesh.material=t}}),Object.assign(F.prototype,{dispose:function(){this._mesh.geometry.dispose()},render:function(t){t.render(this._mesh,L)}}),F);var k=function(t,e){B.call(this),this.textureID=void 0!==e?e:"tDiffuse",t instanceof V.ShaderMaterial?(this.uniforms=t.uniforms,this.material=t):t&&(this.uniforms=V.UniformsUtils.clone(t.uniforms),this.material=new V.ShaderMaterial({defines:Object.assign({},t.defines),uniforms:this.uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader})),this.fsQuad=new B.FullScreenQuad(this.material)};function j(t){t=t||{},this.name=t.name,this.type=t.type,this.node=t.node,this.needsUpdate=t.needsUpdate}k.prototype=Object.assign(Object.create(B.prototype),{constructor:k,render:function(t,e,n){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=n.texture),this.fsQuad.material=this.material,this.renderToScreen?(t.setRenderTarget(null),this.fsQuad.render(t)):(t.setRenderTarget(e),this.clear&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),this.fsQuad.render(t))}}),Object.defineProperties(j.prototype,{value:{get:function(){return this.node.value},set:function(t){this.node.value=t}}});var U={elements:["x","y","z","w"],addShortcuts:function(){function t(t,e,n){return n?{get:function(){return this[t][e][n]},set:function(r){this[t][e][n]=r}}:{get:function(){return this[t][e]},set:function(n){this[t][e]=n}}}return function(e,n,r){for(var o={},i=0;i<r.length;++i){var a=r[i].split("."),s=a[0],u=a[1];o[s]=t(n,s,u)}Object.defineProperties(e,o)}}()},G={nodes:{},keywords:{},add:function(t){this.nodes[t.name]=t},addKeyword:function(t,e,n){n=void 0===n||n,this.keywords[t]={callback:e,cache:n}},remove:function(t){delete this.nodes[t.name]},removeKeyword:function(t){delete this.keywords[t]},get:function(t){return this.nodes[t]},getKeyword:function(t,e){return this.keywords[t].callback.call(this,e)},getKeywordData:function(t){return this.keywords[t]},contains:function(t){return void 0!==this.nodes[t]},containsKeyword:function(t){return void 0!==this.keywords[t]}};function J(t){this.uuid=V.MathUtils.generateUUID(),this.name="",this.type=t,this.userData={}}function q(t,e){J.call(this,t),e=e||{},this.shared=void 0===e.shared||e.shared,this.unique=void 0!==e.unique&&e.unique}J.prototype={constructor:J,isNode:!0,hashProperties:void 0,analyze:function(t,e){e=e||{},t.analyzing=!0,this.build(t.addFlow(e.slot,e.cache,e.context),"v4"),t.clearVertexNodeCode(),t.clearFragmentNodeCode(),t.removeFlow(),t.analyzing=!1},analyzeAndFlow:function(t,e,n){return n=n||{},this.analyze(t,n),this.flow(t,e,n)},flow:function(t,e,n){n=n||{},t.addFlow(n.slot,n.cache,n.context);var r={};return r.result=this.build(t,e),r.code=t.clearNodeCode(),r.extra=t.context.extra,t.removeFlow(),r},build:function(t,e,n){e=e||this.getType(t,e);var r=t.getNodeData(n||this);return t.analyzing&&this.appendDepsNode(t,r,e),-1===t.nodes.indexOf(this)&&t.nodes.push(this),void 0!==this.updateFrame&&-1===t.updaters.indexOf(this)&&t.updaters.push(this),this.generate(t,e,n)},generate:function(){},getHash:function(){var t,e,n="{";for(t in this)(e=this[t])instanceof J&&(n+='"'+t+'":'+e.getHash()+",");if(this.hashProperties)for(var r=0;r<this.hashProperties.length;r++)e=this[t=this.hashProperties[r]],n+='"'+t+'":"'+String(e)+'",';return n+'"id":"'+this.uuid+'"}'},appendDepsNode:function(t,e,n){e.deps=(e.deps||0)+1;var r=t.getTypeLength(n);(r>(e.outputMax||0)||this.getType(t,n))&&(e.outputMax=r,e.output=n)},setName:function(t){return this.name=t,this},getName:function(){return this.name},getType:function(t,e){return"sampler2D"===e||"samplerCube"===e?e:this.type},getJSONNode:function(t){if(void 0!==t&&"string"!=typeof t&&void 0!==t.nodes[this.uuid])return t.nodes[this.uuid]},copy:function(t){return void 0!==t.name&&(this.name=t.name),void 0!==t.userData&&(this.userData=JSON.parse(JSON.stringify(t.userData))),this},createJSONNode:function(t){var e=void 0===t||"string"==typeof t,n={};if("string"!=typeof this.nodeType)throw new Error("Node does not allow serialization.");return n.uuid=this.uuid,n.nodeType=this.nodeType,""!==this.name&&(n.name=this.name),"{}"!==JSON.stringify(this.userData)&&(n.userData=this.userData),e||(t.nodes[this.uuid]=n),n},toJSON:function(t){return this.getJSONNode(t)||this.createJSONNode(t)}},q.prototype=Object.create(J.prototype),q.prototype.constructor=q,q.prototype.build=function(t,e,n,r){if(e=e||this.getType(t),this.getShared(t,e)){var o=this.getUnique(t,e);o&&void 0===this.constructor.uuid&&(this.constructor.uuid=V.MathUtils.generateUUID()),n=t.getUuid(n||this.getUuid(),!o);var i=t.getNodeData(n),a=i.output||this.getType(t);if(t.analyzing)return(i.deps||0)>0||this.getLabel()?(this.appendDepsNode(t,i,e),this.generate(t,e,n)):J.prototype.build.call(this,t,e,n);if(o)return i.name=i.name||J.prototype.build.call(this,t,e,n),i.name;if(!this.getLabel()&&(!this.getShared(t,a)||t.context.ignoreCache||1===i.deps))return J.prototype.build.call(this,t,e,n);n=this.getUuid(!1);var s=this.getTemp(t,n);if(s)return t.format(s,a,e);s=q.prototype.generate.call(this,t,e,n,i.output,r);var u=this.generate(t,a,n);return t.addNodeCode(s+" = "+u+";"),t.format(s,a,e)}return J.prototype.build.call(this,t,e,n)},q.prototype.getShared=function(t,e){return"sampler2D"!==e&&"samplerCube"!==e&&this.shared},q.prototype.getUnique=function(){return this.unique},q.prototype.setLabel=function(t){return this.label=t,this},q.prototype.getLabel=function(){return this.label},q.prototype.getUuid=function(t){var e=(t||null==t)&&this.constructor.uuid||this.uuid;return"string"==typeof this.scope&&(e=this.scope+"-"+e),e},q.prototype.getTemp=function(t,e){e=e||this.uuid;var n=t.getVars()[e];return n?n.name:void 0},q.prototype.generate=function(t,e,n,r,o){return this.getShared(t,e)||console.error("THREE.TempNode is not shared!"),n=n||this.uuid,t.getTempVar(n,r||this.getType(t),o,this.getLabel()).name};var X=/^\s*([a-z_0-9]+)\s([a-z_0-9]+)\s*\((.*?)\)/i,Y=/[a-z_0-9]+/gi;function Z(t,e,n,r,o){this.isMethod=void 0===o,this.isInterface=!1,q.call(this,o),this.parse(t,e,n,r)}Z.prototype=Object.create(q.prototype),Z.prototype.constructor=Z,Z.prototype.nodeType="Function",Z.prototype.useKeywords=!0,Z.prototype.getShared=function(){return!this.isMethod},Z.prototype.getType=function(t){return t.getTypeByFormat(this.type)},Z.prototype.getInputByName=function(t){for(var e=this.inputs.length;e--;)if(this.inputs[e].name===t)return this.inputs[e]},Z.prototype.getIncludeByName=function(t){for(var e=this.includes.length;e--;)if(this.includes[e].name===t)return this.includes[e]},Z.prototype.generate=function(t,e){for(var n=0,r=this.src,o=0;o<this.includes.length;o++)t.include(this.includes[o],this);for(var i in this.extensions)t.extensions[i]=!0;for(var a=[];s=Y.exec(this.src);)a.push(s);for(o=0;o<a.length;o++){var s,u=(s=a[o])[0],l=!this.isMethod||!this.getInputByName(u),c=u;if(this.keywords[u]||this.useKeywords&&l&&G.containsKeyword(u)){var h=this.keywords[u];if(!h){var p=G.getKeywordData(u);p.cache&&(h=t.keywords[u]),h=h||G.getKeyword(u,t),p.cache&&(t.keywords[u]=h)}c=h.build(t)}u!==c&&(r=r.substring(0,s.index+n)+c+r.substring(s.index+u.length+n),n+=c.length-u.length),void 0===this.getIncludeByName(c)&&G.contains(c)&&t.include(G.get(c))}return"source"===e?r:this.isMethod?(this.isInterface||t.include(this,!1,r),this.name):t.format("( "+r+" )",this.getType(t),e)},Z.prototype.parse=function(t,e,n,r){if(this.src=t||"",this.includes=e||[],this.extensions=n||{},this.keywords=r||{},this.isMethod){var o=this.src.match(X);if(this.inputs=[],o&&4==o.length){this.type=o[1],this.name=o[2];var i=o[3].match(Y);if(i)for(var a=0;a<i.length;){var s,u,l=i[a++];"in"===l||"out"===l||"inout"===l?s=i[a++]:(s=l,l=""),u=i[a++],this.inputs.push({name:u,type:s,qualifier:l})}this.isInterface=-1===this.src.indexOf("{")}else this.type="",this.name=""}},Z.prototype.copy=function(t){return q.prototype.copy.call(this,t),this.isMethod=t.isMethod,this.useKeywords=t.useKeywords,this.parse(t.src,t.includes,t.extensions,t.keywords),void 0!==t.type&&(this.type=t.type),this},Z.prototype.toJSON=function(t){var e=this.getJSONNode(t);if(!e){for(var n in(e=this.createJSONNode(t)).src=this.src,e.isMethod=this.isMethod,e.useKeywords=this.useKeywords,this.isMethod||(e.type=this.type),e.extensions=JSON.parse(JSON.stringify(this.extensions)),e.keywords={},this.keywords)e.keywords[n]=this.keywords[n].toJSON(t).uuid;if(this.includes.length){e.includes=[];for(var r=0;r<this.includes.length;r++)e.includes.push(this.includes[r].toJSON(t).uuid)}}return e};var W=/^([a-z_0-9]+)\s([a-z_0-9]+)\s?\=?\s?(.*?)(\;|$)/i;function H(t,e){q.call(this),this.parse(t||H.PI,e)}H.PI="PI",H.PI2="PI2",H.RECIPROCAL_PI="RECIPROCAL_PI",H.RECIPROCAL_PI2="RECIPROCAL_PI2",H.LOG2="LOG2",H.EPSILON="EPSILON",H.prototype=Object.create(q.prototype),H.prototype.constructor=H,H.prototype.nodeType="Const",H.prototype.getType=function(t){return t.getTypeByFormat(this.type)},H.prototype.parse=function(t,e){this.src=t||"";var n,r,o="",i=this.src.match(W);this.useDefine=e||"#"===this.src.charAt(0),i&&i.length>1?(r=i[1],n=i[2],o=i[3]):(n=this.src,r="f"),this.name=n,this.type=r,this.value=o},H.prototype.build=function(t,e){return"source"!==e?(t.include(this),t.format(this.name,this.getType(t),e)):this.value?this.useDefine?"#define "+this.name+" "+this.value:"const "+this.type+" "+this.name+" = "+this.value+";":this.useDefine?this.src:void 0},H.prototype.generate=function(t,e){return t.format(this.name,this.getType(t),e)},H.prototype.copy=function(t){return q.prototype.copy.call(this,t),this.parse(t.src,t.useDefine),this},H.prototype.toJSON=function(t){var e=this.getJSONNode(t);return e||((e=this.createJSONNode(t)).src=this.src,!0===e.useDefine&&(e.useDefine=!0)),e};var K,Q,$=/^struct\s*([a-z_0-9]+)\s*{\s*((.|\n)*?)}/gim,tt=/\s*(\w*?)\s*(\w*?)(\=|\;)/gim;function et(t){q.call(this),this.parse(t)}function nt(t,e){(e=e||{}).shared=void 0!==e.shared&&e.shared,q.call(this,t,e),this.readonly=!1}function rt(t,e){nt.call(this,"v2"),this.value=t instanceof V.Vector2?t:new V.Vector2(t,e)}function ot(t,e,n){nt.call(this,"v3"),this.value=t instanceof V.Vector3?t:new V.Vector3(t,e,n)}function it(t,e,n,r){nt.call(this,"v4"),this.value=t instanceof V.Vector4?t:new V.Vector4(t,e,n,r)}function at(t){q.call(this,"v2",{shared:!1}),this.index=t||0}function st(t){nt.call(this,"f"),this.value=t||0}function ut(t,e,n,r,o){Z.call(this,t,o,r,n,e)}function lt(t,e){q.call(this,"v4"),this.input=t,this.method=e||lt.LINEAR_TO_LINEAR}function ct(t,e,n,r){nt.call(this,"v4",{shared:!0}),this.value=t,this.uv=e||new at,this.bias=n,this.project=void 0!==r&&r}function ht(t){q.call(this,"v3"),this.scope=t||ht.LOCAL}function pt(t){q.call(this,"v3"),this.scope=t||pt.VIEW}function ft(t){q.call(this,"v3"),this.scope=t||ft.CUBE}function dt(t,e,n){nt.call(this,"v4",{shared:!0}),this.value=t,this.uv=e||new ft,this.bias=n}function vt(t,e){q.call(this),this.setFunction(t,e)}function mt(t,e,n){q.call(this),this.a=t,this.b=e,this.op=n}function gt(t,e,n,r){q.call(this),this.a=t,"string"!=typeof e?this.b=e:r=e,"string"!=typeof n?this.c=n:r=n,this.method=r}function yt(t,e,n){q.call(this,"v4"),this.value=t,this.uv=e,this.bias=n}function xt(t,e,n){q.call(this,"v4"),this.value=t,this.radianceNode=new yt(this.value,e||new ft(ft.VECTOR),n),this.irradianceNode=new yt(this.value,new pt(pt.WORLD),new st(1).setReadonly(!0))}et.prototype=Object.create(q.prototype),et.prototype.constructor=et,et.prototype.nodeType="Struct",et.prototype.getType=function(t){return t.getTypeByFormat(this.name)},et.prototype.getInputByName=function(t){for(var e=this.inputs.length;e--;)if(this.inputs[e].name===t)return this.inputs[e]},et.prototype.generate=function(t,e){return"source"===e?this.src+";":t.format("( "+this.src+" )",this.getType(t),e)},et.prototype.parse=function(t){this.src=t||"",this.inputs=[];var e=$.exec(this.src);if(e){for(var n,r=e[2];n=tt.exec(r);)this.inputs.push({type:n[1],name:n[2]});this.name=e[1]}else this.name="";this.type=this.name},et.prototype.toJSON=function(t){var e=this.getJSONNode(t);return e||((e=this.createJSONNode(t)).src=this.src),e},nt.prototype=Object.create(q.prototype),nt.prototype.constructor=nt,nt.prototype.setReadonly=function(t){return this.readonly=t,this.hashProperties=this.readonly?["value"]:void 0,this},nt.prototype.getReadonly=function(){return this.readonly},nt.prototype.copy=function(t){return q.prototype.copy.call(this,t),void 0!==t.readonly&&(this.readonly=t.readonly),this},nt.prototype.createJSONNode=function(t){var e=q.prototype.createJSONNode.call(this,t);return!0===this.readonly&&(e.readonly=this.readonly),e},nt.prototype.generate=function(t,e,n,r,o,i){n=t.getUuid(n||this.getUuid()),r=r||this.getType(t);var a=t.getNodeData(n);return this.getReadonly(t)&&void 0!==this.generateReadonly?this.generateReadonly(t,e,n,r,o,i):t.isShader("vertex")?(a.vertex||(a.vertex=t.createVertexUniform(r,this,o,i,this.getLabel())),t.format(a.vertex.name,r,e)):(a.fragment||(a.fragment=t.createFragmentUniform(r,this,o,i,this.getLabel())),t.format(a.fragment.name,r,e))},rt.prototype=Object.create(nt.prototype),rt.prototype.constructor=rt,rt.prototype.nodeType="Vector2",U.addShortcuts(rt.prototype,"value",["x","y"]),rt.prototype.generateReadonly=function(t,e,n,r){return t.format("vec2( "+this.x+", "+this.y+" )",r,e)},rt.prototype.copy=function(t){return nt.prototype.copy.call(this,t),this.value.copy(t),this},rt.prototype.toJSON=function(t){var e=this.getJSONNode(t);return e||((e=this.createJSONNode(t)).x=this.x,e.y=this.y,!0===this.readonly&&(e.readonly=!0)),e},ot.prototype=Object.create(nt.prototype),ot.prototype.constructor=ot,ot.prototype.nodeType="Vector3",U.addShortcuts(ot.prototype,"value",["x","y","z"]),ot.prototype.generateReadonly=function(t,e,n,r){return t.format("vec3( "+this.x+", "+this.y+", "+this.z+" )",r,e)},ot.prototype.copy=function(t){return nt.prototype.copy.call(this,t),this.value.copy(t),this},ot.prototype.toJSON=function(t){var e=this.getJSONNode(t);return e||((e=this.createJSONNode(t)).x=this.x,e.y=this.y,e.z=this.z,!0===this.readonly&&(e.readonly=!0)),e},it.prototype=Object.create(nt.prototype),it.prototype.constructor=it,it.prototype.nodeType="Vector4",U.addShortcuts(it.prototype,"value",["x","y","z","w"]),it.prototype.generateReadonly=function(t,e,n,r){return t.format("vec4( "+this.x+", "+this.y+", "+this.z+", "+this.w+" )",r,e)},it.prototype.copy=function(t){return nt.prototype.copy.call(this,t),this.value.copy(t),this},it.prototype.toJSON=function(t){var e=this.getJSONNode(t);return e||((e=this.createJSONNode(t)).x=this.x,e.y=this.y,e.z=this.z,e.w=this.w,!0===this.readonly&&(e.readonly=!0)),e},at.prototype=Object.create(q.prototype),at.prototype.constructor=at,at.prototype.nodeType="UV",at.prototype.generate=function(t,e){t.requires.uv[this.index]=!0;var n=this.index>0?this.index+1:"",r=t.isShader("vertex")?"uv"+n:"vUv"+n;return t.format(r,this.getType(t),e)},at.prototype.copy=function(t){return q.prototype.copy.call(this,t),this.index=t.index,this},at.prototype.toJSON=function(t){var e=this.getJSONNode(t);return e||((e=this.createJSONNode(t)).index=this.index),e},G.addKeyword("uv",(function(){return new at})),G.addKeyword("uv2",(function(){return new at(1)})),st.prototype=Object.create(nt.prototype),st.prototype.constructor=st,st.prototype.nodeType="Float",st.prototype.generateReadonly=function(t,e,n,r){return t.format(this.value+(this.value%1?"":".0"),r,e)},st.prototype.copy=function(t){return nt.prototype.copy.call(this,t),this.value=t.value,this},st.prototype.toJSON=function(t){var e=this.getJSONNode(t);return e||((e=this.createJSONNode(t)).value=this.value,!0===this.readonly&&(e.readonly=!0)),e},ut.prototype=Object.create(Z.prototype),ut.prototype.constructor=ut,ut.prototype.nodeType="Expression",lt.Nodes={LinearToLinear:new Z(["vec4 LinearToLinear( in vec4 value ) {","\treturn value;","}"].join("\n")),GammaToLinear:new Z(["vec4 GammaToLinear( in vec4 value, in float gammaFactor ) {","\treturn vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );","}"].join("\n")),LinearToGamma:new Z(["vec4 LinearToGamma( in vec4 value, in float gammaFactor ) {","\treturn vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );","}"].join("\n")),sRGBToLinear:new Z(["vec4 sRGBToLinear( in vec4 value ) {","\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );","}"].join("\n")),LinearTosRGB:new Z(["vec4 LinearTosRGB( in vec4 value ) {","\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.w );","}"].join("\n")),RGBEToLinear:new Z(["vec4 RGBEToLinear( in vec4 value ) {","\treturn vec4( value.rgb * exp2( value.a * 255.0 - 128.0 ), 1.0 );","}"].join("\n")),LinearToRGBE:new Z(["vec4 LinearToRGBE( in vec4 value ) {","\tfloat maxComponent = max( max( value.r, value.g ), value.b );","\tfloat fExp = clamp( ceil( log2( maxComponent ) ), -128.0, 127.0 );","\treturn vec4( value.rgb / exp2( fExp ), ( fExp + 128.0 ) / 255.0 );","}"].join("\n")),RGBMToLinear:new Z(["vec3 RGBMToLinear( in vec4 value, in float maxRange ) {","\treturn vec4( value.xyz * value.w * maxRange, 1.0 );","}"].join("\n")),LinearToRGBM:new Z(["vec3 LinearToRGBM( in vec4 value, in float maxRange ) {","\tfloat maxRGB = max( value.x, max( value.g, value.b ) );","\tfloat M      = clamp( maxRGB / maxRange, 0.0, 1.0 );","\tM            = ceil( M * 255.0 ) / 255.0;","\treturn vec4( value.rgb / ( M * maxRange ), M );","}"].join("\n")),RGBDToLinear:new Z(["vec3 RGBDToLinear( in vec4 value, in float maxRange ) {","\treturn vec4( value.rgb * ( ( maxRange / 255.0 ) / value.a ), 1.0 );","}"].join("\n")),LinearToRGBD:new Z(["vec3 LinearToRGBD( in vec4 value, in float maxRange ) {","\tfloat maxRGB = max( value.x, max( value.g, value.b ) );","\tfloat D      = max( maxRange / maxRGB, 1.0 );","\tD            = clamp( floor( D ) / 255.0, 0.0, 1.0 );","\treturn vec4( value.rgb * ( D * ( 255.0 / maxRange ) ), D );","}"].join("\n")),cLogLuvM:K=new H("const mat3 cLogLuvM = mat3( 0.2209, 0.3390, 0.4184, 0.1138, 0.6780, 0.7319, 0.0102, 0.1130, 0.2969 );"),LinearToLogLuv:new Z(["vec4 LinearToLogLuv( in vec4 value ) {","\tvec3 Xp_Y_XYZp = cLogLuvM * value.rgb;","\tXp_Y_XYZp = max(Xp_Y_XYZp, vec3(1e-6, 1e-6, 1e-6));","\tvec4 vResult;","\tvResult.xy = Xp_Y_XYZp.xy / Xp_Y_XYZp.z;","\tfloat Le = 2.0 * log2(Xp_Y_XYZp.y) + 127.0;","\tvResult.w = fract(Le);","\tvResult.z = (Le - (floor(vResult.w*255.0))/255.0)/255.0;","\treturn vResult;","}"].join("\n"),[K]),cLogLuvInverseM:Q=new H("const mat3 cLogLuvInverseM = mat3( 6.0014, -2.7008, -1.7996, -1.3320, 3.1029, -5.7721, 0.3008, -1.0882, 5.6268 );"),LogLuvToLinear:new Z(["vec4 LogLuvToLinear( in vec4 value ) {","\tfloat Le = value.z * 255.0 + value.w;","\tvec3 Xp_Y_XYZp;","\tXp_Y_XYZp.y = exp2((Le - 127.0) / 2.0);","\tXp_Y_XYZp.z = Xp_Y_XYZp.y / value.y;","\tXp_Y_XYZp.x = value.x * Xp_Y_XYZp.z;","\tvec3 vRGB = cLogLuvInverseM * Xp_Y_XYZp.rgb;","\treturn vec4( max(vRGB, 0.0), 1.0 );","}"].join("\n"),[Q])},lt.LINEAR_TO_LINEAR="LinearToLinear",lt.GAMMA_TO_LINEAR="GammaToLinear",lt.LINEAR_TO_GAMMA="LinearToGamma",lt.SRGB_TO_LINEAR="sRGBToLinear",lt.LINEAR_TO_SRGB="LinearTosRGB",lt.RGBE_TO_LINEAR="RGBEToLinear",lt.LINEAR_TO_RGBE="LinearToRGBE",lt.RGBM_TO_LINEAR="RGBMToLinear",lt.LINEAR_TO_RGBM="LinearToRGBM",lt.RGBD_TO_LINEAR="RGBDToLinear",lt.LINEAR_TO_RGBD="LinearToRGBD",lt.LINEAR_TO_LOG_LUV="LinearToLogLuv",lt.LOG_LUV_TO_LINEAR="LogLuvToLinear",lt.getEncodingComponents=function(t){switch(t){case V.LinearEncoding:return["Linear"];case V.sRGBEncoding:return["sRGB"];case V.RGBEEncoding:return["RGBE"];case V.RGBM7Encoding:return["RGBM",new st(7).setReadonly(!0)];case V.RGBM16Encoding:return["RGBM",new st(16).setReadonly(!0)];case V.RGBDEncoding:return["RGBD",new st(256).setReadonly(!0)];case V.GammaEncoding:return["Gamma",new ut("float( GAMMA_FACTOR )","f")]}},lt.prototype=Object.create(q.prototype),lt.prototype.constructor=lt,lt.prototype.nodeType="ColorSpace",lt.prototype.hashProperties=["method"],lt.prototype.generate=function(t,e){var n=this.input.build(t,"v4"),r=this.getType(t),o=lt.Nodes[this.method],i=t.include(o);if(i===lt.LINEAR_TO_LINEAR)return t.format(n,r,e);if(2===o.inputs.length){var a=this.factor.build(t,"f");return t.format(i+"( "+n+", "+a+" )",r,e)}return t.format(i+"( "+n+" )",r,e)},lt.prototype.fromEncoding=function(t){var e=lt.getEncodingComponents(t);this.method="LinearTo"+e[0],this.factor=e[1]},lt.prototype.fromDecoding=function(t){var e=lt.getEncodingComponents(t);this.method=e[0]+"ToLinear",this.factor=e[1]},lt.prototype.copy=function(t){return q.prototype.copy.call(this,t),this.input=t.input,this.method=t.method,this},lt.prototype.toJSON=function(t){var e=this.getJSONNode(t);return e||((e=this.createJSONNode(t)).input=this.input.toJSON(t).uuid,e.method=this.method),e},ct.prototype=Object.create(nt.prototype),ct.prototype.constructor=ct,ct.prototype.nodeType="Texture",ct.prototype.getTexture=function(t,e){return nt.prototype.generate.call(this,t,e,this.value.uuid,"t")},ct.prototype.generate=function(t,e){if("sampler2D"===e)return this.getTexture(t,e);var n,r,o=this.getTexture(t,e),i=this.uv.build(t,this.project?"v4":"v2"),a=this.bias?this.bias.build(t,"f"):void 0;void 0===a&&t.context.bias&&(a=t.context.bias.setTexture(this).build(t,"f")),n=this.project?"texture2DProj":a?"tex2DBias":"tex2D",r=a?n+"( "+o+", "+i+", "+a+" )":n+"( "+o+", "+i+" )";var s={include:t.isShader("vertex"),ignoreCache:!0},u=this.getType(t);return t.addContext(s),this.colorSpace=this.colorSpace||new lt(new ut("",u)),this.colorSpace.fromDecoding(t.getTextureEncodingFromMap(this.value)),this.colorSpace.input.parse(r),r=this.colorSpace.build(t,u),t.removeContext(),t.format(r,u,e)},ct.prototype.copy=function(t){return nt.prototype.copy.call(this,t),t.value&&(this.value=t.value),this.uv=t.uv,t.bias&&(this.bias=t.bias),void 0!==t.project&&(this.project=t.project),this},ct.prototype.toJSON=function(t){var e=this.getJSONNode(t);return e||(e=this.createJSONNode(t),this.value&&(e.value=this.value.uuid),e.uv=this.uv.toJSON(t).uuid,e.project=this.project,this.bias&&(e.bias=this.bias.toJSON(t).uuid)),e},ht.LOCAL="local",ht.WORLD="world",ht.VIEW="view",ht.PROJECTION="projection",ht.prototype=Object.create(q.prototype),ht.prototype.constructor=ht,ht.prototype.nodeType="Position",ht.prototype.getType=function(){switch(this.scope){case ht.PROJECTION:return"v4"}return this.type},ht.prototype.getShared=function(){switch(this.scope){case ht.LOCAL:case ht.WORLD:return!1}return!0},ht.prototype.generate=function(t,e){var n;switch(this.scope){case ht.LOCAL:t.isShader("vertex")?n="transformed":(t.requires.position=!0,n="vPosition");break;case ht.WORLD:if(t.isShader("vertex"))return"( modelMatrix * vec4( transformed, 1.0 ) ).xyz";t.requires.worldPosition=!0,n="vWPosition";break;case ht.VIEW:n=t.isShader("vertex")?"-mvPosition.xyz":"vViewPosition";break;case ht.PROJECTION:n=t.isShader("vertex")?"( projectionMatrix * modelViewMatrix * vec4( position, 1.0 ) )":"vec4( 0.0 )"}return t.format(n,this.getType(t),e)},ht.prototype.copy=function(t){return q.prototype.copy.call(this,t),this.scope=t.scope,this},ht.prototype.toJSON=function(t){var e=this.getJSONNode(t);return e||((e=this.createJSONNode(t)).scope=this.scope),e},G.addKeyword("position",(function(){return new ht})),G.addKeyword("worldPosition",(function(){return new ht(ht.WORLD)})),G.addKeyword("viewPosition",(function(){return new ht(ht.VIEW)})),pt.LOCAL="local",pt.WORLD="world",pt.VIEW="view",pt.prototype=Object.create(q.prototype),pt.prototype.constructor=pt,pt.prototype.nodeType="Normal",pt.prototype.getShared=function(){return this.scope===pt.WORLD},pt.prototype.build=function(t,e,n,r){var o=t.context[this.scope+"Normal"];return o?o.build(t,e,n,r):q.prototype.build.call(this,t,e,n)},pt.prototype.generate=function(t,e){var n;switch(this.scope){case pt.VIEW:n=t.isShader("vertex")?"transformedNormal":"geometryNormal";break;case pt.LOCAL:t.isShader("vertex")?n="objectNormal":(t.requires.normal=!0,n="vObjectNormal");break;case pt.WORLD:t.isShader("vertex")?n="inverseTransformDirection( transformedNormal, viewMatrix ).xyz":(t.requires.worldNormal=!0,n="vWNormal")}return t.format(n,this.getType(t),e)},pt.prototype.copy=function(t){return q.prototype.copy.call(this,t),this.scope=t.scope,this},pt.prototype.toJSON=function(t){var e=this.getJSONNode(t);return e||((e=this.createJSONNode(t)).scope=this.scope),e},G.addKeyword("viewNormal",(function(){return new pt(pt.VIEW)})),G.addKeyword("localNormal",(function(){return new pt(pt.NORMAL)})),G.addKeyword("worldNormal",(function(){return new pt(pt.WORLD)})),ft.CUBE="cube",ft.SPHERE="sphere",ft.VECTOR="vector",ft.prototype=Object.create(q.prototype),ft.prototype.constructor=ft,ft.prototype.nodeType="Reflect",ft.prototype.getUnique=function(t){return!t.context.viewNormal},ft.prototype.getType=function(){switch(this.scope){case ft.SPHERE:return"v2"}return this.type},ft.prototype.generate=function(t,e){var n=this.getUnique(t);if(t.isShader("fragment")){var r;switch(this.scope){case ft.VECTOR:var o=new pt(pt.VIEW),i=t.context.roughness,a=o.build(t,"v3"),s=new ht(ht.VIEW).build(t,"v3"),u=i?i.build(t,"f"):void 0,l="reflect( -normalize( ".concat(s," ), ").concat(a," )");u&&(l="normalize( mix( ".concat(l,", ").concat(a,", ").concat(u," * ").concat(u," ) )"));var c="inverseTransformDirection( ".concat(l,", viewMatrix )");n?(t.addNodeCode("vec3 reflectVec = ".concat(c,";")),r="reflectVec"):r=c;break;case ft.CUBE:c="vec3( -"+(h=new ft(ft.VECTOR).build(t,"v3"))+".x, "+h+".yz )",n?(t.addNodeCode("vec3 reflectCubeVec = ".concat(c,";")),r="reflectCubeVec"):r=c;break;case ft.SPHERE:var h;c="normalize( ( viewMatrix * vec4( "+(h=new ft(ft.VECTOR).build(t,"v3"))+", 0.0 ) ).xyz + vec3( 0.0, 0.0, 1.0 ) ).xy * 0.5 + 0.5",n?(t.addNodeCode("vec2 reflectSphereVec = ".concat(c,";")),r="reflectSphereVec"):r=c}return t.format(r,this.getType(t),e)}return console.warn("THREE.ReflectNode is not compatible with "+t.shader+" shader."),t.format("vec3( 0.0 )",this.type,e)},ft.prototype.toJSON=function(t){var e=this.getJSONNode(t);return e||((e=this.createJSONNode(t)).scope=this.scope),e},dt.prototype=Object.create(nt.prototype),dt.prototype.constructor=dt,dt.prototype.nodeType="CubeTexture",dt.prototype.getTexture=function(t,e){return nt.prototype.generate.call(this,t,e,this.value.uuid,"tc")},dt.prototype.generate=function(t,e){if("samplerCube"===e)return this.getTexture(t,e);var n,r=this.getTexture(t,e),o=this.uv.build(t,"v3"),i=this.bias?this.bias.build(t,"f"):void 0;void 0===i&&t.context.bias&&(i=t.context.bias.setTexture(this).build(t,"f")),n=i?"texCubeBias( "+r+", "+o+", "+i+" )":"texCube( "+r+", "+o+" )";var a={include:t.isShader("vertex"),ignoreCache:!0},s=this.getType(t);return t.addContext(a),this.colorSpace=this.colorSpace||new lt(new ut("",s)),this.colorSpace.fromDecoding(t.getTextureEncodingFromMap(this.value)),this.colorSpace.input.parse(n),n=this.colorSpace.build(t,s),t.removeContext(),t.format(n,s,e)},dt.prototype.copy=function(t){return nt.prototype.copy.call(this,t),t.value&&(this.value=t.value),this.uv=t.uv,t.bias&&(this.bias=t.bias),this},dt.prototype.toJSON=function(t){var e=this.getJSONNode(t);return e||((e=this.createJSONNode(t)).value=this.value.uuid,e.uv=this.uv.toJSON(t).uuid,this.bias&&(e.bias=this.bias.toJSON(t).uuid)),e},vt.prototype=Object.create(q.prototype),vt.prototype.constructor=vt,vt.prototype.nodeType="FunctionCall",vt.prototype.setFunction=function(t,e){this.value=t,this.inputs=e||[]},vt.prototype.getFunction=function(){return this.value},vt.prototype.getType=function(t){return this.value.getType(t)},vt.prototype.generate=function(t,e){for(var n=this.getType(t),r=this.value,o=r.build(t,e)+"( ",i=[],a=0;a<r.inputs.length;a++){var s=r.inputs[a],u=this.inputs[a]||this.inputs[s.name];i.push(u.build(t,t.getTypeByFormat(s.type)))}return o+=i.join(", ")+" )",t.format(o,n,e)},vt.prototype.copy=function(t){for(var e in q.prototype.copy.call(this,t),t.inputs)this.inputs[e]=t.inputs[e];return this.value=t.value,this},vt.prototype.toJSON=function(t){var e=this.getJSONNode(t);if(!e){var n=this.value;if((e=this.createJSONNode(t)).value=this.value.toJSON(t).uuid,n.inputs.length){e.inputs={};for(var r=0;r<n.inputs.length;r++){var o=n.inputs[r],i=this.inputs[r]||this.inputs[o.name];e.inputs[o.name]=i.toJSON(t).uuid}}}return e},mt.ADD="+",mt.SUB="-",mt.MUL="*",mt.DIV="/",mt.prototype=Object.create(q.prototype),mt.prototype.constructor=mt,mt.prototype.nodeType="Operator",mt.prototype.getType=function(t){var e=this.a.getType(t),n=this.b.getType(t);return t.isTypeMatrix(e)?"v4":t.getTypeLength(n)>t.getTypeLength(e)?n:e},mt.prototype.generate=function(t,e){var n=this.getType(t),r=this.a.build(t,n),o=this.b.build(t,n);return t.format("( "+r+" "+this.op+" "+o+" )",n,e)},mt.prototype.copy=function(t){return q.prototype.copy.call(this,t),this.a=t.a,this.b=t.b,this.op=t.op,this},mt.prototype.toJSON=function(t){var e=this.getJSONNode(t);return e||((e=this.createJSONNode(t)).a=this.a.toJSON(t).uuid,e.b=this.b.toJSON(t).uuid,e.op=this.op),e},gt.RAD="radians",gt.DEG="degrees",gt.EXP="exp",gt.EXP2="exp2",gt.LOG="log",gt.LOG2="log2",gt.SQRT="sqrt",gt.INV_SQRT="inversesqrt",gt.FLOOR="floor",gt.CEIL="ceil",gt.NORMALIZE="normalize",gt.FRACT="fract",gt.SATURATE="saturate",gt.SIN="sin",gt.COS="cos",gt.TAN="tan",gt.ASIN="asin",gt.ACOS="acos",gt.ARCTAN="atan",gt.ABS="abs",gt.SIGN="sign",gt.LENGTH="length",gt.NEGATE="negate",gt.INVERT="invert",gt.MIN="min",gt.MAX="max",gt.MOD="mod",gt.STEP="step",gt.REFLECT="reflect",gt.DISTANCE="distance",gt.DOT="dot",gt.CROSS="cross",gt.POW="pow",gt.MIX="mix",gt.CLAMP="clamp",gt.REFRACT="refract",gt.SMOOTHSTEP="smoothstep",gt.FACEFORWARD="faceforward",gt.prototype=Object.create(q.prototype),gt.prototype.constructor=gt,gt.prototype.nodeType="Math",gt.prototype.hashProperties=["method"],gt.prototype.getNumInputs=function(){switch(this.method){case gt.MIX:case gt.CLAMP:case gt.REFRACT:case gt.SMOOTHSTEP:case gt.FACEFORWARD:return 3;case gt.MIN:case gt.MAX:case gt.MOD:case gt.STEP:case gt.REFLECT:case gt.DISTANCE:case gt.DOT:case gt.CROSS:case gt.POW:return 2;default:return 1}},gt.prototype.getInputType=function(t){var e=t.getTypeLength(this.a.getType(t)),n=this.b?t.getTypeLength(this.b.getType(t)):0,r=this.c?t.getTypeLength(this.c.getType(t)):0;return e>n&&e>r?this.a.getType(t):n>r?this.b.getType(t):this.c.getType(t)},gt.prototype.getType=function(t){switch(this.method){case gt.LENGTH:case gt.DISTANCE:case gt.DOT:return"f";case gt.CROSS:return"v3"}return this.getInputType(t)},gt.prototype.generate=function(t,e){var n,r,o,i=this.a?t.getTypeLength(this.a.getType(t)):0,a=this.b?t.getTypeLength(this.b.getType(t)):0,s=this.c?t.getTypeLength(this.c.getType(t)):0,u=this.getInputType(t),l=this.getType(t);switch(this.method){case gt.NEGATE:return t.format("( -"+this.a.build(t,u)+" )",u,e);case gt.INVERT:return t.format("( 1.0 - "+this.a.build(t,u)+" )",u,e);case gt.CROSS:n=this.a.build(t,"v3"),r=this.b.build(t,"v3");break;case gt.STEP:n=this.a.build(t,1===i?"f":u),r=this.b.build(t,u);break;case gt.MIN:case gt.MAX:case gt.MOD:n=this.a.build(t,u),r=this.b.build(t,1===a?"f":u);break;case gt.REFRACT:n=this.a.build(t,u),r=this.b.build(t,u),o=this.c.build(t,"f");break;case gt.MIX:n=this.a.build(t,u),r=this.b.build(t,u),o=this.c.build(t,1===s?"f":u);break;default:n=this.a.build(t,u),this.b&&(r=this.b.build(t,u)),this.c&&(o=this.c.build(t,u))}var c=[];c.push(n),r&&c.push(r),o&&c.push(o);var h=this.getNumInputs(t);if(c.length!==h)throw Error('Arguments not match used in "'.concat(this.method,'". Require ').concat(h,", currently ").concat(c.length,"."));return t.format(this.method+"( "+c.join(", ")+" )",l,e)},gt.prototype.copy=function(t){return q.prototype.copy.call(this,t),this.a=t.a,this.b=t.b,this.c=t.c,this.method=t.method,this},gt.prototype.toJSON=function(t){var e=this.getJSONNode(t);return e||((e=this.createJSONNode(t)).a=this.a.toJSON(t).uuid,this.b&&(e.b=this.b.toJSON(t).uuid),this.c&&(e.c=this.c.toJSON(t).uuid),e.method=this.method),e},yt.Nodes=function(){var t=new et("struct TextureCubeUVData {\n\t\t\tvec4 tl;\n\t\t\tvec4 tr;\n\t\t\tvec4 br;\n\t\t\tvec4 bl;\n\t\t\tvec2 f;\n\t\t}"),e=new H("float cubeUV_maxMipLevel 8.0",!0),n=new H("float cubeUV_minMipLevel 4.0",!0),r=new H("float cubeUV_maxTileSize 256.0",!0),o=new H("float cubeUV_minTileSize 16.0",!0),i=new Z("float getFace(vec3 direction) {\n\t\t\t\tvec3 absDirection = abs(direction);\n\t\t\t\tfloat face = -1.0;\n\t\t\t\tif (absDirection.x > absDirection.z) {\n\t\t\t\t\tif (absDirection.x > absDirection.y)\n\t\t\t\t\t\tface = direction.x > 0.0 ? 0.0 : 3.0;\n\t\t\t\t\telse\n\t\t\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t\t\t} else {\n\t\t\t\t\tif (absDirection.z > absDirection.y)\n\t\t\t\t\t\tface = direction.z > 0.0 ? 2.0 : 5.0;\n\t\t\t\t\telse\n\t\t\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t\t\t}\n\t\t\t\treturn face;\n\t\t}");i.useKeywords=!1;var a=new Z("vec2 getUV(vec3 direction, float face) {\n\t\t\t\tvec2 uv;\n\t\t\t\tif (face == 0.0) {\n\t\t\t\t\tuv = vec2(direction.z, direction.y) / abs(direction.x); // pos x\n\t\t\t\t} else if (face == 1.0) {\n\t\t\t\t\tuv = vec2(-direction.x, -direction.z) / abs(direction.y); // pos y\n\t\t\t\t} else if (face == 2.0) {\n\t\t\t\t\tuv = vec2(-direction.x, direction.y) / abs(direction.z); // pos z\n\t\t\t\t} else if (face == 3.0) {\n\t\t\t\t\tuv = vec2(-direction.z, direction.y) / abs(direction.x); // neg x\n\t\t\t\t} else if (face == 4.0) {\n\t\t\t\t\tuv = vec2(-direction.x, direction.z) / abs(direction.y); // neg y\n\t\t\t\t} else {\n\t\t\t\t\tuv = vec2(direction.x, direction.y) / abs(direction.z); // neg z\n\t\t\t\t}\n\t\t\t\treturn 0.5 * (uv + 1.0);\n\t\t}");a.useKeywords=!1;var s=new Z("TextureCubeUVData bilinearCubeUV(sampler2D envMap, vec3 direction, float mipInt) {\n\n\t\t\tfloat face = getFace(direction);\n\t\t\tfloat filterInt = max(cubeUV_minMipLevel - mipInt, 0.0);\n\t\t\tmipInt = max(mipInt, cubeUV_minMipLevel);\n\t\t\tfloat faceSize = exp2(mipInt);\n\n\t\t\tfloat texelSize = 1.0 / (3.0 * cubeUV_maxTileSize);\n\n\t\t\tvec2 uv = getUV(direction, face) * (faceSize - 1.0);\n\t\t\tvec2 f = fract(uv);\n\t\t\tuv += 0.5 - f;\n\t\t\tif (face > 2.0) {\n\t\t\t\tuv.y += faceSize;\n\t\t\t\tface -= 3.0;\n\t\t\t}\n\t\t\tuv.x += face * faceSize;\n\t\t\tif(mipInt < cubeUV_maxMipLevel){\n\t\t\t\tuv.y += 2.0 * cubeUV_maxTileSize;\n\t\t\t}\n\t\t\tuv.y += filterInt * 2.0 * cubeUV_minTileSize;\n\t\t\tuv.x += 3.0 * max(0.0, cubeUV_maxTileSize - 2.0 * faceSize);\n\t\t\tuv *= texelSize;\n\n\t\t\tvec4 tl = texture2D(envMap, uv);\n\t\t\tuv.x += texelSize;\n\t\t\tvec4 tr = texture2D(envMap, uv);\n\t\t\tuv.y += texelSize;\n\t\t\tvec4 br = texture2D(envMap, uv);\n\t\t\tuv.x -= texelSize;\n\t\t\tvec4 bl = texture2D(envMap, uv);\n\n\t\t\treturn TextureCubeUVData( tl, tr, br, bl, f );\n\t\t}",[t,i,a,e,n,r,o]);s.useKeywords=!1;var u=new H("float r0 1.0",!0),l=new H("float v0 0.339",!0),c=new H("float m0 -2.0",!0);return{bilinearCubeUV:s,roughnessToMip:new Z("float roughnessToMip(float roughness) {\n\t\t\tfloat mip = 0.0;\n\t\t\tif (roughness >= r1) {\n\t\t\t\tmip = (r0 - roughness) * (m1 - m0) / (r0 - r1) + m0;\n\t\t\t} else if (roughness >= r4) {\n\t\t\t\tmip = (r1 - roughness) * (m4 - m1) / (r1 - r4) + m1;\n\t\t\t} else if (roughness >= r5) {\n\t\t\t\tmip = (r4 - roughness) * (m5 - m4) / (r4 - r5) + m4;\n\t\t\t} else if (roughness >= r6) {\n\t\t\t\tmip = (r5 - roughness) * (m6 - m5) / (r5 - r6) + m5;\n\t\t\t} else {\n\t\t\t\tmip = -2.0 * log2(1.16 * roughness);// 1.16 = 1.79^0.25\n\t\t\t}\n\t\t\treturn mip;\n\t\t}",[u,l,c,new H("float r1 0.8",!0),new H("float v1 0.276",!0),new H("float m1 -1.0",!0),new H("float r4 0.4",!0),new H("float v4 0.046",!0),new H("float m4 2.0",!0),new H("float r5 0.305",!0),new H("float v5 0.016",!0),new H("float m5 3.0",!0),new H("float r6 0.21",!0),new H("float v6 0.0038",!0),new H("float m6 4.0",!0)]),m0:c,cubeUV_maxMipLevel:e}}(),yt.prototype=Object.create(q.prototype),yt.prototype.constructor=yt,yt.prototype.nodeType="TextureCubeUV",yt.prototype.bilinearCubeUV=function(t,e,n,r){var o=new vt(yt.Nodes.bilinearCubeUV,[e,n,r]);this.colorSpaceTL=this.colorSpaceTL||new lt(new ut("","v4")),this.colorSpaceTL.fromDecoding(t.getTextureEncodingFromMap(this.value.value)),this.colorSpaceTL.input.parse(o.build(t)+".tl"),this.colorSpaceTR=this.colorSpaceTR||new lt(new ut("","v4")),this.colorSpaceTR.fromDecoding(t.getTextureEncodingFromMap(this.value.value)),this.colorSpaceTR.input.parse(o.build(t)+".tr"),this.colorSpaceBL=this.colorSpaceBL||new lt(new ut("","v4")),this.colorSpaceBL.fromDecoding(t.getTextureEncodingFromMap(this.value.value)),this.colorSpaceBL.input.parse(o.build(t)+".bl"),this.colorSpaceBR=this.colorSpaceBR||new lt(new ut("","v4")),this.colorSpaceBR.fromDecoding(t.getTextureEncodingFromMap(this.value.value)),this.colorSpaceBR.input.parse(o.build(t)+".br");var i={include:t.isShader("vertex"),ignoreCache:!0};t.addContext(i),this.colorSpaceTLExp=new ut(this.colorSpaceTL.build(t,"v4"),"v4"),this.colorSpaceTRExp=new ut(this.colorSpaceTR.build(t,"v4"),"v4"),this.colorSpaceBLExp=new ut(this.colorSpaceBL.build(t,"v4"),"v4"),this.colorSpaceBRExp=new ut(this.colorSpaceBR.build(t,"v4"),"v4"),t.removeContext();var a=new ut("mix( mix( cubeUV_TL, cubeUV_TR, cubeUV.f.x ), mix( cubeUV_BL, cubeUV_BR, cubeUV.f.x ), cubeUV.f.y )","v4");return a.keywords.cubeUV_TL=this.colorSpaceTLExp,a.keywords.cubeUV_TR=this.colorSpaceTRExp,a.keywords.cubeUV_BL=this.colorSpaceBLExp,a.keywords.cubeUV_BR=this.colorSpaceBRExp,a.keywords.cubeUV=o,a},yt.prototype.generate=function(t,e){if(t.isShader("fragment")){var n=this.uv,r=this.bias||t.context.roughness,o=new gt(new vt(yt.Nodes.roughnessToMip,[r]),yt.Nodes.m0,yt.Nodes.cubeUV_maxMipLevel,gt.CLAMP),i=new gt(o,gt.FLOOR),a=new gt(o,gt.FRACT),s=new gt(this.bilinearCubeUV(t,this.value,n,i),this.bilinearCubeUV(t,this.value,n,new mt(i,new st(1).setReadonly(!0),mt.ADD)),a,gt.MIX);return t.format(s.build(t),"v4",e)}return console.warn("THREE.TextureCubeUVNode is not compatible with "+t.shader+" shader."),t.format("vec4( 0.0 )",this.getType(t),e)},yt.prototype.toJSON=function(t){var e=this.getJSONNode(t);return e||((e=this.createJSONNode(t)).value=this.value.toJSON(t).uuid,e.uv=this.uv.toJSON(t).uuid,e.bias=this.bias.toJSON(t).uuid),e},xt.prototype=Object.create(q.prototype),xt.prototype.constructor=xt,xt.prototype.nodeType="TextureCube",xt.prototype.generate=function(t,e){return t.isShader("fragment")?(t.require("irradiance"),t.context.bias&&t.context.bias.setTexture(this.value),("irradiance"===t.slot?this.irradianceNode:this.radianceNode).build(t,e)):(console.warn("THREE.TextureCubeNode is not compatible with "+t.shader+" shader."),t.format("vec4( 0.0 )",this.getType(t),e))},xt.prototype.copy=function(t){return q.prototype.copy.call(this,t),this.value=t.value,this},xt.prototype.toJSON=function(t){var e=this.getJSONNode(t);return e||((e=this.createJSONNode(t)).value=this.value.toJSON(t).uuid),e};var wt,bt=U.elements,Tt=["float","vec2","vec3","vec4"],St={float:"f",vec2:"v2",vec3:"v3",vec4:"v4",mat4:"v4",int:"i",bool:"b"},Dt={t:"sampler2D",tc:"samplerCube",b:"bool",i:"int",f:"float",c:"vec3",v2:"vec2",v3:"vec3",v4:"vec4",m3:"mat3",m4:"mat4"};function Pt(){this.slots=[],this.caches=[],this.contexts=[],this.keywords={},this.nodeData={},this.requires={uv:[],color:[],lights:!1,fog:!1,transparent:!1,irradiance:!1},this.includes={consts:[],functions:[],structs:[]},this.attributes={},this.prefixCode=["#ifdef TEXTURE_LOD_EXT","\t#define texCube(a, b) textureCube(a, b)","\t#define texCubeBias(a, b, c) textureCubeLodEXT(a, b, c)","\t#define tex2D(a, b) texture2D(a, b)","\t#define tex2DBias(a, b, c) texture2DLodEXT(a, b, c)","#else","\t#define texCube(a, b) textureCube(a, b)","\t#define texCubeBias(a, b, c) textureCube(a, b, c)","\t#define tex2D(a, b) texture2D(a, b)","\t#define tex2DBias(a, b, c) texture2D(a, b, c)","#endif","#include <packing>","#include <common>"].join("\n"),this.parsCode={vertex:"",fragment:""},this.code={vertex:"",fragment:""},this.nodeCode={vertex:"",fragment:""},this.resultCode={vertex:"",fragment:""},this.finalCode={vertex:"",fragment:""},this.inputs={uniforms:{list:[],vertex:[],fragment:[]},vars:{varying:[],vertex:[],fragment:[]}},this.defines={},this.uniforms={},this.extensions={},this.updaters=[],this.nodes=[],this.analyzing=!1}function Ct(t,e,n){nt.call(this,"c"),this.value=t instanceof V.Color?t:new V.Color(t||0,e,n)}function _t(t){J.call(this,"v4"),this.value=t}function Ot(t,e){V.ShaderMaterial.call(this),this.vertex=t||new _t(new ht(ht.PROJECTION)),this.fragment=e||new _t(new Ct(16711680)),this.updaters=[]}function Vt(t){ct.call(this,void 0,t)}function Mt(){k.call(this),this.name="",this.uuid=V.MathUtils.generateUUID(),this.userData={},this.textureID="renderTexture",this.input=new Vt,this.material=new Ot,this.needsUpdate=!0}function Nt(t){q.call(this,"f"),this.rgb=t}function Rt(t,e,n){q.call(this,"v3"),this.rgb=t,this.adjustment=e,this.method=n||Rt.SATURATION}function zt(t){return(zt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function Et(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function Lt(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function At(t,e){return(At=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function Ft(t,e){return!e||"object"!==zt(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function It(t){return(It=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}Pt.prototype={constructor:Pt,build:function(t,e){this.buildShader("vertex",t),this.buildShader("fragment",e);for(var n=0;n<this.requires.uv.length;n++)if(this.requires.uv[n]){var r=n>0?n+1:"";this.addVaryCode("varying vec2 vUv"+r+";"),n>0&&this.addVertexParsCode("attribute vec2 uv"+r+";"),this.addVertexFinalCode("vUv"+r+" = uv"+r+";")}return this.requires.color[0]&&(this.addVaryCode("varying vec4 vColor;"),this.addVertexParsCode("attribute vec4 color;"),this.addVertexFinalCode("vColor = color;")),this.requires.color[1]&&(this.addVaryCode("varying vec4 vColor2;"),this.addVertexParsCode("attribute vec4 color2;"),this.addVertexFinalCode("vColor2 = color2;")),this.requires.position&&(this.addVaryCode("varying vec3 vPosition;"),this.addVertexFinalCode("vPosition = transformed;")),this.requires.worldPosition&&(this.addVaryCode("varying vec3 vWPosition;"),this.addVertexFinalCode("vWPosition = ( modelMatrix * vec4( transformed, 1.0 ) ).xyz;")),this.requires.normal&&(this.addVaryCode("varying vec3 vObjectNormal;"),this.addVertexFinalCode("vObjectNormal = normal;")),this.requires.worldNormal&&(this.addVaryCode("varying vec3 vWNormal;"),this.addVertexFinalCode("vWNormal = inverseTransformDirection( transformedNormal, viewMatrix ).xyz;")),this},buildShader:function(t,e){this.resultCode[t]=e.build(this.setShader(t),"v4")},setMaterial:function(t,e){return this.material=t,this.renderer=e,this.requires.lights=t.lights,this.requires.fog=t.fog,this.mergeDefines(t.defines),this},addFlow:function(t,e,n){return this.addSlot(t).addCache(e).addContext(n)},removeFlow:function(){return this.removeSlot().removeCache().removeContext()},addCache:function(t){return this.cache=t||"",this.caches.push(this.cache),this},removeCache:function(){return this.caches.pop(),this.cache=this.caches[this.caches.length-1]||"",this},addContext:function(t){return this.context=Object.assign({},this.context,t),this.context.extra=this.context.extra||{},this.contexts.push(this.context),this},removeContext:function(){return this.contexts.pop(),this.context=this.contexts[this.contexts.length-1]||{},this},addSlot:function(t){return this.slot=t||"",this.slots.push(this.slot),this},removeSlot:function(){return this.slots.pop(),this.slot=this.slots[this.slots.length-1]||"",this},addVertexCode:function(t){this.addCode(t,"vertex")},addFragmentCode:function(t){this.addCode(t,"fragment")},addCode:function(t,e){this.code[e||this.shader]+=t+"\n"},addVertexNodeCode:function(t){this.addNodeCode(t,"vertex")},addFragmentNodeCode:function(t){this.addNodeCode(t,"fragment")},addNodeCode:function(t,e){this.nodeCode[e||this.shader]+=t+"\n"},clearNodeCode:function(t){t=t||this.shader;var e=this.nodeCode[t];return this.nodeCode[t]="",e},clearVertexNodeCode:function(){return this.clearNodeCode("vertex")},clearFragmentNodeCode:function(){return this.clearNodeCode("fragment")},addVertexFinalCode:function(t){this.addFinalCode(t,"vertex")},addFragmentFinalCode:function(t){this.addFinalCode(t,"fragment")},addFinalCode:function(t,e){this.finalCode[e||this.shader]+=t+"\n"},addVertexParsCode:function(t){this.addParsCode(t,"vertex")},addFragmentParsCode:function(t){this.addParsCode(t,"fragment")},addParsCode:function(t,e){this.parsCode[e||this.shader]+=t+"\n"},addVaryCode:function(t){this.addVertexParsCode(t),this.addFragmentParsCode(t)},isCache:function(t){return-1!==this.caches.indexOf(t)},isSlot:function(t){return-1!==this.slots.indexOf(t)},define:function(t,e){this.defines[t]=void 0===e?1:e},require:function(t){this.requires[t]=!0},isDefined:function(t){return void 0!==this.defines[t]},getVar:function(t,e,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"varying",o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"V",i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"",a=this.getVars(r),s=a[t];if(!s){var u=a.length,l=n||"node"+o+u+(i?"_"+i:"");s={name:l,type:e},a.push(s),a[t]=s}return s},getTempVar:function(t,e,n,r){return this.getVar(t,e,n,this.shader,"T",r)},getAttribute:function(t,e){if(!this.attributes[t]){var n=this.getVar(t,e);this.addVertexParsCode("attribute "+e+" "+t+";"),this.addVertexFinalCode(n.name+" = "+t+";"),this.attributes[t]={varying:n,name:t,type:e}}return this.attributes[t]},getCode:function(t){return[this.prefixCode,this.parsCode[t],this.getVarListCode(this.getVars("varying"),"varying"),this.getVarListCode(this.inputs.uniforms[t],"uniform"),this.getIncludesCode("consts",t),this.getIncludesCode("structs",t),this.getIncludesCode("functions",t),"void main() {",this.getVarListCode(this.getVars(t)),this.code[t],this.resultCode[t],this.finalCode[t],"}"].join("\n")},getVarListCode:function(t,e){e=e||"";for(var n="",r=0,o=t.length;r<o;++r){var i=t[r],a=i.type,s=i.name,u=this.getFormatByType(a);if(void 0===u)throw new Error("Node pars "+u+" not found.");n+=e+" "+u+" "+s+";\n"}return n},getVars:function(t){return this.inputs.vars[t||this.shader]},getNodeData:function(t){var e=t.isNode?t.uuid:t;return this.nodeData[e]=this.nodeData[e]||{}},createUniform:function(t,e,n,r,o,i){var a=this.inputs.uniforms,s=a.list.length,u=new j({type:e,name:r||"nodeU"+s+(i?"_"+i:""),node:n,needsUpdate:o});return a.list.push(u),a[t].push(u),a[t][u.name]=u,this.uniforms[u.name]=u,u},createVertexUniform:function(t,e,n,r,o){return this.createUniform("vertex",t,e,n,r,o)},createFragmentUniform:function(t,e,n,r,o){return this.createUniform("fragment",t,e,n,r,o)},include:function(t,e,n){var r;if(t="string"==typeof t?G.get(t):t,!1===this.context.include)return t.name;t instanceof Z?r=this.includes.functions:t instanceof H?r=this.includes.consts:t instanceof et&&(r=this.includes.structs);var o=r[this.shader]=r[this.shader]||[];if(t){var i=o[t.name];if(i||(i=o[t.name]={node:t,deps:[]},o.push(i),i.src=t.build(this,"source")),t instanceof Z&&e&&o[e.name]&&-1==o[e.name].deps.indexOf(t)&&(o[e.name].deps.push(t),t.includes&&t.includes.length)){var a=0;do{this.include(t.includes[a++],e)}while(a<t.includes.length)}return n&&(i.src=n),t.name}throw new Error("Include not found.")},colorToVectorProperties:function(t){return t.replace("r","x").replace("g","y").replace("b","z").replace("a","w")},colorToVector:function(t){return t.replace(/c/g,"v3")},getIncludes:function(t,e){return this.includes[t][e||this.shader]},getIncludesCode:function(){function t(t,e){return t.deps.length-e.deps.length}return function(e,n){if(!(o=this.getIncludes(e,n)))return"";for(var r="",o=o.sort(t),i=0;i<o.length;i++)o[i].src&&(r+=o[i].src+"\n");return r}}(),getConstructorFromLength:function(t){return Tt[t-1]},isTypeMatrix:function(t){return/^m/.test(t)},getTypeLength:function(t){return"f"===t?1:parseInt(this.colorToVector(t).substr(1))},getTypeFromLength:function(t){return 1===t?"f":"v"+t},findNode:function(){for(var t=0;t<arguments.length;t++){var e=arguments[t];if(void 0!==e&&e.isNode)return e}},resolve:function(){for(var t=0;t<arguments.length;t++){var e=arguments[t];if(void 0!==e){if(e.isNode)return e;if(e.isTexture)switch(e.mapping){case V.CubeReflectionMapping:case V.CubeRefractionMapping:return new dt(e);case V.CubeUVReflectionMapping:case V.CubeUVRefractionMapping:return new xt(new ct(e));default:return new ct(e)}else{if(e.isVector2)return new rt(e);if(e.isVector3)return new ot(e);if(e.isVector4)return new it(e)}}}},format:function(t,e,n){switch(this.colorToVector(n+" <- "+e)){case"f <- v2":case"f <- v3":case"f <- v4":return t+".x";case"f <- i":case"f <- b":return"float( "+t+" )";case"v2 <- f":return"vec2( "+t+" )";case"v2 <- v3":case"v2 <- v4":return t+".xy";case"v2 <- i":case"v2 <- b":return"vec2( float( "+t+" ) )";case"v3 <- f":return"vec3( "+t+" )";case"v3 <- v2":return"vec3( "+t+", 0.0 )";case"v3 <- v4":return t+".xyz";case"v3 <- i":case"v3 <- b":return"vec2( float( "+t+" ) )";case"v4 <- f":return"vec4( "+t+" )";case"v4 <- v2":return"vec4( "+t+", 0.0, 1.0 )";case"v4 <- v3":return"vec4( "+t+", 1.0 )";case"v4 <- i":case"v4 <- b":return"vec4( float( "+t+" ) )";case"i <- f":case"i <- b":return"int( "+t+" )";case"i <- v2":case"i <- v3":case"i <- v4":return"int( "+t+".x )";case"b <- f":return"( "+t+" != 0.0 )";case"b <- v2":return"( "+t+" != vec2( 0.0 ) )";case"b <- v3":return"( "+t+" != vec3( 0.0 ) )";case"b <- v4":return"( "+t+" != vec4( 0.0 ) )";case"b <- i":return"( "+t+" != 0 )"}return t},getTypeByFormat:function(t){return St[t]||t},getFormatByType:function(t){return Dt[t]||t},getUuid:function(t,e){return(e=void 0===e||e)&&this.cache&&(t=this.cache+"-"+t),t},getElementByIndex:function(t){return bt[t]},getIndexByElement:function(t){return bt.indexOf(t)},isShader:function(t){return this.shader===t},setShader:function(t){return this.shader=t,this},mergeDefines:function(t){for(var e in t)this.defines[e]=t[e];return this.defines},mergeUniform:function(t){for(var e in t)this.uniforms[e]=t[e];return this.uniforms},getTextureEncodingFromMap:function(t){var e;return t?t.isTexture?e=t.encoding:t.isWebGLRenderTarget&&(console.warn("THREE.WebGLPrograms.getTextureEncodingFromMap: don't use render targets as textures. Use their .texture property instead."),e=t.texture.encoding):e=V.LinearEncoding,e===V.LinearEncoding&&this.context.gamma&&(e=V.GammaEncoding),e}},Ct.prototype=Object.create(nt.prototype),Ct.prototype.constructor=Ct,Ct.prototype.nodeType="Color",U.addShortcuts(Ct.prototype,"value",["r","g","b"]),Ct.prototype.generateReadonly=function(t,e,n,r){return t.format("vec3( "+this.r+", "+this.g+", "+this.b+" )",r,e)},Ct.prototype.copy=function(t){return nt.prototype.copy.call(this,t),this.value.copy(t),this},Ct.prototype.toJSON=function(t){var e=this.getJSONNode(t);return e||((e=this.createJSONNode(t)).r=this.r,e.g=this.g,e.b=this.b,!0===this.readonly&&(e.readonly=!0)),e},_t.prototype=Object.create(J.prototype),_t.prototype.constructor=_t,_t.prototype.nodeType="Raw",_t.prototype.generate=function(t){var e=this.value.analyzeAndFlow(t,this.type),n=e.code+"\n";return t.isShader("vertex")?n+="gl_Position = "+e.result+";":n+="gl_FragColor = "+e.result+";",n},_t.prototype.copy=function(t){return J.prototype.copy.call(this,t),this.value=t.value,this},_t.prototype.toJSON=function(t){var e=this.getJSONNode(t);return e||((e=this.createJSONNode(t)).value=this.value.toJSON(t).uuid),e},Ot.prototype=Object.create(V.ShaderMaterial.prototype),Ot.prototype.constructor=Ot,Ot.prototype.type="NodeMaterial",Ot.prototype.isNodeMaterial=!0,Object.defineProperties(Ot.prototype,{properties:{get:function(){return this.fragment.properties}},needsUpdate:{set:function(t){!0===t&&this.version++,this.needsCompile=t},get:function(){return this.needsCompile}}}),Ot.prototype.onBeforeCompile=function(t,e){this.build({renderer:e}),t.uniforms=this.uniforms,t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader},Ot.prototype.customProgramCacheKey=function(){return this.getHash()},Ot.prototype.getHash=function(){var t="{";return t+='"vertex":'+this.vertex.getHash()+",",(t+='"fragment":'+this.fragment.getHash())+"}"},Ot.prototype.updateFrame=function(t){for(var e=0;e<this.updaters.length;++e)t.updateNode(this.updaters[e])},Ot.prototype.build=function(t){var e=(t=t||{}).builder||new Pt;return e.setMaterial(this,t.renderer),e.build(this.vertex,this.fragment),this.vertexShader=e.getCode("vertex"),this.fragmentShader=e.getCode("fragment"),this.defines=e.defines,this.uniforms=e.uniforms,this.extensions=e.extensions,this.updaters=e.updaters,this.fog=e.requires.fog,this.lights=e.requires.lights,this.transparent=e.requires.transparent||this.blending>V.NormalBlending,this},Ot.prototype.copy=function(t){var e=this.uuid;for(var n in t)this[n]=t[n];return this.uuid=e,void 0!==t.userData&&(this.userData=JSON.parse(JSON.stringify(t.userData))),this},Ot.prototype.toJSON=function(t){if((void 0===t||"string"==typeof t)&&(t={nodes:{}}),t&&!t.materials&&(t.materials={}),!t.materials[this.uuid]){var e={};e.uuid=this.uuid,e.type=this.type,t.materials[e.uuid]=e,""!==this.name&&(e.name=this.name),void 0!==this.size&&(e.size=this.size),void 0!==this.sizeAttenuation&&(e.sizeAttenuation=this.sizeAttenuation),this.blending!==V.NormalBlending&&(e.blending=this.blending),!0===this.flatShading&&(e.flatShading=this.flatShading),this.side!==V.FrontSide&&(e.side=this.side),this.vertexColors!==V.NoColors&&(e.vertexColors=this.vertexColors),this.depthFunc!==V.LessEqualDepth&&(e.depthFunc=this.depthFunc),!1===this.depthTest&&(e.depthTest=this.depthTest),!1===this.depthWrite&&(e.depthWrite=this.depthWrite),1!==this.linewidth&&(e.linewidth=this.linewidth),void 0!==this.dashSize&&(e.dashSize=this.dashSize),void 0!==this.gapSize&&(e.gapSize=this.gapSize),void 0!==this.scale&&(e.scale=this.scale),!0===this.dithering&&(e.dithering=!0),!0===this.wireframe&&(e.wireframe=this.wireframe),this.wireframeLinewidth>1&&(e.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(e.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(e.wireframeLinejoin=this.wireframeLinejoin),this.alphaTest>0&&(e.alphaTest=this.alphaTest),!0===this.premultipliedAlpha&&(e.premultipliedAlpha=this.premultipliedAlpha),!0===this.morphTargets&&(e.morphTargets=!0),!0===this.skinning&&(e.skinning=!0),!1===this.visible&&(e.visible=!1),"{}"!==JSON.stringify(this.userData)&&(e.userData=this.userData),e.fog=this.fog,e.lights=this.lights,e.vertex=this.vertex.toJSON(t).uuid,e.fragment=this.fragment.toJSON(t).uuid}return t.material=this.uuid,t},Vt.prototype=Object.create(ct.prototype),Vt.prototype.constructor=Vt,Vt.prototype.nodeType="Screen",Vt.prototype.getUnique=function(){return!0},Vt.prototype.getTexture=function(t,e){return nt.prototype.generate.call(this,t,e,this.getUuid(),"t","renderTexture")},Mt.prototype=Object.create(k.prototype),Mt.prototype.constructor=Mt,Mt.prototype.render=function(){this.needsUpdate&&(this.material.dispose(),this.material.fragment.value=this.input,this.needsUpdate=!1),this.uniforms=this.material.uniforms,k.prototype.render.apply(this,arguments)},Mt.prototype.copy=function(t){return this.input=t.input,this},Mt.prototype.toJSON=function(t){if((void 0===t||"string"==typeof t)&&(t={nodes:{}}),t&&!t.passes&&(t.passes={}),!t.passes[this.uuid]){var e={};e.uuid=this.uuid,e.type="NodePass",t.passes[this.uuid]=e,""!==this.name&&(e.name=this.name),"{}"!==JSON.stringify(this.userData)&&(e.userData=this.userData),e.input=this.input.toJSON(t).uuid}return t.pass=this.uuid,t},Nt.Nodes={LUMA:wt=new H("vec3 LUMA vec3( 0.2125, 0.7154, 0.0721 )"),luminance:new Z(["float luminance( vec3 rgb ) {","\treturn dot( rgb, LUMA );","}"].join("\n"),[wt])},Nt.prototype=Object.create(q.prototype),Nt.prototype.constructor=Nt,Nt.prototype.nodeType="Luminance",Nt.prototype.generate=function(t,e){var n=t.include(Nt.Nodes.luminance);return t.format(n+"( "+this.rgb.build(t,"v3")+" )",this.getType(t),e)},Nt.prototype.copy=function(t){return q.prototype.copy.call(this,t),this.rgb=t.rgb,this},Nt.prototype.toJSON=function(t){var e=this.getJSONNode(t);return e||((e=this.createJSONNode(t)).rgb=this.rgb.toJSON(t).uuid),e},Rt.Nodes={hue:new Z(["vec3 hue(vec3 rgb, float adjustment) {","\tconst mat3 RGBtoYIQ = mat3(0.299, 0.587, 0.114, 0.595716, -0.274453, -0.321263, 0.211456, -0.522591, 0.311135);","\tconst mat3 YIQtoRGB = mat3(1.0, 0.9563, 0.6210, 1.0, -0.2721, -0.6474, 1.0, -1.107, 1.7046);","\tvec3 yiq = RGBtoYIQ * rgb;","\tfloat hue = atan(yiq.z, yiq.y) + adjustment;","\tfloat chroma = sqrt(yiq.z * yiq.z + yiq.y * yiq.y);","\treturn YIQtoRGB * vec3(yiq.x, chroma * cos(hue), chroma * sin(hue));","}"].join("\n")),saturation:new Z(["vec3 saturation(vec3 rgb, float adjustment) {","\tvec3 intensity = vec3( luminance( rgb ) );","\treturn mix( intensity, rgb, adjustment );","}"].join("\n"),[Nt.Nodes.luminance]),vibrance:new Z(["vec3 vibrance(vec3 rgb, float adjustment) {","\tfloat average = (rgb.r + rgb.g + rgb.b) / 3.0;","\tfloat mx = max(rgb.r, max(rgb.g, rgb.b));","\tfloat amt = (mx - average) * (-3.0 * adjustment);","\treturn mix(rgb.rgb, vec3(mx), amt);","}"].join("\n"))},Rt.SATURATION="saturation",Rt.HUE="hue",Rt.VIBRANCE="vibrance",Rt.BRIGHTNESS="brightness",Rt.CONTRAST="contrast",Rt.prototype=Object.create(q.prototype),Rt.prototype.constructor=Rt,Rt.prototype.nodeType="ColorAdjustment",Rt.prototype.hashProperties=["method"],Rt.prototype.generate=function(t,e){var n=this.rgb.build(t,"v3"),r=this.adjustment.build(t,"f");switch(this.method){case Rt.BRIGHTNESS:return t.format("( "+n+" + "+r+" )",this.getType(t),e);case Rt.CONTRAST:return t.format("( "+n+" * "+r+" )",this.getType(t),e)}var o=t.include(Rt.Nodes[this.method]);return t.format(o+"( "+n+", "+r+" )",this.getType(t),e)},Rt.prototype.copy=function(t){return q.prototype.copy.call(this,t),this.rgb=t.rgb,this.adjustment=t.adjustment,this.method=t.method,this},Rt.prototype.toJSON=function(t){var e=this.getJSONNode(t);return e||((e=this.createJSONNode(t)).rgb=this.rgb.toJSON(t).uuid,e.adjustment=this.adjustment.toJSON(t).uuid,e.method=this.method),e};var Bt=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&At(t,e)}(a,t);var e,n,r,o,i=(r=a,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=It(r);if(o){var n=It(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return Ft(this,t)});function a(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;Et(this,a),t=i.call(this),e=new st(e),n=new st(n),r=new st(r),o=new st(o),s=new st(s);var u=new Vt,l=new Rt(u,e,Rt.HUE),c=new Rt(l,n,Rt.SATURATION),h=new Rt(c,r,Rt.VIBRANCE),p=new Rt(h,o,Rt.BRIGHTNESS),f=new Rt(p,s,Rt.CONTRAST);return t.input=f,t._hue=e,t._saturation=n,t._vibrance=r,t._brightness=o,t._contrast=s,t}return e=a,(n=[{key:"hue",get:function(){return this._hue.value},set:function(t){this._hue.value=t}},{key:"saturation",get:function(){return this._saturation.value},set:function(t){this._saturation.value=t}},{key:"vibrance",get:function(){return this._vibrance.value},set:function(t){this._vibrance.value=t}},{key:"brightness",get:function(){return this._brightness.value},set:function(t){this._brightness.value=t}},{key:"contrast",get:function(){return this._contrast.value},set:function(t){this._contrast.value=t}}])&&Lt(e.prototype,n),a}(Mt),kt={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","\tvec4 texel = texture2D( tDiffuse, vUv );","\tgl_FragColor = opacity * texel;","}"].join("\n")},jt={shaderID:"luminosityHighPass",uniforms:{tDiffuse:{value:null},luminosityThreshold:{value:1},smoothWidth:{value:1},defaultColor:{value:new V.Color(0)},defaultOpacity:{value:0}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec3 defaultColor;","uniform float defaultOpacity;","uniform float luminosityThreshold;","uniform float smoothWidth;","varying vec2 vUv;","void main() {","\tvec4 texel = texture2D( tDiffuse, vUv );","\tvec3 luma = vec3( 0.299, 0.587, 0.114 );","\tfloat v = dot( texel.xyz, luma );","\tvec4 outputColor = vec4( defaultColor.rgb, defaultOpacity );","\tfloat alpha = smoothstep( luminosityThreshold, luminosityThreshold + smoothWidth, v );","\tgl_FragColor = mix( outputColor, texel, alpha );","}"].join("\n")},Ut=function(t,e,n,r){B.call(this),this.strength=void 0!==e?e:1,this.radius=n,this.threshold=r,this.resolution=void 0!==t?new V.Vector2(t.x,t.y):new V.Vector2(256,256),this.clearColor=new V.Color(0,0,0);var o={minFilter:V.LinearFilter,magFilter:V.LinearFilter,format:V.RGBAFormat};this.renderTargetsHorizontal=[],this.renderTargetsVertical=[],this.nMips=5;var i=Math.round(this.resolution.x/2),a=Math.round(this.resolution.y/2);this.renderTargetBright=new V.WebGLRenderTarget(i,a,o),this.renderTargetBright.texture.name="UnrealBloomPass.bright",this.renderTargetBright.texture.generateMipmaps=!1;for(var s=0;s<this.nMips;s++){var u=new V.WebGLRenderTarget(i,a,o);u.texture.name="UnrealBloomPass.h"+s,u.texture.generateMipmaps=!1,this.renderTargetsHorizontal.push(u);var l=new V.WebGLRenderTarget(i,a,o);l.texture.name="UnrealBloomPass.v"+s,l.texture.generateMipmaps=!1,this.renderTargetsVertical.push(l),i=Math.round(i/2),a=Math.round(a/2)}void 0===jt&&console.error("UnrealBloomPass relies on LuminosityHighPassShader");var c=jt;this.highPassUniforms=V.UniformsUtils.clone(c.uniforms),this.highPassUniforms.luminosityThreshold.value=r,this.highPassUniforms.smoothWidth.value=.01,this.materialHighPassFilter=new V.ShaderMaterial({uniforms:this.highPassUniforms,vertexShader:c.vertexShader,fragmentShader:c.fragmentShader,defines:{}}),this.separableBlurMaterials=[];var h=[3,5,7,9,11];for(i=Math.round(this.resolution.x/2),a=Math.round(this.resolution.y/2),s=0;s<this.nMips;s++)this.separableBlurMaterials.push(this.getSeperableBlurMaterial(h[s])),this.separableBlurMaterials[s].uniforms.texSize.value=new V.Vector2(i,a),i=Math.round(i/2),a=Math.round(a/2);this.compositeMaterial=this.getCompositeMaterial(this.nMips),this.compositeMaterial.uniforms.blurTexture1.value=this.renderTargetsVertical[0].texture,this.compositeMaterial.uniforms.blurTexture2.value=this.renderTargetsVertical[1].texture,this.compositeMaterial.uniforms.blurTexture3.value=this.renderTargetsVertical[2].texture,this.compositeMaterial.uniforms.blurTexture4.value=this.renderTargetsVertical[3].texture,this.compositeMaterial.uniforms.blurTexture5.value=this.renderTargetsVertical[4].texture,this.compositeMaterial.uniforms.bloomStrength.value=e,this.compositeMaterial.uniforms.bloomRadius.value=.1,this.compositeMaterial.needsUpdate=!0,this.compositeMaterial.uniforms.bloomFactors.value=[1,.8,.6,.4,.2],this.bloomTintColors=[new V.Vector3(1,1,1),new V.Vector3(1,1,1),new V.Vector3(1,1,1),new V.Vector3(1,1,1),new V.Vector3(1,1,1)],this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,void 0===kt&&console.error("UnrealBloomPass relies on CopyShader");var p=kt;this.copyUniforms=V.UniformsUtils.clone(p.uniforms),this.copyUniforms.opacity.value=1,this.materialCopy=new V.ShaderMaterial({uniforms:this.copyUniforms,vertexShader:p.vertexShader,fragmentShader:p.fragmentShader,blending:V.AdditiveBlending,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this.oldClearColor=new V.Color,this.oldClearAlpha=1,this.basic=new V.MeshBasicMaterial,this.fsQuad=new B.FullScreenQuad(null)};function Gt(t){return(Gt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function Jt(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function qt(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function Xt(t,e){return(Xt=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function Yt(t,e){return!e||"object"!==Gt(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function Zt(t){return(Zt=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}Ut.prototype=Object.assign(Object.create(B.prototype),{constructor:Ut,dispose:function(){for(var t=0;t<this.renderTargetsHorizontal.length;t++)this.renderTargetsHorizontal[t].dispose();for(t=0;t<this.renderTargetsVertical.length;t++)this.renderTargetsVertical[t].dispose();this.renderTargetBright.dispose()},setSize:function(t,e){var n=Math.round(t/2),r=Math.round(e/2);this.renderTargetBright.setSize(n,r);for(var o=0;o<this.nMips;o++)this.renderTargetsHorizontal[o].setSize(n,r),this.renderTargetsVertical[o].setSize(n,r),this.separableBlurMaterials[o].uniforms.texSize.value=new V.Vector2(n,r),n=Math.round(n/2),r=Math.round(r/2)},render:function(t,e,n,r,o){this.oldClearColor.copy(t.getClearColor()),this.oldClearAlpha=t.getClearAlpha();var i=t.autoClear;t.autoClear=!1,t.setClearColor(this.clearColor,0),o&&t.state.buffers.stencil.setTest(!1),this.renderToScreen&&(this.fsQuad.material=this.basic,this.basic.map=n.texture,t.setRenderTarget(null),t.clear(),this.fsQuad.render(t)),this.highPassUniforms.tDiffuse.value=n.texture,this.highPassUniforms.luminosityThreshold.value=this.threshold,this.fsQuad.material=this.materialHighPassFilter,t.setRenderTarget(this.renderTargetBright),t.clear(),this.fsQuad.render(t);for(var a=this.renderTargetBright,s=0;s<this.nMips;s++)this.fsQuad.material=this.separableBlurMaterials[s],this.separableBlurMaterials[s].uniforms.colorTexture.value=a.texture,this.separableBlurMaterials[s].uniforms.direction.value=Ut.BlurDirectionX,t.setRenderTarget(this.renderTargetsHorizontal[s]),t.clear(),this.fsQuad.render(t),this.separableBlurMaterials[s].uniforms.colorTexture.value=this.renderTargetsHorizontal[s].texture,this.separableBlurMaterials[s].uniforms.direction.value=Ut.BlurDirectionY,t.setRenderTarget(this.renderTargetsVertical[s]),t.clear(),this.fsQuad.render(t),a=this.renderTargetsVertical[s];this.fsQuad.material=this.compositeMaterial,this.compositeMaterial.uniforms.bloomStrength.value=this.strength,this.compositeMaterial.uniforms.bloomRadius.value=this.radius,this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,t.setRenderTarget(this.renderTargetsHorizontal[0]),t.clear(),this.fsQuad.render(t),this.fsQuad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetsHorizontal[0].texture,o&&t.state.buffers.stencil.setTest(!0),this.renderToScreen?(t.setRenderTarget(null),this.fsQuad.render(t)):(t.setRenderTarget(n),this.fsQuad.render(t)),t.setClearColor(this.oldClearColor,this.oldClearAlpha),t.autoClear=i},getSeperableBlurMaterial:function(t){return new V.ShaderMaterial({defines:{KERNEL_RADIUS:t,SIGMA:t},uniforms:{colorTexture:{value:null},texSize:{value:new V.Vector2(.5,.5)},direction:{value:new V.Vector2(.5,.5)}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"#include <common>\t\t\t\tvarying vec2 vUv;\n\t\t\t\tuniform sampler2D colorTexture;\n\t\t\t\tuniform vec2 texSize;\t\t\t\tuniform vec2 direction;\t\t\t\t\t\t\t\tfloat gaussianPdf(in float x, in float sigma) {\t\t\t\t\treturn 0.39894 * exp( -0.5 * x * x/( sigma * sigma))/sigma;\t\t\t\t}\t\t\t\tvoid main() {\n\t\t\t\t\tvec2 invSize = 1.0 / texSize;\t\t\t\t\tfloat fSigma = float(SIGMA);\t\t\t\t\tfloat weightSum = gaussianPdf(0.0, fSigma);\t\t\t\t\tvec3 diffuseSum = texture2D( colorTexture, vUv).rgb * weightSum;\t\t\t\t\tfor( int i = 1; i < KERNEL_RADIUS; i ++ ) {\t\t\t\t\t\tfloat x = float(i);\t\t\t\t\t\tfloat w = gaussianPdf(x, fSigma);\t\t\t\t\t\tvec2 uvOffset = direction * invSize * x;\t\t\t\t\t\tvec3 sample1 = texture2D( colorTexture, vUv + uvOffset).rgb;\t\t\t\t\t\tvec3 sample2 = texture2D( colorTexture, vUv - uvOffset).rgb;\t\t\t\t\t\tdiffuseSum += (sample1 + sample2) * w;\t\t\t\t\t\tweightSum += 2.0 * w;\t\t\t\t\t}\t\t\t\t\tgl_FragColor = vec4(diffuseSum/weightSum, 1.0);\n\t\t\t\t}"})},getCompositeMaterial:function(t){return new V.ShaderMaterial({defines:{NUM_MIPS:t},uniforms:{blurTexture1:{value:null},blurTexture2:{value:null},blurTexture3:{value:null},blurTexture4:{value:null},blurTexture5:{value:null},dirtTexture:{value:null},bloomStrength:{value:1},bloomFactors:{value:null},bloomTintColors:{value:null},bloomRadius:{value:0}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"varying vec2 vUv;\t\t\t\tuniform sampler2D blurTexture1;\t\t\t\tuniform sampler2D blurTexture2;\t\t\t\tuniform sampler2D blurTexture3;\t\t\t\tuniform sampler2D blurTexture4;\t\t\t\tuniform sampler2D blurTexture5;\t\t\t\tuniform sampler2D dirtTexture;\t\t\t\tuniform float bloomStrength;\t\t\t\tuniform float bloomRadius;\t\t\t\tuniform float bloomFactors[NUM_MIPS];\t\t\t\tuniform vec3 bloomTintColors[NUM_MIPS];\t\t\t\t\t\t\t\tfloat lerpBloomFactor(const in float factor) { \t\t\t\t\tfloat mirrorFactor = 1.2 - factor;\t\t\t\t\treturn mix(factor, mirrorFactor, bloomRadius);\t\t\t\t}\t\t\t\t\t\t\t\tvoid main() {\t\t\t\t\tgl_FragColor = bloomStrength * ( lerpBloomFactor(bloomFactors[0]) * vec4(bloomTintColors[0], 1.0) * texture2D(blurTexture1, vUv) + \t\t\t\t\t\t\t\t\t\t\t\t\t lerpBloomFactor(bloomFactors[1]) * vec4(bloomTintColors[1], 1.0) * texture2D(blurTexture2, vUv) + \t\t\t\t\t\t\t\t\t\t\t\t\t lerpBloomFactor(bloomFactors[2]) * vec4(bloomTintColors[2], 1.0) * texture2D(blurTexture3, vUv) + \t\t\t\t\t\t\t\t\t\t\t\t\t lerpBloomFactor(bloomFactors[3]) * vec4(bloomTintColors[3], 1.0) * texture2D(blurTexture4, vUv) + \t\t\t\t\t\t\t\t\t\t\t\t\t lerpBloomFactor(bloomFactors[4]) * vec4(bloomTintColors[4], 1.0) * texture2D(blurTexture5, vUv) );\t\t\t\t}"})}}),Ut.BlurDirectionX=new V.Vector2(1,0),Ut.BlurDirectionY=new V.Vector2(0,1);var Wt=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&Xt(t,e)}(a,t);var e,n,r,o,i=(r=a,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=Zt(r);if(o){var n=Zt(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return Yt(this,t)});function a(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.1,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new V.Vector2(256,256);return Jt(this,a),i.call(this,r,t,e,n)}return e=a,(n=[{key:"getSeperableBlurMaterial",value:function(t){return new V.ShaderMaterial({defines:{KERNEL_RADIUS:t,SIGMA:t},uniforms:{colorTexture:{value:null},texSize:{value:new V.Vector2(.5,.5)},direction:{value:new V.Vector2(.5,.5)}},vertexShader:"\n\t\t\t\tvarying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"\n\t\t\t    #include <common>\n\t\t\t\tvarying vec2 vUv;\n\t\t\t\tuniform sampler2D colorTexture;\n\t\t\t\tuniform vec2 texSize;\n\t\t\t\tuniform vec2 direction;\n\n                ".concat(f,"\n\t\t\t\t\n\t\t\t\tfloat gaussianPdf(in float x, in float sigma) {\n\t\t\t\t\treturn 0.39894 * exp( -0.5 * x * x/( sigma * sigma))/sigma;\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\t\t\t\t\tvec2 invSize = 1.0 / texSize;\n\t\t\t\t\tfloat fSigma = float(SIGMA);\n\t\t\t\t\tfloat weightSum = gaussianPdf(0.0, fSigma);\n\t\t\t\t\tvec3 diffuseSum = texture2D( colorTexture, vUv).rgb * weightSum;\n\t\t\t\t\tfor( int i = 1; i < KERNEL_RADIUS; i ++ ) {\n\t\t\t\t\t\tfloat x = float(i);\n\t\t\t\t\t\tfloat w = gaussianPdf(x, fSigma);\n\t\t\t\t\t\tvec2 uvOffset = direction * invSize * x;\n\t\t\t\t\t\tvec3 sample1 = texture2D( colorTexture, vUv + uvOffset).rgb;\n\t\t\t\t\t\tvec3 sample2 = texture2D( colorTexture, vUv - uvOffset).rgb;\n\t\t\t\t\t\tdiffuseSum += (sample1 + sample2) * w;\n\t\t\t\t\t\tweightSum += 2.0 * w;\n\t\t\t\t\t}\n                    // gl_FragColor = vec4( diffuseSum/weightSum, 1.0);\n\n                    vec3 result = diffuseSum/weightSum;\n                    result = mix( result, bayerMatrixDither( result ), 0.2 );\n\t\t\t\t\tgl_FragColor = vec4( result, 1.0 );\n\t\t\t\t}")})}},{key:"getCompositeMaterial",value:function(t){return new V.ShaderMaterial({defines:{NUM_MIPS:t},uniforms:{blurTexture1:{value:null},blurTexture2:{value:null},blurTexture3:{value:null},blurTexture4:{value:null},blurTexture5:{value:null},dirtTexture:{value:null},bloomStrength:{value:1},bloomFactors:{value:null},bloomTintColors:{value:null},bloomRadius:{value:0}},vertexShader:"\n            varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n                }\n            ",fragmentShader:"\n                varying vec2 vUv;\n\t\t\t\tuniform sampler2D blurTexture1;\n\t\t\t\tuniform sampler2D blurTexture2;\n\t\t\t\tuniform sampler2D blurTexture3;\n\t\t\t\tuniform sampler2D blurTexture4;\n\t\t\t\tuniform sampler2D blurTexture5;\n\t\t\t\tuniform sampler2D dirtTexture;\n\t\t\t\tuniform float bloomStrength;\n\t\t\t\tuniform float bloomRadius;\n\t\t\t\tuniform float bloomFactors[NUM_MIPS];\n\t\t\t\tuniform vec3 bloomTintColors[NUM_MIPS];\n\t\t\t\t\n\t\t\t\tfloat lerpBloomFactor(const in float factor) { \n\t\t\t\t\tfloat mirrorFactor = 1.2 - factor;\n\t\t\t\t\treturn mix(factor, mirrorFactor, bloomRadius);\n\t\t\t\t}\n\n                ".concat(f,"\n\t\t\t\t\n\t\t\t\tvoid main() {\n                    vec4 result = bloomStrength * ( lerpBloomFactor(bloomFactors[0]) * vec4(bloomTintColors[0], 1.0) * texture2D(blurTexture1, vUv) + \n\t\t\t\t\t\t\t\t\t\t\t\t\t lerpBloomFactor(bloomFactors[1]) * vec4(bloomTintColors[1], 1.0) * texture2D(blurTexture2, vUv) + \n\t\t\t\t\t\t\t\t\t\t\t\t\t lerpBloomFactor(bloomFactors[2]) * vec4(bloomTintColors[2], 1.0) * texture2D(blurTexture3, vUv) + \n\t\t\t\t\t\t\t\t\t\t\t\t\t lerpBloomFactor(bloomFactors[3]) * vec4(bloomTintColors[3], 1.0) * texture2D(blurTexture4, vUv) + \n\t\t\t\t\t\t\t\t\t\t\t\t\t lerpBloomFactor(bloomFactors[4]) * vec4(bloomTintColors[4], 1.0) * texture2D(blurTexture5, vUv) );\n\t\t\t\t\t// gl_FragColor = vec4( bayerMatrixDither( result.xyz ), 1.0 );\n\t\t\t\t\tgl_FragColor = result;\n                }\n            ")})}}])&&qt(e.prototype,n),a}(Ut);function Ht(t){return(Ht="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function Kt(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function Qt(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function $t(t,e){return($t=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function te(t,e){return!e||"object"!==Ht(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function ee(t){return(ee=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}var ne=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&$t(t,e)}(a,t);var e,n,r,o,i=(r=a,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=ee(r);if(o){var n=ee(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return te(this,t)});function a(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:8,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:16,o=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],s=arguments.length>4?arguments[4]:void 0;return Kt(this,a),s=s||new V.Vector2(window.innerWidth,window.innerHeight),(t=i.call(this,new V.ShaderMaterial({uniforms:{tDiffuse:{value:null},uResolution:{value:s},uSize:{value:e*window.devicePixelRatio},uQuality:{value:n},uDirection:{value:r}},vertexShader:p,fragmentShader:a.frag}))).dither=o,t}return e=a,(n=[{key:"setSize",value:function(t,e){this.material.uniforms.uResolution.value=new V.Vector2(t,e)}},{key:"dither",get:function(){return this._dither},set:function(t){var e="".concat(a.frag);t&&(e=e.replace("//dither//","color.xyz = bayerMatrixDither( color.xyz );")),this.material.fragmentShader=e,this.material.needsUpdate=!0,this._dither=t}},{key:"size",get:function(){return this.material.uniforms.uSize.value},set:function(t){this.material.uniforms.uSize.value=t*window.devicePixelRatio}},{key:"quality",get:function(){return this.material.uniforms.uQuality.value},set:function(t){this.material.uniforms.uQuality.value=t}},{key:"direction",get:function(){return this.material.uniforms.uDirection.value},set:function(t){this.material.uniforms.uDirection.value=t}}])&&Qt(e.prototype,n),a}(k);function re(t){return(re="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function oe(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function ie(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function ae(t,e){return(ae=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function se(t,e){return!e||"object"!==re(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function ue(t){return(ue=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}ne.frag="\n        \n    uniform sampler2D tDiffuse;\n    uniform vec2 uResolution;\n    uniform float uDirection;\n    uniform float uQuality;\n    uniform float uSize;\n    varying vec2 vUv;\n\n    ".concat(f,"\n\n    void main() {\n\n        vec2 uv = vUv;\n        vec4 color = texture2D( tDiffuse, uv );\n\n        // Gaussian Blur Shader\n        // by existical - https://www.shadertoy.com/view/Xltfzj\n        // edited by Pierre Keda\n\n        const float PI_2 = 6.28318530718; // Pi*2\n        float piStep = PI_2 / uDirection;\n        float qualityStep = 1.0 / uQuality;\n        vec2 radius = uSize / uResolution.xy;\n        \n        for( float d = 0.0; d < PI_2; d += piStep ) {\n\n            for( float i = qualityStep; i <= 1.0; i += qualityStep ) {\n\n                color += texture2D(\n                    tDiffuse, uv + vec2( cos( d ), sin( d ) ) * radius * i\n                );\n\n            }\n\n        }\n        \n        color /= uQuality * uDirection - 15.0;\n\n        //\n\n        //dither//\n        \n        gl_FragColor =  color;\n\n    }\n\n");var le=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&ae(t,e)}(a,t);var e,n,r,o,i=(r=a,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=ue(r);if(o){var n=ue(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return se(this,t)});function a(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.2,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:a.CENTER,r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],o=arguments.length>3?arguments[3]:void 0;oe(this,a),o=o||new V.Vector2(window.innerWidth,window.innerHeight);var s=(n=n||a.CENTER)===a.CENTER?a.CENTER:a.FIXED;return s!==a.CENTER&&n instanceof V.Vector2||(n=new V.Vector2(o.x/2,o.y/2)),(t=i.call(this,new V.ShaderMaterial({uniforms:{tDiffuse:{value:null},uOrigin:{value:n},uResolution:{value:o},uStrength:{value:e}},vertexShader:p,fragmentShader:a.frag}))).mode=s,t.dither=r,t}return e=a,(n=[{key:"setSize",value:function(t,e){this.material.uniforms.uResolution.value=new V.Vector2(t,e),this.mode===a.CENTER&&(this.material.uniforms.uOrigin.value=new V.Vector2(t/2,e/2))}},{key:"dither",get:function(){return this._dither},set:function(t){var e="".concat(a.frag);t&&(e=e.replace("//dither//","color.xyz = bayerMatrixDither( color.xyz );")),this.material.fragmentShader=e,this.material.needsUpdate=!0,this._dither=t}},{key:"strength",get:function(){return this.material.uniforms.uStrength.value},set:function(t){this.material.uniforms.uStrength.value=t}},{key:"x",get:function(){return this.material.uniforms.uOrigin.value.x},set:function(t){this.material.uniforms.uOrigin.value.x=t}},{key:"y",get:function(){return this.material.uniforms.uOrigin.value.y},set:function(t){this.material.uniforms.uOrigin.value.y=t}}])&&ie(e.prototype,n),a}(k);function ce(t){return(ce="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function he(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function pe(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function fe(t,e){return(fe=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function de(t,e){return!e||"object"!==ce(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function ve(t){return(ve=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}le.CENTER="center",le.FIXED="fixed",le.frag="\n        \n    uniform sampler2D tDiffuse;\n    uniform vec2 uOrigin;\n    uniform vec2 uResolution;\n    uniform float uStrength;\n    varying vec2 vUv;\n\n    ".concat(f,"\n\n    float random( vec3 scale, float seed ){ return fract(sin(dot(gl_FragCoord.xyz+seed,scale))*43758.5453+seed);}\n\n    void main() {\n\n        vec2 uv = vUv;\n\n        vec4 color = vec4( 0.0 );\n        float total = 0.0;\n        vec2 toCenter = uOrigin - vUv * uResolution;\n        float offset = random( vec3( 12.9898, 78.233, 151.7182 ), 0.0);\n        for( float t=0.0; t <= 40.0; t++ ){\n            float percent = ( t + offset ) / 40.0;\n            float weight = 4.0 * ( percent - percent * percent );\n            vec4 blurSample = texture2D(\n                tDiffuse, \n                vUv + toCenter * percent * uStrength / uResolution\n            );\n            blurSample.rgb *= blurSample.a;\n            color += blurSample * weight;\n            total += weight;\n        }\n        color /= total;\n\n        //dither//\n\n        gl_FragColor = color;\n\n        // gl_FragColor = color/total;\n        // gl_FragColor.rgb /= gl_FragColor.a + 0.00001;\n\n        // vec4 color = texture2D( tDiffuse, uv );\n        // gl_FragColor = color;\n\n    }\n\n");var me=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&fe(t,e)}(a,t);var e,n,r,o,i=(r=a,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=ve(r);if(o){var n=ve(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return de(this,t)});function a(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;he(this,a);var n=new V.ShaderMaterial({uniforms:{tDiffuse:{value:null},uDivisions:{value:{x:t,y:e}}},vertexShader:a.VERT,fragmentShader:a.FRAG});return i.call(this,n)}return e=a,(n=[{key:"divisionsX",get:function(){return this.material.uniforms.uDivisions.value.x},set:function(t){t<1&&(t=1),this.material.uniforms.uDivisions.value.x=t}},{key:"divisionsY",get:function(){return this.material.uniforms.uDivisions.value.y},set:function(t){t<1&&(t=1),this.material.uniforms.uDivisions.value.y=t}}])&&pe(e.prototype,n),a}(k);function ge(t,e){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return ye(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?ye(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var r=0,o=function(){};return{s:o,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){n=t[Symbol.iterator]()},n:function(){var t=n.next();return a=t.done,t},e:function(t){s=!0,i=t},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw i}}}}function ye(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function xe(t,e,n){var r,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1.2,i=new V.Box3,a=ge(n);try{for(a.s();!(r=a.n()).done;){var s=r.value;i.expandByObject(s)}}catch(t){a.e(t)}finally{a.f()}var u=i.getSize(new V.Vector3),l=i.getCenter(new V.Vector3),c=Math.max(u.x,u.y,u.z),h=c/(2*Math.atan(Math.PI*t.fov/360)),p=h/t.aspect,f=o*Math.max(h,p),d=e.target.clone().sub(t.position).normalize().multiplyScalar(f);e.maxDistance=10*f,e.target.copy(l),t.near=f/100,t.far=100*f,t.updateProjectionMatrix(),t.position.copy(e.target).sub(d),e.update()}function we(t){return(we="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function be(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function Te(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function Se(t,e){return(Se=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function De(t,e){return!e||"object"!==we(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function Pe(t){return(Pe=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}me.VERT="\n\nvarying vec2 vUv;\n\nvoid main() {\n\n    vUv = uv;\n\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n\n}\n\n",me.FRAG="\n\nuniform sampler2D tDiffuse;\nuniform vec2 uDivisions;\n\nvarying vec2 vUv;\n\nvoid main() {\n\n    vec2 uv = vUv;\n    vec2 target = uv;\n\n    float cellIndex, test;\n    float cellWidth = 1.0 / uDivisions.x;\n    \n    if ( uv.x > cellWidth ) {\n        cellIndex = ceil( uv.x * uDivisions.x );\n        test = mod( cellIndex, 2.0 );\n        if ( test == 0.0 ) target.x = cellIndex * cellWidth - uv.x;\n        else  target.x = uv.x - ( cellIndex - 1.0 ) * cellWidth;\n    }\n\n    float cellHeight = 1.0 / uDivisions.y;\n    \n    if ( uv.y > cellHeight ) {\n        cellIndex = ceil( uv.y * uDivisions.y );\n        test = mod( cellIndex, 2.0 );\n        if ( test == 0.0 ) target.y = cellIndex * cellHeight - uv.y;\n        else  target.y = uv.y - ( cellIndex - 1.0 ) * cellHeight;\n    }\n\n    vec4 color = texture2D( tDiffuse, target );\n\n    gl_FragColor = color;\n\n}\n\n";var Ce=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&Se(t,e)}(a,t);var e,n,r,o,i=(r=a,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=Pe(r);if(o){var n=Pe(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return De(this,t)});function a(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:16777215,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];be(this,a);var s={uAngle:{value:r},uColor1:{value:new V.Color(e)},uColor2:{value:new V.Color(n)}};return(t=i.call(this,new V.PlaneGeometry(2,2),new V.ShaderMaterial({vertexShader:p,uniforms:s,depthWrite:!1,depthTest:!1}))).dither=o,t}return e=a,(n=[{key:"angle",get:function(){return this.material.uniforms.uAngle.value},set:function(t){this.material.uniforms.uAngle.value=t}},{key:"dither",get:function(){return this._dither},set:function(t){var e="".concat(a.frag);t&&(e=e.replace("//dither//","color = bayerMatrixDither( color );")),this.material.fragmentShader=e,this.material.needsUpdate=!0,this._dither=t}},{key:"color1",get:function(){return"#"+this.material.uniforms.uColor1.value.getHexString()},set:function(t){this.material.uniforms.uColor1.value=new V.Color(t)}},{key:"color2",get:function(){return"#"+this.material.uniforms.uColor2.value.getHexString()},set:function(t){this.material.uniforms.uColor2.value=new V.Color(t)}}])&&Te(e.prototype,n),a}(V.Mesh);function _e(t){return(_e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function Oe(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function Ve(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function Me(t,e){return(Me=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function Ne(t,e){return!e||"object"!==_e(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function Re(t){return(Re=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}Ce.frag="\n\n    uniform float uAngle;\n    uniform vec3 uColor1;\n    uniform vec3 uColor2;\n\n    varying vec2 vUv;\n\n    ".concat(v,"\n    ").concat(f,"\n\n    void main() {\n\n        vec2 uv = vUv;\n        \n        vec2 origin = vec2( 0.5, 0.5 );\n        vec2 target = uv - origin;\n        vec3 color = linearGradient( \n            origin, target, uColor1, uColor2, uAngle\n        );\n        \n        //dither//\n\n        gl_FragColor = vec4( color, 1.0 );\n        \n    }\n\n");var ze=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&Me(t,e)}(a,t);var e,n,r,o,i=(r=a,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=Re(r);if(o){var n=Re(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return Ne(this,t)});function a(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new V.BoxGeometry,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new V.MeshBasicMaterial,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=r.x,s=void 0===o?2:o,u=r.y,l=void 0===u?1:u,c=r.z,h=void 0===c?1:c;return Oe(this,a),(t=i.call(this)).geometry=e,t.material=n,e.vertices.length>0&&t.compute(s,l,h),t}return e=a,(n=[{key:"compute",value:function(t,e,n){var r=this.geometry;r.computeBoundingBox(),r instanceof V.TextGeometry&&a.fixTextGeometry(r),this.csg=P.fromGeometry(this.geometry);var o=r.boundingBox.min.x,i=r.boundingBox.min.y,s=r.boundingBox.min.z,u=r.boundingBox.max.x-o,l=r.boundingBox.max.y-i,c=r.boundingBox.max.z-s;t<1&&(t=1),e<1&&(e=1),n<1&&(n=1);var h=u/t,p=l/e,f=c/n;o=(h-u)/2,i=(p-l)/2,s=(f-c)/2;for(var d=[],v=0;v<t;v++)for(var m=o+v*h,g=0;g<e;g++)for(var y=i+g*p,x=0;x<n;x++){var w=s+x*f;d.push({id:d.length,x:m,y,z:w,width:h,height:p,depth:f})}this.data=d,this.length=d.length,this._createSlices()}},{key:"_createSlices",value:function(){for(var t=this.data,e=[],n=0,r=t.length;n<r;n++){var o=t[n],i=new V.Mesh(new V.BoxGeometry(o.width,o.height,o.depth));i.position.set(o.x,o.y,o.z),i.updateMatrix();var a=P.fromMesh(i),s=this.csg.intersect(a),u=P.toMesh(s,this.matrix);u.material=this.material,e.push(u),this.add(u)}this.slices=e}}])&&Ve(e.prototype,n),a}(V.Group);function Ee(t){return t.charAt(0).toUpperCase()+t.slice(1)}function Le(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:640,e=navigator.userAgent||navigator.vendor||window.opera,n=/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|mediump|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4));return n||(n=window.innerWidth<t),n}function Ae(t,e){var n=document.createElement("a");n.download="".concat(e,".png"),n.href=t.toDataURL("image/png"),n.click(),n=null}ze.fixTextGeometry=function(t){var e=t.boundingBox.max.x/2,n=t.boundingBox.max.y/2,r=t.boundingBox.max.z/2;t.boundingBox.min.x=-e,t.boundingBox.max.x=e,t.boundingBox.min.y=-n,t.boundingBox.max.y=n,t.boundingBox.min.z=-r,t.boundingBox.max.z=r;for(var o=t.vertices,i=0,a=o.length;i<a;i++){var s=o[i];s.x-=e,s.y-=n,s.z-=r}};var Fe={MAX:9999,value:function(){return Math.random()},uint:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Fe.MAX;return Fe.int(0,t)},int:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Fe.MAX;return t+Math.floor(Math.random()*(e-t+1))},float:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Fe.MAX,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2;return parseFloat(Math.min(t+Math.random()*(e-t),e).toFixed(n))},item:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return Array.isArray(t)?Fe.itemFromArray(t,e):Fe.itemFromObject(t,e)},itemFromArray:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return e.length>0&&(t=t.filter((function(t){return!e.includes(t)}))),t[Math.floor(Math.random()*t.length)]},itemFromObject:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=Object.keys(t);return e.length>0&&(n=n.filter((function(t){return!e.includes(t)}))),t[Fe.item(n)]},color:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:255,n="#",r=0;r<3;r++)n+=Fe.int(t,e).toString(16).padStart(2,"0");return n}};const Ie=r},428:e=>{e.exports=t}},n={};function r(t){if(n[t])return n[t].exports;var o=n[t]={exports:{}};return e[t](o,o.exports,r),o.exports}return r.d=(t,e)=>{for(var n in e)r.o(e,n)&&!r.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},r.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r(78)})().default}));